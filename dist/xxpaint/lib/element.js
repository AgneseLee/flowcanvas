"use strict";function _typeof(t){return(_typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t})(t)}Object.defineProperty(exports,"__esModule",{value:!0}),exports.default=void 0;var _constants=_interopRequireDefault(require("./constants")),_px=_interopRequireDefault(require("./px")),_utils=require("./utils"),_line=_interopRequireDefault(require("./line")),_flexBox=_interopRequireDefault(require("./flex-box")),_treeNode=_interopRequireDefault(require("./tree-node")),_completeStyles2=_interopRequireDefault(require("./complete-styles"));function _interopRequireDefault(t){return t&&t.__esModule?t:{default:t}}function ownKeys(e,t){var i,n=Object.keys(e);return Object.getOwnPropertySymbols&&(i=Object.getOwnPropertySymbols(e),t&&(i=i.filter(function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable})),n.push.apply(n,i)),n}function _objectSpread(e){for(var t=1;t<arguments.length;t++){var i=null!=arguments[t]?arguments[t]:{};t%2?ownKeys(Object(i),!0).forEach(function(t){_defineProperty(e,t,i[t])}):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(i)):ownKeys(Object(i)).forEach(function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(i,t))})}return e}function _defineProperty(t,e,i){return e in t?Object.defineProperty(t,e,{value:i,enumerable:!0,configurable:!0,writable:!0}):t[e]=i,t}function _classCallCheck(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}function _defineProperties(t,e){for(var i=0;i<e.length;i++){var n=e[i];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(t,n.key,n)}}function _createClass(t,e,i){return e&&_defineProperties(t.prototype,e),i&&_defineProperties(t,i),t}function _get(t,e,i){return(_get="undefined"!=typeof Reflect&&Reflect.get?Reflect.get:function(t,e,i){t=_superPropBase(t,e);if(t){e=Object.getOwnPropertyDescriptor(t,e);return e.get?e.get.call(i):e.value}})(t,e,i||t)}function _superPropBase(t,e){for(;!Object.prototype.hasOwnProperty.call(t,e)&&null!==(t=_getPrototypeOf(t)););return t}function _inherits(t,e){if("function"!=typeof e&&null!==e)throw new TypeError("Super expression must either be null or a function");t.prototype=Object.create(e&&e.prototype,{constructor:{value:t,writable:!0,configurable:!0}}),e&&_setPrototypeOf(t,e)}function _setPrototypeOf(t,e){return(_setPrototypeOf=Object.setPrototypeOf||function(t,e){return t.__proto__=e,t})(t,e)}function _createSuper(i){var n=_isNativeReflectConstruct();return function(){var t,e=_getPrototypeOf(i);return _possibleConstructorReturn(this,n?(t=_getPrototypeOf(this).constructor,Reflect.construct(e,arguments,t)):e.apply(this,arguments))}}function _possibleConstructorReturn(t,e){return!e||"object"!==_typeof(e)&&"function"!=typeof e?_assertThisInitialized(t):e}function _assertThisInitialized(t){if(void 0===t)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return t}function _isNativeReflectConstruct(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Date.prototype.toString.call(Reflect.construct(Date,[],function(){})),!0}catch(t){return!1}}function _getPrototypeOf(t){return(_getPrototypeOf=Object.setPrototypeOf?Object.getPrototypeOf:function(t){return t.__proto__||Object.getPrototypeOf(t)})(t)}var Element=function(){_inherits(n,_treeNode["default"]);var i=_createSuper(n);function n(t,e){return _classCallCheck(this,n),(e=i.call(this,e)).options=_objectSpread({attrs:{},styles:{},on:{}},t),e.styles=null,e.renderStyles=null,e.x=0,e.y=0,e.render=null,e.container=null,e.visible=!0,e}return _createClass(n,[{key:"init",value:function(){this._initStyles()}},{key:"removeEvent",value:function(){this.getLayer().eventManager.removeElement(this)}},{key:"getLayer",value:function(){return this.root.layer}},{key:"getRender",value:function(){return this.root.layer.render}},{key:"_paint",value:function(){}},{key:"mount",value:function(t){t.mountNode(this)}},{key:"_initStyles",value:function(){this.styles=_objectSpread(_objectSpread(_objectSpread({},this._getDefaultStyles()),this._getParentStyles(this.options.styles)),this.options.styles||{}),this._completeStyles(),this._initRenderStyles()}},{key:"_initRenderStyles",value:function(){var t=_objectSpread({},this.styles),e=this._getContainerLayout().contentWidth,i=this._getContainerLayout().contentHeight;(0,_utils.isAuto)(t.width)?t.paddingWidth=0:(0,_utils.isOuter)(t.width)?t.paddingWidth=(0,_utils.parseOuter)(t.width)*e-t.marginLeft-t.marginRight:t.paddingWidth=t.width,(0,_utils.isAuto)(t.height)?t.paddingHeight=0:(0,_utils.isOuter)(t.height)?t.paddingHeight=(0,_utils.parseOuter)(t.height)*i-t.marginTop-t.marginBottom:t.paddingHeight=t.height,t.paddingWidth||(t.paddingWidth=0),t.paddingHeight||(t.paddingHeight=0),t.contentWidth=t.paddingWidth-t.paddingLeft-t.paddingRight,t.contentHeight=t.paddingHeight-t.paddingTop-t.paddingBottom,t.width=t.paddingWidth+t.marginLeft+t.marginRight+this._getTotalBorderWidth(t),t.height=t.paddingHeight+t.marginTop+t.marginBottom+this._getTotalBorderHeight(t),this.renderStyles=t,this._InFlexBox()?this._bindFlexBox():this.isInFlow()||(this.relativeTo=(0,_utils.findRelativeTo)(this))}},{key:"_getParentStyles",value:function(t){var e=this.parent&&this.parent.renderStyles||{},i=e.textAlign,n=e.fontSize,r=e.color,o=e.fontFamily,s=e.alignItems,l=e.visible,e=void 0===l||l,l={};return i&&(l.textAlign=i),n&&(l.fontSize=n),r&&(l.color=r),o&&(l.fontFamily=o),s&&!t.alignSelf&&(l.alignSelf=s),l.visible=e,l}},{key:"_completeStyles",value:function(){(0,_completeStyles2.default)(this)}},{key:"_getDefaultStyles",value:function(){return _constants.default.DEFAULT_STYLES}},{key:"_getChildrenInFlow",value:function(){return this._getChildren().filter(function(t){return t.isInFlow()})}},{key:"isInFlow",value:function(){var t=this.styles,e=t.position;t.display;return e!==_constants.default.POSITION.ABSOLUTE&&e!==_constants.default.POSITION.FIXED}},{key:"isVisible",value:function(){return this.renderStyles.visible&&this.visible}},{key:"_generateRender",value:function(){return this}},{key:"getCtx",value:function(){return this.root.layer.ctx}},{key:"_reflow",value:function(){}},{key:"_initWidthHeight",value:function(){var t=this.styles,e=t.width,i=t.height,n=t.display;t.flex,t.marginLeft,t.marginRight,t.marginTop,t.marginBottom;((0,_utils.isAuto)(e)||(0,_utils.isAuto)(i))&&(t=this._measureLayout(),(0,_utils.isAuto)(e)&&(this.renderStyles.contentWidth=(0,_utils.floor)(t.width)),(0,_utils.isAuto)(i)&&(this.renderStyles.contentHeight=(0,_utils.floor)(t.height))),this._refreshLayoutWithContent(),this._InFlexBox()?this.line.refreshWidthHeight(this):n===_constants.default.DISPLAY.INLINE_BLOCK&&this._bindLine()}},{key:"_initPosition",value:function(){var t,e,i,n,r,o,s,l,h=this._getContainerLayout().contentX,a=this.renderStyles,d=a.paddingLeft,u=a.paddingTop,y=a.borderLeftWidth,p=a.borderTopWidth,c=a.marginLeft,g=a.marginTop;this.isInFlow()?this._InFlexBox()||this.renderStyles.display===_constants.default.DISPLAY.INLINE_BLOCK?this.line.refreshElementPosition(this):(this.x=h,this.y=this._getPreLayout().y+this._getPreLayout().height):(t=(s=this._getContainerLayout(this.relativeTo)).contentX,e=s.contentY,i=s.contentWidth,n=s.contentHeight,r=(l=this.renderStyles).top,o=l.bottom,a=l.right,h=l.left,s=l.width,l=l.height,(0,_utils.isOuter)(r)&&(r=(0,_utils.parseOuter)(r)*n),(0,_utils.isOuter)(o)&&(o=(0,_utils.parseOuter)(o)*n),(0,_utils.isOuter)(h)&&(h=(0,_utils.parseOuter)(h)*i),(0,_utils.isOuter)(a)&&(a=(0,_utils.parseOuter)(a)*i),(0,_utils.isExact)(r)?this.y=e+r:(0,_utils.isExact)(o)&&(this.y=e+n-o-l),(0,_utils.isExact)(h)?this.x=t+h:(0,_utils.isExact)(a)&&(this.x=t+i-a-s)),this.x=(0,_utils.floor)(this.x),this.y=(0,_utils.floor)(this.y),this.contentX=this.x+d+y+c,this.contentY=this.y+u+p+g}},{key:"_InFlexBox",value:function(){return!!this.isInFlow()&&(!!this.parent&&(!(!this.parent||this.parent.renderStyles.display!==_constants.default.DISPLAY.FLEX)||void 0))}},{key:"_refreshLayoutWithContent",value:function(){this.renderStyles.height=(0,_utils.floor)(this.renderStyles.contentHeight+this.renderStyles.paddingTop+this.renderStyles.paddingBottom+this.renderStyles.marginTop+this.renderStyles.marginBottom+this._getTotalBorderHeight()),this.renderStyles.width=(0,_utils.floor)(this.renderStyles.contentWidth+this.renderStyles.paddingLeft+this.renderStyles.paddingRight+this.renderStyles.marginLeft+this.renderStyles.marginRight+this._getTotalBorderWidth()),this.renderStyles.paddingWidth=(0,_utils.floor)(this.renderStyles.contentWidth+this.renderStyles.paddingLeft+this.renderStyles.paddingRight),this.renderStyles.paddingHeight=(0,_utils.floor)(this.renderStyles.contentHeight+this.renderStyles.paddingTop+this.renderStyles.paddingBottom)}},{key:"_refreshContentWithLayout",value:function(){this.renderStyles.contentHeight=this.renderStyles.height-this.renderStyles.paddingTop-this.renderStyles.paddingBottom-this.renderStyles.marginTop-this.renderStyles.marginBottom-this._getTotalBorderHeight(),this.renderStyles.contentWidth=this.renderStyles.width-this.renderStyles.paddingLeft-this.renderStyles.paddingRight-this.renderStyles.marginLeft-this.renderStyles.marginRight-this._getTotalBorderWidth(),this.renderStyles.paddingWidth=(0,_utils.floor)(this.renderStyles.contentWidth+this.renderStyles.paddingLeft+this.renderStyles.paddingRight),this.renderStyles.paddingHeight=(0,_utils.floor)(this.renderStyles.contentHeight+this.renderStyles.paddingTop+this.renderStyles.paddingBottom)}},{key:"_getTotalBorderWidth",value:function(){var t=0<arguments.length&&void 0!==arguments[0]?arguments[0]:this.renderStyles;return t.borderLeftWidth+t.borderRightWidth}},{key:"_getTotalBorderHeight",value:function(){var t=0<arguments.length&&void 0!==arguments[0]?arguments[0]:this.renderStyles;return t.borderTopWidth+t.borderBottomWidth}},{key:"_bindLine",value:function(){this.pre&&this.pre.line&&this.pre.line.canIEnter(this)?this.pre.line.add(this):(new _line.default).bind(this)}},{key:"_bindFlexBox",value:function(){this.pre&&this.pre.line?this.pre.line.add(this):(new _flexBox.default).bind(this)}},{key:"_getContainerLayout",value:function(){var t=0<arguments.length&&void 0!==arguments[0]?arguments[0]:this.parent;return t||(this.container,t={renderStyles:{width:this.container.width,height:this.container.height,paddingTop:0,paddingBottom:0,paddingLeft:0,paddingRight:0,marginLeft:0,marginRight:0,marginTop:0,marginBottom:0,contentWidth:this.container.width,contentHeight:this.container.height},x:0,y:0,contentX:0,contentY:0}),{width:t.renderStyles.width,height:t.renderStyles.height,x:t.x,y:t.y,paddingTop:t.renderStyles.paddingTop,paddingBottom:t.renderStyles.paddingBottom,paddingLeft:t.renderStyles.paddingLeft,paddingRight:t.renderStyles.paddingRight,marginLeft:t.renderStyles.marginLeft,marginRight:t.renderStyles.marginRight,marginTop:t.renderStyles.marginTop,marginBottom:t.renderStyles.marginBottom,contentX:t.contentX,contentY:t.contentY,contentWidth:t.renderStyles.contentWidth,contentHeight:t.renderStyles.contentHeight}}},{key:"_getPreLayout",value:function(){for(var t=this.pre;t&&!t.isInFlow();)t=t.pre;return t?{width:t.renderStyles.width,height:t.renderStyles.height,x:t.x,y:t.y}:{width:0,height:0,x:this._getContainerLayout().contentX,y:this._getContainerLayout().contentY}}},{key:"_measureLayout",value:function(){var e=0,i=0;return this._getChildrenInFlow().forEach(function(t){t.line?t.line.start===t&&(t.line.width>e&&(e=t.line.width),i+=t.line.height):(t.renderStyles.width>e&&(e=t.renderStyles.width),i+=t.renderStyles.height)}),{width:e,height:i}}},{key:"getElementBy",value:function(e,i){var n=[];return(0,_utils.walk)(this,function(t){t.options.attrs[e]===i&&n.push(t)}),n}},{key:"appendChild",value:function(t){return _get(_getPrototypeOf(n.prototype),"appendChild",this).call(this,t),this.getLayer().onElementAdd(t),t}},{key:"prependChild",value:function(t){return _get(_getPrototypeOf(n.prototype),"prependChild",this).call(this,t),this.getLayer().onElementAdd(t),t}},{key:"removeChild",value:function(t){_get(_getPrototypeOf(n.prototype),"removeChild",this).call(this,t),this.getLayer().onElementRemove(t)}},{key:"append",value:function(t){_get(_getPrototypeOf(n.prototype),"append",this).call(this,t),this.getLayer().onElementAdd(t)}},{key:"prepend",value:function(t){_get(_getPrototypeOf(n.prototype),"prepend",this).call(this,t),this.getLayer().onElementAdd(t)}},{key:"setStyles",value:function(e){var i=this,n=!1;Object.keys(e).forEach(function(t){(0,_utils.needReflow)(t)?n=!0:i.renderStyles[t]=e[t]}),n?(Object.keys(e).forEach(function(t){i.options.styles[t]=e[t]}),this.getLayer().reflowElement(this,this)):this.getRender().requestRepaint()}}]),n}();exports.default=Element;