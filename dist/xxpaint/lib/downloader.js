"use strict";function _typeof(e){return(_typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}function _createForOfIteratorHelper(e,t){var n;if("undefined"==typeof Symbol||null==e[Symbol.iterator]){if(Array.isArray(e)||(n=_unsupportedIterableToArray(e))||t&&e&&"number"==typeof e.length){n&&(e=n);var r=0,t=function(){};return{s:t,n:function(){return r>=e.length?{done:!0}:{done:!1,value:e[r++]}},e:function(e){throw e},f:t}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var o,i=!0,a=!1;return{s:function(){n=e[Symbol.iterator]()},n:function(){var e=n.next();return i=e.done,e},e:function(e){a=!0,o=e},f:function(){try{i||null==n.return||n.return()}finally{if(a)throw o}}}}function _unsupportedIterableToArray(e,t){if(e){if("string"==typeof e)return _arrayLikeToArray(e,t);var n=Object.prototype.toString.call(e).slice(8,-1);return"Map"===(n="Object"===n&&e.constructor?e.constructor.name:n)||"Set"===n?Array.from(e):"Arguments"===n||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n)?_arrayLikeToArray(e,t):void 0}}function _arrayLikeToArray(e,t){(null==t||t>e.length)&&(t=e.length);for(var n=0,r=new Array(t);n<t;n++)r[n]=e[n];return r}function _classCallCheck(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function _defineProperties(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}function _createClass(e,t,n){return t&&_defineProperties(e.prototype,t),n&&_defineProperties(e,n),e}Object.defineProperty(exports,"__esModule",{value:!0}),exports.default=void 0;var util=require("./util"),SAVED_FILES_KEY="savedFiles",KEY_TOTAL_SIZE="totalSize",KEY_PATH="path",KEY_TIME="time",KEY_SIZE="size",MAX_SPACE_IN_B=6291456,savedFiles={},Dowloader=function(){function e(){_classCallCheck(this,e),wx.getStorage({key:SAVED_FILES_KEY,success:function(e){e.data&&(savedFiles=e.data)}})}return _createClass(e,[{key:"download",value:function(o){return new Promise(function(t,n){var r;o&&util.isValidUrl(o)?(r=getFile(o))?wx.getSavedFileInfo({filePath:r[KEY_PATH],success:function(e){t(r[KEY_PATH])},fail:function(e){console.error("the file is broken, redownload it, ".concat(JSON.stringify(e))),downloadFile(o).then(function(e){t(e)},function(){n()})}}):downloadFile(o).then(function(e){t(e)},function(){n()}):t(o)})}}]),e}();function downloadFile(i){return new Promise(function(r,o){wx.downloadFile({url:i,success:function(t){if(200!==t.statusCode)return console.error("downloadFile ".concat(i," failed res.statusCode is not 200")),void o();var n=t.tempFilePath;try{wx.getFileInfo({filePath:n,success:function(e){var t=e.size;doLru(t).then(function(){saveFile(i,t,n).then(function(e){r(e)})},function(){r(n)})},fail:function(e){console.error("getFileInfo ".concat(t.tempFilePath," failed, ").concat(JSON.stringify(e))),r(t.tempFilePath)}})}catch(e){r(n)}},fail:function(e){console.error("downloadFile failed, ".concat(JSON.stringify(e)," ")),o()}})})}function saveFile(r,o,t){return new Promise(function(n,e){wx.saveFile({tempFilePath:t,success:function(e){var t=savedFiles[KEY_TOTAL_SIZE]||0;savedFiles[r]={},savedFiles[r][KEY_PATH]=e.savedFilePath,savedFiles[r][KEY_TIME]=(new Date).getTime(),savedFiles[r][KEY_SIZE]=o,savedFiles.totalSize=o+t,wx.setStorage({key:SAVED_FILES_KEY,data:savedFiles}),n(e.savedFilePath)},fail:function(e){console.error("saveFile ".concat(r," failed, then we delete all files, ").concat(JSON.stringify(e))),n(t),reset()}})})}function reset(){wx.removeStorage({key:SAVED_FILES_KEY,success:function(){wx.getSavedFileList({success:function(e){removeFiles(e.fileList)},fail:function(e){console.error("getSavedFileList failed, ".concat(JSON.stringify(e)))}})}})}function doLru(l){return new Promise(function(e,t){var n=savedFiles[KEY_TOTAL_SIZE]||0;if(l+n<=MAX_SPACE_IN_B)e();else{var r=[],o=JSON.parse(JSON.stringify(savedFiles));delete o[KEY_TOTAL_SIZE];var i=_createForOfIteratorHelper(Object.keys(o).sort(function(e,t){return o[e][KEY_TIME]-o[t][KEY_TIME]}));try{for(i.s();!(a=i.n()).done;){var a=a.value;if(n-=savedFiles[a].size,r.push(savedFiles[a][KEY_PATH]),delete savedFiles[a],n+l<MAX_SPACE_IN_B)break}}catch(e){i.e(e)}finally{i.f()}savedFiles.totalSize=n,wx.setStorage({key:SAVED_FILES_KEY,data:savedFiles,success:function(){0<r.length&&removeFiles(r),e()},fail:function(e){console.error("doLru setStorage failed, ".concat(JSON.stringify(e))),t()}})}})}function removeFiles(e){var n,t=_createForOfIteratorHelper(e);try{for(t.s();!(n=t.n()).done;)!function(){var t=n.value,e=t;"object"===_typeof(t)&&(e=t.filePath),wx.removeSavedFile({filePath:e,fail:function(e){console.error("removeSavedFile ".concat(t," failed, ").concat(JSON.stringify(e)))}})}()}catch(e){t.e(e)}finally{t.f()}}function getFile(e){if(savedFiles[e])return savedFiles[e].time=(new Date).getTime(),wx.setStorage({key:SAVED_FILES_KEY,data:savedFiles}),savedFiles[e]}exports.default=Dowloader;