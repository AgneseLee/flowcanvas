"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.default=void 0;var _util=require("./util"),_vnode=require("./vnode"),_line=require("./line"),_layout=require("./layout"),_html=require("./html"),_image=require("./image");function ownKeys(e,t){var r,i=Object.keys(e);return Object.getOwnPropertySymbols&&(r=Object.getOwnPropertySymbols(e),t&&(r=r.filter(function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable})),i.push.apply(i,r)),i}function _objectSpread(e){for(var t=1;t<arguments.length;t++){var r=null!=arguments[t]?arguments[t]:{};t%2?ownKeys(Object(r),!0).forEach(function(t){_defineProperty(e,t,r[t])}):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(r)):ownKeys(Object(r)).forEach(function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(r,t))})}return e}function _defineProperty(t,e,r){return e in t?Object.defineProperty(t,e,{value:r,enumerable:!0,configurable:!0,writable:!0}):t[e]=r,t}function _createForOfIteratorHelper(t,e){var r;if("undefined"==typeof Symbol||null==t[Symbol.iterator]){if(Array.isArray(t)||(r=_unsupportedIterableToArray(t))||e&&t&&"number"==typeof t.length){r&&(t=r);var i=0,e=function(){};return{s:e,n:function(){return i>=t.length?{done:!0}:{done:!1,value:t[i++]}},e:function(t){throw t},f:e}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var s,a=!0,n=!1;return{s:function(){r=t[Symbol.iterator]()},n:function(){var t=r.next();return a=t.done,t},e:function(t){n=!0,s=t},f:function(){try{a||null==r.return||r.return()}finally{if(n)throw s}}}}function _unsupportedIterableToArray(t,e){if(t){if("string"==typeof t)return _arrayLikeToArray(t,e);var r=Object.prototype.toString.call(t).slice(8,-1);return"Map"===(r="Object"===r&&t.constructor?t.constructor.name:r)||"Set"===r?Array.from(t):"Arguments"===r||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(r)?_arrayLikeToArray(t,e):void 0}}function _arrayLikeToArray(t,e){(null==e||e>t.length)&&(e=t.length);for(var r=0,i=new Array(e);r<e;r++)i[r]=t[r];return i}function asyncGeneratorStep(t,e,r,i,s,a,n){try{var o=t[a](n),c=o.value}catch(t){return void r(t)}o.done?e(c):Promise.resolve(c).then(i,s)}function _asyncToGenerator(o){return function(){var t=this,n=arguments;return new Promise(function(e,r){var i=o.apply(t,n);function s(t){asyncGeneratorStep(i,e,r,s,a,"next",t)}function a(t){asyncGeneratorStep(i,e,r,s,a,"throw",t)}s(void 0)})}}function _classCallCheck(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}function _defineProperties(t,e){for(var r=0;r<e.length;r++){var i=e[r];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(t,i.key,i)}}function _createClass(t,e,r){return e&&_defineProperties(t.prototype,e),r&&_defineProperties(t,r),t}var GD=require("./gradient.js"),defaultPaddingMargin={paddingTop:0,paddingBottom:0,paddingLeft:0,paddingRight:0,marginLeft:0,marginRight:0,marginTop:0,marginBottom:0},Painter=function(){function r(t,e){_classCallCheck(this,r),this.ctx=t,this.data=e,this.globalWidth={},this.globalHeight={}}var e,t,i,s;return _createClass(r,[{key:"beforePaint",value:(s=_asyncToGenerator(regeneratorRuntime.mark(function t(){return regeneratorRuntime.wrap(function(t){for(;;)switch(t.prev=t.next){case 0:return t.next=2,this.transformNTo1();case 2:return console.log("eeeeeeeeee ",this.data),t.abrupt("return",this.data);case 4:case"end":return t.stop()}},t,this)})),function(){return s.apply(this,arguments)})},{key:"paint",value:(i=_asyncToGenerator(regeneratorRuntime.mark(function t(e){var r,i;return regeneratorRuntime.wrap(function(t){for(;;)switch(t.prev=t.next){case 0:this.style={width:this.data.children[0].css.width.toPx(),height:this.data.children[0].css.height.toPx()},r=_createForOfIteratorHelper(this.data.views),t.prev=2,r.s();case 4:if((i=r.n()).done){t.next=10;break}return i=i.value,t.next=8,this._drawAbsolute(i);case 8:t.next=4;break;case 10:t.next=15;break;case 12:t.prev=12,t.t0=t.catch(2),r.e(t.t0);case 15:return t.prev=15,r.f(),t.finish(15);case 18:this.data.caniuse?e():this.ctx.draw(!1,function(){e()});case 19:case"end":return t.stop()}},t,this,[[2,12,15,18]])})),function(t){return i.apply(this,arguments)})},{key:"transformNTo1",value:(t=_asyncToGenerator(regeneratorRuntime.mark(function t(){var e,r;return regeneratorRuntime.wrap(function(t){for(;;)switch(t.prev=t.next){case 0:return r=(0,_vnode.xmlToVnode)(_html.wxml,_html.style),console.log("** ",r),this.data.children[0]=r,e=this.data,console.log("--- ",e),t.next=7,(0,_image.downloadImages)(e);case 7:this.calcElementWidthHeight(e.children[0]),r=this.calcElementPosition(e.children[0]),this.data.views=r;case 10:case"end":return t.stop()}},t,this)})),function(){return t.apply(this,arguments)})},{key:"calcElementWidthHeight",value:function(t){for(var e=(0,_util.breadthFirstSearchRight)(t),r=0;r<e.length;r++)if(this.preProcessObj(e[r]),["view","rect"].includes(e[r].type)){for(var i=e[r].processedLocation,s=i.width,a=(i.height,0),n=0,o=e[r].children||[],c=0;c<o.length;c++){var h=o[c].processedLocation.width,l=o[c].processedLocation.height,h=h+(o[c].css.paddingLeft?o[c].css.paddingLeft.toPx():0)+(o[c].css.marginLeft?o[c].css.marginLeft.toPx():0),l=l+(o[c].css.marginTop?o[c].css.marginTop.toPx():0)+(o[c].css.paddingTop?o[c].css.paddingTop.toPx():0);"block"===o[c].type?(n+=l,a=0):s<=(a+=h)&&0===c||s<a?n+=l:a<s&&0===c&&(n+=l)}e[r].processedLocation.height=Math.max(n,e[r].processedLocation.height),console.log(e[r].processedLocation.height)}else if("block"===e[r].type){var i=e[r].processedLocation,d=i.width;if(!!i.height)for(var u=0,f=0,g=!1,x=e[r].children||[],p=0;p<x.length;p++){var y=x[p].processedLocation.width,m=x[p].processedLocation.height,v=x[p].css.paddingLeft?x[p].css.paddingLeft.toPx():0,b=x[p].css.marginLeft?x[p].css.marginLeft.toPx():0,m=m+(x[p].css.marginTop?x[p].css.marginTop.toPx():0)+(x[p].css.paddingTop?x[p].css.paddingTop.toPx():0);g?(f+=m,g=!1,u=0):d<=(u+=y+v+b)&&0===p||d<u?(g=!0,f+=m):u<d&&0===p&&(g=!1,f+=m),e[r].processedLocation.height=Math.max(f,e[r].processedLocation.height)}}return console.log("(((((( ",e),e}},{key:"calcElementPosition",value:function(t){for(var e=(0,_util.breadthFirstSearch)(t),r=0;r<e.length;r++){var i=e[r].parent,s=_objectSpread(_objectSpread({},defaultPaddingMargin),e[r].css),a=s.paddingLeft,n=s.marginLeft,o=s.paddingTop,s=s.marginTop;i?(i=(0,_layout.getIsChangeLine)(e[r]),this.insertVnode(e[r],i)):e[r].renderStyle={x:0,y:0,contentX:(0,_util.formatToNum)(a,e[r].parent,"width")+(0,_util.formatToNum)(n,e[r].parent,"width"),contentY:(0,_util.formatToNum)(o,e[r].parent,"height")+(0,_util.formatToNum)(s,e[r].parent,"height")}}return e}},{key:"insertVnode",value:function(t,e){var r,i,s,a,n,o;["block"].includes(t.type)?(r=(n=_objectSpread(_objectSpread({},defaultPaddingMargin),t.css)).paddingLeft,i=n.marginLeft,s=n.paddingTop,o=n.marginTop,o={x:a=t.parent.renderStyle.contentX,y:n=(0,_layout.getPreLayout)(t).y+(0,_layout.getPreLayout)(t).height,contentX:a+(0,_util.formatToNum)(r,t.parent,"width")+(0,_util.formatToNum)(i,t.parent,"width"),contentY:n+(0,_util.formatToNum)(s,t.parent,"height")+(0,_util.formatToNum)(o,t.parent,"height")},t.renderStyle=o):(0,_line.insertVnodeIntoLine)(t,e)}},{key:"routeByDFS",value:function(){var t={children:this.data.views};if(!t)return null;var r=1;t.sid=r,r++;for(var i=[],e=t.children.length;0<e;e--)t.children[e-1].sid=r,t.children[e-1].f_sid=1,r++,i.push(t.children[e-1]);for(;i.length;)!function(){var e=i.pop();e.children&&0<e.children.length&&(e.children.forEach(function(t){t.sid=r,t.f_sid=e.sid,r++}),i=Array.from(e.children).concat(i))}()}},{key:"routeByBFS",value:function(){var t={children:this.data.views},e=[];if(null!==t){var r=[];for(r.unshift(t);r.length;){var i=r.shift(),i=this.preProcessObj(i);e.push(i);var s=i.children;if(s)for(var a=0;a<s.length;a++)r.push(s[a])}}}},{key:"preProcessObj",value:function(t){var e;switch(t.type){case"image":e=this._preProcess(t);break;case"text":e=this._preProcess(t,t.css.background&&t.css.borderRadius);break;case"rect":case"block":e=this._preProcess(t)}return t.processedLocation=e,t}},{key:"_background",value:function(){this.ctx.save();var t=this.style,e=t.width,r=t.height,t=this.data.background;this.ctx.translate(e/2,r/2),this._doClip(this.data.borderRadius,e,r),t?t.startsWith("#")||t.startsWith("rgba")||"transparent"===t.toLowerCase()?(this.ctx.fillStyle=t,this.ctx.fillRect(-e/2,-r/2,e,r)):GD.api.isGradient(t)?(GD.api.doGradient(t,e,r,this.ctx),this.ctx.fillRect(-e/2,-r/2,e,r)):this._drawImage(t,-e/2,-r/2,e,r):(this.ctx.fillStyle="#fff",this.ctx.fillRect(-e/2,-r/2,e,r)),this.ctx.restore()}},{key:"_drawAbsolute",value:(e=_asyncToGenerator(regeneratorRuntime.mark(function t(e){return regeneratorRuntime.wrap(function(t){for(;;)switch(t.prev=t.next){case 0:if(e){t.next=2;break}return t.abrupt("return");case 2:t.t0=e.type,t.next="image"===t.t0?5:"text"===t.t0?8:"rect"===t.t0?10:"block"===t.t0?12:14;break;case 5:return t.next=7,this._drawAbsImage(e);case 7:return t.abrupt("break",15);case 8:return this._fillAbsText(e),t.abrupt("break",15);case 10:case 12:return this._drawAbsRect(e),t.abrupt("break",15);case 14:return t.abrupt("break",15);case 15:case"end":return t.stop()}},t,this)})),function(t){return e.apply(this,arguments)})},{key:"_doClip",value:function(t,e,r){var i=3<arguments.length&&void 0!==arguments[3]&&arguments[3];t&&e&&r&&(t=Math.min(t.toPx(),e/2,r/2),this.ctx.globalAlpha=0,this.ctx.fillStyle="white",this.ctx.beginPath(),this.ctx.arc(-e/2+t,-r/2+t,t,+Math.PI,1.5*Math.PI),this.ctx.lineTo(e/2-t,-r/2),this.ctx.arc(e/2-t,-r/2+t,t,1.5*Math.PI,2*Math.PI),i?(this.ctx.lineTo(e/2,r/2),this.ctx.lineTo(-e/2,r/2)):(this.ctx.lineTo(e/2,r/2-t),this.ctx.arc(e/2-t,r/2-t,t,0,.5*Math.PI),this.ctx.lineTo(-e/2+t,r/2),this.ctx.arc(-e/2+t,r/2-t,t,.5*Math.PI,+Math.PI)),this.ctx.closePath(),this.ctx.fill(),t=(r=wx.getSystemInfoSync()).version,r=r.platform,t<="6.6.6"&&"ios"===r||this.ctx.clip(),this.ctx.globalAlpha=1)}},{key:"_doBorder",value:function(t,e,r){var i,s,a,n,o,c,h;t.css&&(c=(o=t.css).borderRadius,h=o.borderWidth,i=o.borderColor,h&&(this.ctx.save(),s=(n=t.processedLocation).height,a=n.width,n=(o=t.renderStyle).x,o=o.y,this._prePaint(t,!0,{x:n,y:o,height:s,width:a}),c=c?Math.min(c.toPx(),e/2,r/2):0,h=h.toPx(),this.ctx.lineWidth=h,this.ctx.strokeStyle=i||"black",this.ctx.beginPath(),this.ctx.arc(-e/2+c,-r/2+c,c+h/2,+Math.PI,1.5*Math.PI),this.ctx.lineTo(e/2-c,-r/2-h/2),this.ctx.arc(e/2-c,-r/2+c,c+h/2,1.5*Math.PI,2*Math.PI),this.ctx.lineTo(e/2+h/2,r/2-c),this.ctx.arc(e/2-c,r/2-c,c+h/2,0,.5*Math.PI),this.ctx.lineTo(-e/2+c,r/2+h/2),this.ctx.arc(-e/2+c,r/2-c,c+h/2,.5*Math.PI,+Math.PI),this.ctx.closePath(),this.ctx.stroke(),this.ctx.restore()))}},{key:"_preProcess",value:function(t,e){var r=0;switch(t.type){case"text":for(var i=t.text.split("\n"),s=0;s<i.length;++s)""===i[s]&&(i[s]=" ");var a="bold"===t.css.fontWeight?"bold":"normal";t.css.fontSize=t.css.fontSize||"20rpx",this.ctx.font="normal ".concat(a," ").concat(t.css.fontSize.toPx(),"px ").concat(t.css.fontFamily?'"'.concat(t.css.fontFamily,'"'):"sans-serif");for(var n=0,o=[],c=0;c<i.length;++c){var h=this.ctx.measureText(i[c]).width,l=t.css.width?(0,_util.formatToNum)(t.css.width,t.parent,"width"):h,h=Math.ceil(h/l),r=r<l?l:r;n+=h,o[c]=h}var n=t.css.maxLines<n?t.css.maxLines:n,a=(t.css.lineHeight||t.css.fontSize).toPx(),d=a*n,u={lines:n,lineHeight:a,textArray:i,linesArray:o};if(t.id){for(var f=0,g=0;g<i.length;++g)f=this.ctx.measureText(i[g]).width>f?this.ctx.measureText(i[g]).width:f;r=!r||f<r?f:r}break;case"image":a=wx.getSystemInfoSync().pixelRatio||2;t.css&&(t.css.width||(t.css.width="auto"),t.css.height||(t.css.height="auto")),!t.css||"auto"===t.css.width&&"auto"===t.css.height?(r=Math.round(t.sWidth/a),d=Math.round(t.sHeight/a)):"auto"===t.css.width?(d=t.css.height.toPx(),r=t.sWidth/t.sHeight*d):d="auto"===t.css.height?(r=t.css.width.toPx(),t.sHeight/t.sWidth*r):(r=t.css.width.toPx(),t.css.height.toPx());break;default:if(!t.css.width||!t.css.height)return void console.error("You should set width and height");r=(0,_util.formatToNum)(t.css.width,t.parent,"width"),d=(0,_util.formatToNum)(t.css.height,t.parent,"height")}return t.id&&(this.globalWidth[t.id]=r,this.globalHeight[t.id]=d),{width:r,height:d,extra:u}}},{key:"_prePaint",value:function(t,e,r){var i=r.x,s=r.y,a=r.height,n=r.width;switch(t.css&&t.css.align?t.css.align:t.css&&t.css.right?"right":"left"){case"center":this.ctx.translate(i,s+a/2);break;case"right":this.ctx.translate(i-n/2,s+a/2);break;default:this.ctx.translate(i+n/2,s+a/2)}r=t.css&&t.css.rotate?this._getAngle(t.css.rotate):0;this.ctx.rotate(r),!e&&t.css&&t.css.borderRadius&&"rect"!==t.type&&this._doClip(t.css.borderRadius,n,a,!!t.css.isOnlyUpHalf),this._doShadow(t)}},{key:"_doBackground",value:function(t){this.ctx.save();var e=t.processedLocation,r=e.height,i=e.width,s=t.renderStyle,a=s.contentX,e=s.contentY;this._prePaint(t,!0,{x:a,y:e,width:i,height:r});var n,o,s=t.css,a=s.background,e=s.padding,s=[0,0,0,0];e&&(1===(e=e.split(/\s+/)).length&&(s=[n=e[0].toPx(),n,n,n]),2===e.length&&(s=[n=e[0].toPx(),o=e[1].toPx(),n,o]),3===e.length&&(s=[e[0].toPx(),o=e[1].toPx(),e[2].toPx(),o]),4===e.length&&(s=[e[0].toPx(),e[1].toPx(),e[2].toPx(),e[3].toPx()]));i=i+s[1]+s[3],s=r+s[0]+s[2];this._doClip(t.css.borderRadius,i,s),GD.api.isGradient(a)?GD.api.doGradient(a,i,s,this.ctx):this.ctx.fillStyle=a,this.ctx.fillRect(-i/2,-s/2,i,s),this.ctx.restore()}},{key:"_drawImage",value:function(t){for(var e=this,r=arguments.length,i=new Array(1<r?r-1:0),s=1;s<r;s++)i[s-1]=arguments[s];var a=this.data._canvas.createImage();a.src=t,a.onload=function(){e.ctx.drawImage.apply(null,[a].concat(i))}}},{key:"_drawAbsImage",value:function(u){var f=this;return new Promise(function(t,e){if(u.url)try{f.ctx.save();var r=u.processedLocation,i=r.height,s=r.width,a=u.renderStyle,r=a.contentX,a=a.contentY;f._prePaint(u,!1,{x:r,y:a,height:i,width:s});var n,o,c=u.sWidth,h=u.sHeight,l=0,d=0,a=s/i;u.sWidth/u.sHeight<=a?(h=c/a,d=Math.round((u.sHeight-h)/2)):(c=h*a,l=Math.round((u.sWidth-c)/2)),u.css&&u.css.alpha&&f.ctx.setGlobalAlpha(u.css.alpha),u.css&&"scaleToFill"===u.css.mode?f.data.caniuse?((n=f.data._canvas.createImage()).src=u.url,n.onload=function(){f.ctx.drawImage(n,l,d,c,h,-s/2,-i/2,s,i),f.ctx.restore(),f._doBorder(u,s,i),t(!0)}):(f._drawImage(u.url,-s/2,-i/2,s,i),f.ctx.restore(),f._doBorder(u,s,i),t(!0)):f.data.caniuse?((o=f.data._canvas.createImage()).src=u.url,o.onload=function(){f.ctx.drawImage(o,l,d,c,h,-s/2,-i/2,s,i),f.ctx.restore(),f._doBorder(u,s,i),t(!0)}):(f.ctx.drawImage(u.url,l,d,c,h,-s/2,-i/2,s,i),f.ctx.restore(),f._doBorder(u,s,i),t(!0))}catch(t){e(t)}})}},{key:"_fillAbsText",value:function(t){if(t.text){t.css.background&&this._doBackground(t),this.ctx.save();var e="bold"===t.css.fontWeight?"bold":"normal";t.css.fontSize=t.css.fontSize||"20rpx",this.ctx.font="normal ".concat(e," ").concat(t.css.fontSize.toPx(),"px ").concat(t.css.fontFamily?'"'.concat(t.css.fontFamily,'"'):"sans-serif");var r=t.processedLocation,i=r.height,s=r.width,a=r.extra,e=t.renderStyle,r=e.contentX,e=e.contentY;this._prePaint(t,t.css.background&&t.css.borderRadius,{x:r,y:e,height:i,width:s}),this.ctx.fillStyle=t.css.color||"black";for(var n=a.lines,o=a.lineHeight,c=a.textArray,h=a.linesArray,l=0,d=0;d<c.length;++d)for(var u=Math.round(c[d].length/h[d]),f=0,g=0,x=0;x<h[d]&&!(n<=l);++x){for(var g=u,p=c[d].substr(f,g),y=this.ctx.measureText(p).width;f+g<=c[d].length&&(s-y>t.css.fontSize.toPx()||s<y);){if(y<s)p=c[d].substr(f,++g);else{if(p.length<=1)break;p=c[d].substr(f,--g)}y=this.ctx.measureText(p).width}if(f+=p.length,l===n-1&&(d<c.length-1||f<c[d].length)){for(;this.ctx.measureText("".concat(p,"...")).width>s&&!(p.length<=1);)p=p.substring(0,p.length-1);p+="...",y=this.ctx.measureText(p).width}this.data.caniuse?this.ctx.textAlign=t.css.textAlign||"left":this.ctx.setTextAlign(t.css.textAlign||"left");var m=void 0;switch(t.css.textAlign){case"center":m=0;break;case"right":m=s/2;break;default:m=-s/2}var v=-i/2+(0===l?t.css.fontSize.toPx():t.css.fontSize.toPx()+l*o);l++,"stroke"===t.css.textStyle?this.ctx.strokeText(p,m,v,y):this.ctx.fillText(p,m,v,y);var b=t.css.fontSize.toPx();t.css.textDecoration&&(this.ctx.beginPath(),/\bunderline\b/.test(t.css.textDecoration)&&(this.ctx.moveTo(m,v),this.ctx.lineTo(m+y,v)),/\boverline\b/.test(t.css.textDecoration)&&(this.ctx.moveTo(m,v-b),this.ctx.lineTo(m+y,v-b)),/\bline-through\b/.test(t.css.textDecoration)&&(this.ctx.moveTo(m,v-b/3),this.ctx.lineTo(m+y,v-b/3)),this.ctx.closePath(),this.ctx.strokeStyle=t.css.color,this.ctx.stroke())}this.ctx.restore(),this._doBorder(t,s,i)}}},{key:"_drawAbsRect",value:function(t){this.ctx.save();var e=t.processedLocation,r=e.height,i=e.width,s=t.renderStyle,e=s.contentX,s=s.contentY;this._prePaint(t,!1,{x:e,y:s,height:r,width:i}),GD.api.isGradient(t.css.color)?GD.api.doGradient(t.css.color,i,r,this.ctx):this.ctx.fillStyle=t.css.color;s=t.css.borderRadius,s=s?Math.min(s.toPx(),i/2,r/2):0;this.ctx.beginPath(),this.ctx.arc(-i/2+s,-r/2+s,s,+Math.PI,1.5*Math.PI),this.ctx.lineTo(i/2-s,-r/2),this.ctx.arc(i/2-s,-r/2+s,s,1.5*Math.PI,2*Math.PI),this.ctx.lineTo(i/2,r/2-s),this.ctx.arc(i/2-s,r/2-s,s,0,.5*Math.PI),this.ctx.lineTo(-i/2+s,r/2),this.ctx.arc(-i/2+s,r/2-s,s,.5*Math.PI,+Math.PI),this.ctx.closePath(),this.ctx.fill(),this.ctx.restore(),this._doBorder(t,i,r)}},{key:"_doShadow",value:function(t){t.css&&t.css.shadow&&(4<(t=t.css.shadow.replace(/,\s+/g,",").split(" ")).length?console.error("shadow don't spread option"):(this.ctx.shadowOffsetX=parseInt(t[0],10),this.ctx.shadowOffsetY=parseInt(t[1],10),this.ctx.shadowBlur=parseInt(t[2],10),this.ctx.shadowColor=t[3]))}},{key:"_getAngle",value:function(t){return Number(t)*Math.PI/180}}]),r}();exports.default=Painter;