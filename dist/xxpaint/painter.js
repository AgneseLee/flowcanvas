"use strict";var _pen=_interopRequireDefault(require("./lib/pen")),_image=require("./lib/image"),_util=require("./lib/util"),_tree=require("./lib/tree");function _interopRequireDefault(e){return e&&e.__esModule?e:{default:e}}function ownKeys(t,e){var r,n=Object.keys(t);return Object.getOwnPropertySymbols&&(r=Object.getOwnPropertySymbols(t),e&&(r=r.filter(function(e){return Object.getOwnPropertyDescriptor(t,e).enumerable})),n.push.apply(n,r)),n}function _objectSpread(t){for(var e=1;e<arguments.length;e++){var r=null!=arguments[e]?arguments[e]:{};e%2?ownKeys(Object(r),!0).forEach(function(e){_defineProperty(t,e,r[e])}):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(r)):ownKeys(Object(r)).forEach(function(e){Object.defineProperty(t,e,Object.getOwnPropertyDescriptor(r,e))})}return t}function _defineProperty(e,t,r){return t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}function asyncGeneratorStep(e,t,r,n,a,i,o){try{var c=e[i](o),s=c.value}catch(e){return void r(e)}c.done?t(s):Promise.resolve(s).then(n,a)}function _asyncToGenerator(c){return function(){var e=this,o=arguments;return new Promise(function(t,r){var n=c.apply(e,o);function a(e){asyncGeneratorStep(n,t,r,a,i,"next",e)}function i(e){asyncGeneratorStep(n,t,r,a,i,"throw",e)}a(void 0)})}}require("./lib/html");var util=require("./lib/util"),MAX_PAINT_COUNT=5;function setStringPrototype(n,a){String.prototype.toPx=function(e){var t=e?/^-?[0-9]+([.]{1}[0-9]+){0,1}(rpx|px)$/g:/^[0-9]+([.]{1}[0-9]+){0,1}(rpx|px)$/g,r=t.exec(this);if(!this||!r)return console.error("The size: ".concat(this," is illegal")),0;e=r[2],t=parseFloat(this),r=0;return"rpx"===e?r=Math.round(t*n*(a||1)):"px"===e&&(r=Math.round(t*(a||1))),r}}Component({canvasStyleWidthInPx:0,canvasStyleHeightInPx:0,paintCount:0,properties:{palette:{type:Object,observer:function(e,t){this.isNeedRefresh(e,t)&&(this.paintCount=0,console.time(),this.startPaint())}},widthPixels:{type:Number,value:0},dirty:{type:Boolean,value:!1},setImgScreenWidth:{type:String,value:""},painterBodyStyle:{type:String,value:""}},data:{picURL:"",showCanvas:!0,painterStyle:"",outputPic:"",caniuse:!1,realAllH:0,realWhiteH:0,canvasNode:{},canvasCtx:{},pen:{},calcTpl:{}},lifetimes:{attached:function(){var e=(0,_util.canUseNewCanvas)();this.setData({caniuse:e})}},methods:{isEmpty:function(e){for(var t in e)return!1;return!0},isNeedRefresh:function(e,t){return!(!e||this.isEmpty(e)||this.data.dirty&&util.equal(e,t))},startPaint:function(){var c=this;return _asyncToGenerator(regeneratorRuntime.mark(function e(){var t,r,n,a,i,o;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:if(c.isEmpty(c.properties.palette))return e.abrupt("return");e.next=2;break;case 2:e.prev=2,wx.getSystemInfoSync(),e.next=12;break;case 6:return e.prev=6,e.t0=e.catch(2),r="Painter get system info failed, ".concat(JSON.stringify(e.t0)),c.triggerEvent("imgErr",{error:r}),console.error(r),e.abrupt("return");case 12:if(setStringPrototype(t=wx.getSystemInfoSync().screenWidth/750,1),n=c.properties.palette.children[0].css,r=n.width,n=n.height,r&&n){e.next=18;break}return console.error("You should set width and height correctly for painter, width: ".concat(r,", height: ").concat(n)),e.abrupt("return");case 18:return e.next=20,c.getCalcTpl(c.properties.palette);case 20:return o=e.sent,c.data.calcTpl=o,a=o.children[0].processedLocation,i=a.width,o=a.height,c.canvasStyleWidthInPx=i,c.canvasStyleHeightInPx=o,c.properties.widthPixels&&(setStringPrototype(t,c.properties.widthPixels/c.canvasStyleWidthInPx),c.canvasStyleWidthInPx=c.properties.widthPixels),c.setData({painterStyle:"width:".concat(c.canvasStyleWidthInPx,"px;height:").concat(c.canvasStyleHeightInPx,"px;position: fixed;top:0px;")}),e.next=29,c.initCanvasNew(c.data.calcTpl);case 29:a=e.sent,i=c.data.canvasCtx,o=c.data.canvasNode,new _pen.default(i,_objectSpread(_objectSpread({},a),{},{caniuse:c.data.caniuse,_canvas:o})).paint(function(){});case 35:case"end":return e.stop()}},e,null,[[2,6]])}))()},getCalcTpl:function(i){var o=this;return new Promise(function(a,t){try{wx.createSelectorQuery().in(o).select("#canvasp").fields({node:!0,size:!0}).exec(function(){var t=_asyncToGenerator(regeneratorRuntime.mark(function e(t){var r,n;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return n=t[0].node,r=n.getContext("2d"),o.data.canvasNode=n,o.data.canvasCtx=r,n=new _pen.default(r,_objectSpread(_objectSpread({},i),{},{caniuse:o.data.caniuse,_canvas:n})),o.data.pen=n,e.next=8,n.beforePaint();case 8:n=e.sent,a(n);case 10:case"end":return e.stop()}},e)}));return function(e){return t.apply(this,arguments)}}())}catch(e){t(e)}})},initCanvasNew:function(){var n=this;return _asyncToGenerator(regeneratorRuntime.mark(function e(){var t,r;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return t=n.data.calcTpl,r=wx.getSystemInfoSync().pixelRatio,n.data.canvasNode.height=t.children[0].processedLocation.height*r,n.data.canvasNode.width=t.children[0].processedLocation.width*r,n.data.canvasCtx.scale(r,r),e.abrupt("return",t);case 6:case"end":return e.stop()}},e)}))()},initCanvasOld:function(e,t){var r=wx.createCanvasContext("k-canvas",this),t=e/t.toPx();return r.scale(t,t),r},saveImgToLocal:function(){var t=this,r=this,e=this.properties.palette,n=(e.height,e.width),e=wx.getSystemInfoSync(),e=(e.windowWidth,e.windowHeight,e.pixelRatio);console.log("dpr`````````````````` ",e),console.timeEnd();var a=n.toPx(),i=e,n=[this.data.realAllH,n.toPx()],o=a*(n[0]/n[1]);setTimeout(function(){var e={canvasId:"k-canvas",x:0,y:0,width:+a,height:o,destWidth:+a*i,destHeight:o*i,success:function(e){r.getImageInfo(e.tempFilePath)},fail:function(e){console.error("canvasToTempFilePath failed, ".concat(JSON.stringify(e))),r.triggerEvent("imgErr",{error:e})}};e.canvas=t.data.canvasNode,wx.canvasToTempFilePath(e,t)},480)},getImageInfo:function(r){var n=this;wx.getImageInfo({src:r,success:function(e){if(n.paintCount>MAX_PAINT_COUNT){var t="The result is always fault, even we tried ".concat(MAX_PAINT_COUNT," times");return console.error(t),void n.triggerEvent("imgErr",{error:t})}n.setData({outputPic:r}),n.triggerEvent("imgOK",{path:r,id:"#canvasp"}),n.paintCount++},fail:function(e){console.error("getImageInfo failed, ".concat(JSON.stringify(e))),n.triggerEvent("imgErr",{error:e})}})},getTitleHeight:function(u,p){return _asyncToGenerator(regeneratorRuntime.mark(function e(){var t,r,n,a,i,o,c,s;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:if(p.text){e.next=2;break}return e.abrupt("return",0);case 2:for(t=p.text.split("\n"),r=0;r<t.length;++r)""===t[r]&&(t[r]=" ");for(s="bold"===p.fontWeight?"bold":"normal",p.fontSize=p.fontSize||"20rpx",u.font="normal ".concat(s," ").concat(p.fontSize.toPx(),"px ").concat(p.fontFamily?'"'.concat(p.fontFamily,'"'):"sans-serif"),a=[],i=n=0;i<t.length;++i)c=u.measureText(t[i]).width,o=p.width?p.width.toPx():c,c=Math.ceil(c/o),n+=c,a[i]=c;return n=p.maxLines<n?p.maxLines:n,s=(p.lineHeight||p.css.fontSize).toPx(),s=s*n,e.abrupt("return",s);case 15:case"end":return e.stop()}},e)}))()}}});