"use strict";
var __assign = (this && this.__assign) || function () {
    __assign = Object.assign || function(t) {
        for (var s, i = 1, n = arguments.length; i < n; i++) {
            s = arguments[i];
            for (var p in s) if (Object.prototype.hasOwnProperty.call(s, p))
                t[p] = s[p];
        }
        return t;
    };
    return __assign.apply(this, arguments);
};
Object.defineProperty(exports, "__esModule", { value: true });
var setStringPrototype = require('./util').setStringPrototype;
var Modifier = (function () {
    function Modifier(tpl) {
        var copyTpl = JSON.parse(JSON.stringify(tpl));
        this.tpl = copyTpl;
        this.views = copyTpl.views;
    }
    Modifier.prototype.insert = function (target, parentId, index) {
        if (parentId && !Number.isNaN(index)) {
            var flag = this.find(parentId);
            if (flag.length === 0)
                return;
            var node = { children: this.views };
            target.f_sid = parentId;
            return insertNode(parentId, index, node, target);
        }
    };
    Modifier.prototype.find = function (targetId) {
        var xx = cusGetElementByIdByDFS2({ children: this.views }, targetId);
        return xx;
    };
    Modifier.prototype.findParentNodeOf = function (node) {
        var targetId = node.f_sid;
        if (!targetId)
            return null;
        return this.find(targetId);
    };
    Modifier.prototype.del = function (parentId, index) {
        if (parentId && !Number.isNaN(index)) {
            var flag = this.find(parentId);
            if (flag.length === 0)
                return;
            var node = { children: this.views };
            return delNode(parentId, index, node);
        }
    };
    Modifier.prototype.update = function (target, parentId, index) {
        if (parentId && !Number.isNaN(index)) {
            var flag = this.find(parentId);
            if (flag.length === 0)
                return;
            var node = { children: this.views };
            return updateNode(parentId, index, node, target);
        }
    };
    Modifier.prototype.updateTree = function (changeNodeId, updateLeft, updateTop) {
        if (updateLeft === void 0) { updateLeft = false; }
        if (updateTop === void 0) { updateTop = true; }
        var targetNode = this.find(changeNodeId);
        var parentNode = this.find(targetNode.f_sid);
        var targetHeight = targetNode.css.height.toPx();
        var _z = this;
        (function dfs(target) {
            if (!target)
                return false;
            var _parentNode = _z.findParentNodeOf(target);
            if (!_parentNode) {
                if (_z.tpl.height === 'auto') {
                    var allH = _z.views.reduce(function (pre, next) {
                        var nextHeight = next.css.height ? next.css.height : '0px';
                        var sum = pre.toPx() + nextHeight.toPx();
                        return sum + "px";
                    }, '0px');
                    if (_z.tpl.paddingbottom) {
                        allH = allH.toPx() + _z.tpl.paddingbottom.toPx();
                        allH = allH + "px";
                    }
                    _z.tpl.height = allH;
                }
                else {
                    _z.tpl.height += targetHeight;
                    _z.tpl.height = _z.tpl.height + "px";
                }
                return false;
            }
            if (_parentNode.css.height.indexOf('px') < 0) {
                var height = _parentNode.children.reduce(function (pre, next) {
                    var nextHeight = next.css.height ? next.css.height : '0px';
                    var sum = pre.toPx() + nextHeight.toPx();
                    return sum + "px";
                }, '0px');
                _parentNode.css.height = height;
                _parentNode.processedLocation.height = height.toPx();
            }
            return dfs(_parentNode);
        }(targetNode));
        var allSiblingNodes = parentNode.children;
        var startChangeBtn = false;
        for (var _i = 0, allSiblingNodes_1 = allSiblingNodes; _i < allSiblingNodes_1.length; _i++) {
            var n = allSiblingNodes_1[_i];
            if (n.vid === changeNodeId) {
                startChangeBtn = true;
            }
            if (!startChangeBtn)
                continue;
            if (updateTop) {
                var paddingbottom = targetNode.css.paddingbottom ? targetNode.css.paddingbottom.toPx() : 0;
                n.processedLocation.y += targetNode.processedLocation ? targetNode.processedLocation.height : 0;
                n.processedLocation.y += paddingbottom;
            }
            if (updateLeft) {
                n.processedLocation.x += (targetNode.processedLocation ? targetNode.processedLocation.width : 0);
            }
        }
        this.views = this.tpl.views;
        return this.tpl;
    };
    Modifier.prototype.getAbsoluteTpl = function (_a) {
        var globalWidth = _a.globalWidth, globalHeight = _a.globalHeight;
        var node = { children: this.views };
        return __assign(__assign({}, this.tpl), { views: getNodeAbsoluteLeftTop(node, globalWidth, globalHeight) });
    };
    return Modifier;
}());
exports.default = Modifier;
function insertNode(parentId, index, node, target) {
    if (node) {
        var children = node.children;
        if (children) {
            for (var i = 0; i < children.length; i++) {
                if (children[i].vid === parentId) {
                    if (!children[i].children) {
                        children[i].children = [];
                    }
                    children[i].children.splice(index, 0, target);
                    break;
                }
                else {
                    insertNode(parentId, index, children[i], target);
                }
            }
        }
    }
    return node;
}
function delNode(parentId, index, node) {
    if (node) {
        var children = node.children;
        if (children) {
            for (var i = 0; i < children.length; i++) {
                if (children[i].vid === parentId) {
                    if (!children[i].children) {
                        children[i].children = [];
                    }
                    children[i].children.splice(index, 1);
                    break;
                }
                else {
                    delNode(parentId, index, children[i]);
                }
            }
        }
    }
    return node;
}
function updateNode(parentId, index, node, target) {
    if (node) {
        var children = node.children;
        if (children) {
            for (var i = 0; i < children.length; i++) {
                if (children[i].vid === parentId) {
                    if (!children[i].children) {
                        children[i].children = [];
                    }
                    children[i].children.splice(index, 1, target);
                    break;
                }
                else {
                    updateNode(parentId, index, children[i], target);
                }
            }
        }
    }
    return node;
}
function getNodeAbsoluteLeftTop(node, globalWidth, globalHeight, nodeList) {
    if (nodeList === void 0) { nodeList = []; }
    setStringPrototype(1, 1);
    if (node) {
        nodeList.push(node);
        var children = node.children;
        if (children) {
            for (var i = 0; i < children.length; i++) {
                children[i].processedLocation.x += (node.processedLocation ? node.processedLocation.x : 0);
                children[i].processedLocation.y += node.processedLocation ? node.processedLocation.y : 0;
                getNodeAbsoluteLeftTop(children[i], globalWidth, globalHeight, nodeList);
            }
        }
        else {
        }
    }
    return nodeList.slice(1);
}
function cusGetElementByIdByDFS2(parentNode, id) {
    if (!parentNode) {
        return null;
    }
    var stack = [];
    if (parentNode.vid === id) {
        return parentNode;
    }
    for (var i = parentNode.children.length; i > 0; i--) {
        stack.push(parentNode.children[i - 1]);
    }
    while (stack.length) {
        var node = stack.pop();
        if (node.vid === id) {
            return node;
        }
        if (node.children && node.children.length > 0) {
            stack = Array.from(node.children).concat(stack);
        }
    }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoibW9kaWZpZXIuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyJtb2RpZmllci50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7Ozs7Ozs7Ozs7O0FBRUEsSUFBTSxrQkFBa0IsR0FBRyxPQUFPLENBQUMsUUFBUSxDQUFDLENBQUMsa0JBQWtCLENBQUM7QUFFaEU7SUFDRSxrQkFBWSxHQUFHO1FBQ2IsSUFBTSxPQUFPLEdBQUcsSUFBSSxDQUFDLEtBQUssQ0FBQyxJQUFJLENBQUMsU0FBUyxDQUFDLEdBQUcsQ0FBQyxDQUFDLENBQUM7UUFFaEQsSUFBSSxDQUFDLEdBQUcsR0FBRyxPQUFPLENBQUM7UUFDbkIsSUFBSSxDQUFDLEtBQUssR0FBRyxPQUFPLENBQUMsS0FBSyxDQUFDO0lBQzdCLENBQUM7SUFLRCx5QkFBTSxHQUFOLFVBQU8sTUFBTSxFQUFFLFFBQVEsRUFBRSxLQUFLO1FBQzVCLElBQUksUUFBUSxJQUFJLENBQUMsTUFBTSxDQUFDLEtBQUssQ0FBQyxLQUFLLENBQUMsRUFBRTtZQUVwQyxJQUFNLElBQUksR0FBRyxJQUFJLENBQUMsSUFBSSxDQUFDLFFBQVEsQ0FBQyxDQUFDO1lBQ2pDLElBQUksSUFBSSxDQUFDLE1BQU0sS0FBSyxDQUFDO2dCQUFFLE9BQU87WUFDOUIsSUFBTSxJQUFJLEdBQUcsRUFBRSxRQUFRLEVBQUUsSUFBSSxDQUFDLEtBQUssRUFBRSxDQUFDO1lBQ3RDLE1BQU0sQ0FBQyxLQUFLLEdBQUcsUUFBUSxDQUFDO1lBQ3hCLE9BQU8sVUFBVSxDQUFDLFFBQVEsRUFBRSxLQUFLLEVBQUUsSUFBSSxFQUFFLE1BQU0sQ0FBQyxDQUFDO1NBQ2xEO0lBQ0gsQ0FBQztJQUVELHVCQUFJLEdBQUosVUFBSyxRQUFRO1FBQ1gsSUFBTSxFQUFFLEdBQUcsdUJBQXVCLENBQUMsRUFBRSxRQUFRLEVBQUUsSUFBSSxDQUFDLEtBQUssRUFBRSxFQUFFLFFBQVEsQ0FBQyxDQUFDO1FBQ3ZFLE9BQU8sRUFBRSxDQUFDO0lBSVosQ0FBQztJ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QUNELE9BQU8sUUFBUSxDQUFDLEtBQUssQ0FBQyxDQUFDLENBQUMsQ0FBQztBQUMzQixDQUFDO0FBRUQsU0FBUyx1QkFBdUIsQ0FBQyxVQUFVLEVBQUUsRUFBRTtJQUM3QyxJQUFJLENBQUMsVUFBVSxFQUFFO1FBQ2YsT0FBTyxJQUFJLENBQUM7S0FDYjtJQUVELElBQUksS0FBSyxHQUFHLEVBQUUsQ0FBQztJQUNmLElBQUksVUFBVSxDQUFDLEdBQUcsS0FBSyxFQUFFLEVBQUU7UUFDekIsT0FBTyxVQUFVLENBQUM7S0FDbkI7SUFDRCxLQUFLLElBQUksQ0FBQyxHQUFHLFVBQVUsQ0FBQyxRQUFRLENBQUMsTUFBTSxFQUFFLENBQUMsR0FBRyxDQUFDLEVBQUUsQ0FBQyxFQUFFLEVBQUU7UUFDbkQsS0FBSyxDQUFDLElBQUksQ0FBQyxVQUFVLENBQUMsUUFBUSxDQUFDLENBQUMsR0FBRyxDQUFDLENBQUMsQ0FBQyxDQUFDO0tBQ3hDO0lBQ0QsT0FBTyxLQUFLLENBQUMsTUFBTSxFQUFFO1FBQ25CLElBQU0sSUFBSSxHQUFHLEtBQUssQ0FBQyxHQUFHLEVBQUUsQ0FBQztRQUN6QixJQUFJLElBQUksQ0FBQyxHQUFHLEtBQUssRUFBRSxFQUFFO1lBQ25CLE9BQU8sSUFBSSxDQUFDO1NBQ2I7UUFDRCxJQUFJLElBQUksQ0FBQyxRQUFRLElBQUksSUFBSSxDQUFDLFFBQVEsQ0FBQyxNQUFNLEdBQUcsQ0FBQyxFQUFFO1lBQzdDLEtBQUssR0FBRyxLQUFLLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxRQUFRLENBQUMsQ0FBQyxNQUFNLENBQUMsS0FBSyxDQUFDLENBQUM7U0FDakQ7S0FDRjtBQUNILENBQUMiLCJzb3VyY2VzQ29udGVudCI6WyIvKiBlc2xpbnQtZGlzYWJsZSAqL1xuLy8gaW1wb3J0IF91dGlsIGZyb20gJy4vdXRpbCc7XG5jb25zdCBzZXRTdHJpbmdQcm90b3R5cGUgPSByZXF1aXJlKCcuL3V0aWwnKS5zZXRTdHJpbmdQcm90b3R5cGU7XG5cbmV4cG9ydCBkZWZhdWx0IGNsYXNzIE1vZGlmaWVyIHtcbiAgY29uc3RydWN0b3IodHBsKSB7XG4gICAgY29uc3QgY29weVRwbCA9IEpTT04ucGFyc2UoSlNPTi5zdHJpbmdpZnkodHBsKSk7XG4gICAgLy8gZGVidWdnZXI7XG4gICAgdGhpcy50cGwgPSBjb3B5VHBsO1xuICAgIHRoaXMudmlld3MgPSBjb3B5VHBsLnZpZXdzO1xuICB9XG5cbiAgLy8gdGFyZ2V0IOaPkuWFpeeahOWvueixoeiKgueCuVxuICAvLyBwYXJlbnRJZCDooqvmj5LlhaXnmoTniLbkurLoioLngrlcbiAgLy8gaW5kZXgg54i25Lqy6IqC54K555qE56ys5Yeg5Liq5YWD57SgXG4gIGluc2VydCh0YXJnZXQsIHBhcmVudElkLCBpbmRleCkge1xuICAgIGlmIChwYXJlbnRJZCAmJiAhTnVtYmVyLmlzTmFOKGluZGV4KSkge1xuICAgICAgLy8gZGVidWdnZXI7XG4gICAgICBjb25zdCBmbGFnID0gdGhpcy5maW5kKHBhcmVudElkKTtcbiAgICAgIGlmIChmbGFnLmxlbmd0aCA9PT0gMCkgcmV0dXJuO1xuICAgICAgY29uc3Qgbm9kZSA9IHsgY2hpbGRyZW46IHRoaXMudmlld3MgfTtcbiAgICAgIHRhcmdldC5mX3NpZCA9IHBhcmVudElkO1xuICAgICAgcmV0dXJuIGluc2VydE5vZGUocGFyZW50SWQsIGluZGV4LCBub2RlLCB0YXJnZXQpO1xuICAgIH1cbiAgfVxuXG4gIGZpbmQodGFyZ2V0SWQpIHtcbiAgICBjb25zdCB4eCA9IGN1c0dldEVsZW1lbnRCeUlkQnlERlMyKHsgY2hpbGRyZW46IHRoaXMudmlld3MgfSwgdGFyZ2V0SWQpO1xuICAgIHJldHVybiB4eDtcbiAgICAvLyB4eC5uYW1lID0gJ3BmcGZwJztcbiAgICAvLyBkZWJ1Z2dlcjtcbiAgICAvLyByZXR1cm4gZmluZFBhdGhERlModGhpcy52aWV3cywgdGFyZ2V0SWQpO1xuICB9XG5cbiAgZmluZFBhcmVudE5vZGVPZihub2RlKSB7XG4gICAgY29uc3QgdGFyZ2V0SWQgPSBub2RlLmZfc2lkO1xuICAgIGlmICghdGFyZ2V0SWQpIHJldHVybiBudWxsO1xuICAgIC8vIGNvbnN0IHRhcmdldE5vZGUgPSB0aGlzLmZpbmQodGFyZ2V0SWQpO1xuICAgIC8vIGlmICh0YXJnZXROb2RlLmxlbmd0aCA8IDIpIHsgcmV0dXJuOyB9XG4gICAgLy8gY29uc3QgcGFyZW50Tm9kZSA9IHRhcmdldE5vZGUuc2xpY2UoLTIpWzBdO1xuICAgIC8vIHJldHVybiBwYXJlbnROb2RlO1xuICAgIC8vIGNvbnN0IHh4ID0gY3VzR2V0RWxlbWVudEJ5SWRCeURGUzIoeyBjaGlsZHJlbjogdGhpcy52aWV3cyB9LCB0YXJnZXRJZCk7XG4gICAgcmV0dXJuIHRoaXMuZmluZCh0YXJnZXRJZCk7XG4gIH1cblxuICBkZWwocGFyZW50SWQsIGluZGV4KSB7XG4gICAgaWYgKHBhcmVudElkICYmICFOdW1iZXIuaXNOYU4oaW5kZXgpKSB7XG4gICAgICBjb25zdCBmbGFnID0gdGhpcy5maW5kKHBhcmVudElkKTtcbiAgICAgIGlmIChmbGFnLmxlbmd0aCA9PT0gMCkgcmV0dXJuO1xuICAgICAgY29uc3Qgbm9kZSA9IHsgY2hpbGRyZW46IHRoaXMudmlld3MgfTtcbiAgICAgIHJldHVybiBkZWxOb2RlKHBhcmVudElkLCBpbmRleCwgbm9kZSk7XG4gICAgfVxuICB9XG5cbiAgLy8g5L+u5pS55p+Q5Liq6IqC54K555qE5L+h5oGvXG4gIHVwZGF0ZSh0YXJnZXQsIHBhcmVudElkLCBpbmRleCkge1xuICAgIGlmIChwYXJlbnRJZCAmJiAhTnVtYmVyLmlzTmFOKGluZGV4KSkge1xuICAgICAgY29uc3QgZmxhZyA9IHRoaXMuZmluZChwYXJlbnRJZCk7XG4gICAgICBpZiAoZmxhZy5sZW5ndGggPT09IDApIHJldHVybjtcbiAgICAgIGNvbnN0IG5vZGUgPSB7IGNoaWxkcmVuOiB0aGlzLnZpZXdzIH07XG4gICAgICByZXR1cm4gdXBkYXRlTm9kZShwYXJlbnRJZCwgaW5kZXgsIG5vZGUsIHRhcmdldCk7XG4gICAgfVxuICB9XG5cbiAgLy8g5pu05paw5p+Q6IqC54K555qE5omA5pyJ54i26IqC54K544CB56WW5YWI6IqC54K55L+h5oGvKOWuvemrmOOAgeS9jee9rilcbiAgLy8g5YWE5byf6IqC54K56buY6K6k5pu05pawdG9w77yM5LiN5pu05pawbGVmdFxuICB1cGRhdGVUcmVlKGNoYW5nZU5vZGVJZCwgdXBkYXRlTGVmdCA9IGZhbHNlLCB1cGRhdGVUb3AgPSB0cnVlKSB7XG4gICAgY29uc3QgdGFyZ2V0Tm9kZSA9IHRoaXMuZmluZChjaGFuZ2VOb2RlSWQpO1xuICAgIGNvbnN0IHBhcmVudE5vZGUgPSB0aGlzLmZpbmQodGFyZ2V0Tm9kZS5mX3NpZCk7XG4gICAgY29uc3QgdGFyZ2V0SGVpZ2h0ID0gdGFyZ2V0Tm9kZS5jc3MuaGVpZ2h0LnRvUHgoKTtcblxuICAgIC8vIOabtOaWsOeItuiKgueCueWSjOelluWFiOiKgueCueeahOmrmOW6plxuICAgIGNvbnN0IF96ID0gdGhpcztcbiAgICAoZnVuY3Rpb24gZGZzKHRhcmdldCkge1xuICAgICAgaWYgKCF0YXJnZXQpIHJldHVybiBmYWxzZTtcbiAgICAgIGNvbnN0IF9wYXJlbnROb2RlID0gX3ouZmluZFBhcmVudE5vZGVPZih0YXJnZXQpO1xuICAgICAgaWYgKCFfcGFyZW50Tm9kZSkge1xuICAgICAgICAvLyDmoLnoioLngrnpq5jluqbmm7TmlrBcbiAgICAgICAgaWYgKF96LnRwbC5oZWlnaHQgPT09ICdhdXRvJykge1xuICAgICAgICAgIC8vIOWPqumcgOiuoeeul+S4gOe6p+WtkOiKgueCueeahOS4remrmOW6puWNs+WPr1xuICAgICAgICAgIGxldCBhbGxIID0gX3oudmlld3MucmVkdWNlKChwcmUsIG5leHQpID0+IHtcbiAgICAgICAgICAgIGNvbnN0IG5leHRIZWlnaHQgPSBuZXh0LmNzcy5oZWlnaHQgPyBuZXh0LmNzcy5oZWlnaHQgOiAnMHB4JztcbiAgICAgICAgICAgIGNvbnN0IHN1bSA9IHByZS50b1B4KCkgKyBuZXh0SGVpZ2h0LnRvUHgoKTtcbiAgICAgICAgICAgIHJldHVybiBgJHtzdW19cHhgO1xuICAgICAgICAgIH0sICcwcHgnKTtcbiAgICAgICAgICBpZiAoX3oudHBsLnBhZGRpbmdib3R0b20pIHtcbiAgICAgICAgICAgIGFsbEggPSBhbGxILnRvUHgoKSArIF96LnRwbC5wYWRkaW5nYm90dG9tLnRvUHgoKTtcbiAgICAgICAgICAgIGFsbEggPSBgJHthbGxIfXB4YDtcbiAgICAgICAgICB9XG4gICAgICAgICAgX3oudHBsLmhlaWdodCA9IGFsbEg7XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgX3oudHBsLmhlaWdodCArPSB0YXJnZXRIZWlnaHQ7XG4gICAgICAgICAgX3oudHBsLmhlaWdodCA9IGAke196LnRwbC5oZWlnaHR9cHhgO1xuICAgICAgICB9XG4gICAgICAgIHJldHVybiBmYWxzZTtcbiAgICAgIH1cblxuICAgICAgLy8g5aaC5p6c54i26IqC54K55pyJ6Ieq5a6a5LmJ6auY5bqm77yM5YiZ5Lul6Ieq6Lqr6K6+572u5Li65YeGXG4gICAgICBpZiAoX3BhcmVudE5vZGUuY3NzLmhlaWdodC5pbmRleE9mKCdweCcpIDwgMCkge1xuICAgICAgICBjb25zdCBoZWlnaHQgPSBfcGFyZW50Tm9kZS5jaGlsZHJlbi5yZWR1Y2UoKHByZSwgbmV4dCkgPT4ge1xuICAgICAgICAgIGNvbnN0IG5leHRIZWlnaHQgPSBuZXh0LmNzcy5oZWlnaHQgPyBuZXh0LmNzcy5oZWlnaHQgOiAnMHB4JztcbiAgICAgICAgICBjb25zdCBzdW0gPSBwcmUudG9QeCgpICsgbmV4dEhlaWdodC50b1B4KCk7XG4gICAgICAgICAgcmV0dXJuIGAke3N1bX1weGA7XG4gICAgICAgIH0sICcwcHgnKTtcbiAgICAgICAgX3BhcmVudE5vZGUuY3NzLmhlaWdodCA9IGhlaWdodDtcbiAgICAgICAgX3BhcmVudE5vZGUucHJvY2Vzc2VkTG9jYXRpb24uaGVpZ2h0ID0gaGVpZ2h0LnRvUHgoKTtcbiAgICAgIH1cblxuICAgICAgcmV0dXJuIGRmcyhfcGFyZW50Tm9kZSk7XG4gICAgfSh0YXJnZXROb2RlKSk7XG5cbiAgICAvLyDlkI7pnaLmiYDmnInlhYTlvJ/oioLngrnmm7TmlrBsZWZ0L3RvcFxuICAgIGNvbnN0IGFsbFNpYmxpbmdOb2RlcyA9IHBhcmVudE5vZGUuY2hpbGRyZW47XG4gICAgbGV0IHN0YXJ0Q2hhbmdlQnRuID0gZmFsc2U7XG4gICAgZm9yIChjb25zdCBuIG9mIGFsbFNpYmxpbmdOb2Rlcykge1xuICAgICAgaWYgKG4udmlkID09PSBjaGFuZ2VOb2RlSWQpIHtcbiAgICAgICAgc3RhcnRDaGFuZ2VCdG4gPSB0cnVlO1xuICAgICAgfVxuICAgICAgaWYgKCFzdGFydENoYW5nZUJ0bikgY29udGludWU7IC8vIOWJjemdoueahOWFhOW8n+iKgueCueS4jeeUqOWPmFxuXG4gICAgICAvLyBuLmNzcy5sZWZ0ID0gKG4uY3NzLmxlZnQpLnRvUHgoKTtcbiAgICAgIC8vIG4uY3NzLnRvcCA9IChuLmNzcy50b3ApLnRvUHgoKTtcbiAgICAgIC8vIG4uY3NzLmxlZnQgKz0gdGFyZ2V0Tm9kZS5jc3MgPyB0YXJnZXROb2RlLmNzcy5sZWZ0IDogMDtcbiAgICAgIC8vIG4uY3NzLnRvcCArPSB0YXJnZXROb2RlLmNzcyA/IHRhcmdldE5vZGUuY3NzLnRvcCA6IDA7XG4gICAgICBpZiAodXBkYXRlVG9wKSB7XG4gICAgICAgIC8vIGRlYnVnZ2VyO1xuICAgICAgICBjb25zdCBwYWRkaW5nYm90dG9tID0gdGFyZ2V0Tm9kZS5jc3MucGFkZGluZ2JvdHRvbSA/IHRhcmdldE5vZGUuY3NzLnBhZGRpbmdib3R0b20udG9QeCgpIDogMDtcbiAgICAgICAgbi5wcm9jZXNzZWRMb2NhdGlvbi55ICs9IHRhcmdldE5vZGUucHJvY2Vzc2VkTG9jYXRpb24gPyB0YXJnZXROb2RlLnByb2Nlc3NlZExvY2F0aW9uLmhlaWdodCA6IDA7XG4gICAgICAgIG4ucHJvY2Vzc2VkTG9jYXRpb24ueSArPSBwYWRkaW5nYm90dG9tO1xuICAgICAgfVxuICAgICAgaWYgKHVwZGF0ZUxlZnQpIHtcbiAgICAgICAgbi5wcm9jZXNzZWRMb2NhdGlvbi54ICs9ICh0YXJnZXROb2RlLnByb2Nlc3NlZExvY2F0aW9uID8gdGFyZ2V0Tm9kZS5wcm9jZXNzZWRMb2NhdGlvbi53aWR0aCA6IDApO1xuICAgICAgfVxuICAgIH1cbiAgICB0aGlzLnZpZXdzID0gdGhpcy50cGwudmlld3M7XG4gICAgLy8gZGVidWdnZXI7XG4gICAgcmV0dXJuIHRoaXMudHBsO1xuICB9XG5cbiAgZ2V0QWJzb2x1dGVUcGwoeyBnbG9iYWxXaWR0aCwgZ2xvYmFsSGVpZ2h0IH0pIHtcbiAgICBjb25zdCBub2RlID0geyBjaGlsZHJlbjogdGhpcy52aWV3cyB9O1xuICAgIHJldHVybiB7IC4uLnRoaXMudHBsLCAuLi57IHZpZXdzOiBnZXROb2RlQWJzb2x1dGVMZWZ0VG9wKG5vZGUsIGdsb2JhbFdpZHRoLCBnbG9iYWxIZWlnaHQpIH0gfTtcbiAgfVxufVxuXG4vLyDkv53mjIHltYzlpZfnu5PmnoTmj5LlhaVcbmZ1bmN0aW9uIGluc2VydE5vZGUocGFyZW50SWQsIGluZGV4LCBub2RlLCB0YXJnZXQpIHtcbiAgaWYgKG5vZGUpIHtcbiAgICAvLyBub2RlTGlzdC5wdXNoKG5vZGUpXG4gICAgY29uc3QgY2hpbGRyZW4gPSBub2RlLmNoaWxkcmVuO1xuICAgIGlmIChjaGlsZHJlbikge1xuICAgICAgZm9yIChsZXQgaSA9IDA7IGkgPCBjaGlsZHJlbi5sZW5ndGg7IGkrKykge1xuICAgICAgICBpZiAoY2hpbGRyZW5baV0udmlkID09PSBwYXJlbnRJZCkge1xuICAgICAgICAgIGlmICghY2hpbGRyZW5baV0uY2hpbGRyZW4pIHtcbiAgICAgICAgICAgIGNoaWxkcmVuW2ldLmNoaWxkcmVuID0gW107XG4gICAgICAgICAgfVxuICAgICAgICAgIGNoaWxkcmVuW2ldLmNoaWxkcmVuLnNwbGljZShpbmRleCwgMCwgdGFyZ2V0KTtcbiAgICAgICAgICBicmVhaztcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICBpbnNlcnROb2RlKHBhcmVudElkLCBpbmRleCwgY2hpbGRyZW5baV0sIHRhcmdldCk7XG4gICAgICAgIH1cbiAgICAgIH1cbiAgICB9XG4gIH1cbiAgLy8gZGVidWdnZXI7XG4gIHJldHVybiBub2RlO1xufVxuXG5mdW5jdGlvbiBkZWxOb2RlKHBhcmVudElkLCBpbmRleCwgbm9kZSkge1xuICBpZiAobm9kZSkge1xuICAgIGNvbnN0IGNoaWxkcmVuID0gbm9kZS5jaGlsZHJlbjtcbiAgICBpZiAoY2hpbGRyZW4pIHtcbiAgICAgIGZvciAobGV0IGkgPSAwOyBpIDwgY2hpbGRyZW4ubGVuZ3RoOyBpKyspIHtcbiAgICAgICAgaWYgKGNoaWxkcmVuW2ldLnZpZCA9PT0gcGFyZW50SWQpIHtcbiAgICAgICAgICBpZiAoIWNoaWxkcmVuW2ldLmNoaWxkcmVuKSB7XG4gICAgICAgICAgICBjaGlsZHJlbltpXS5jaGlsZHJlbiA9IFtdO1xuICAgICAgICAgIH1cbiAgICAgICAgICBjaGlsZHJlbltpXS5jaGlsZHJlbi5zcGxpY2UoaW5kZXgsIDEpO1xuICAgICAgICAgIGJyZWFrO1xuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgIGRlbE5vZGUocGFyZW50SWQsIGluZGV4LCBjaGlsZHJlbltpXSk7XG4gICAgICAgIH1cbiAgICAgIH1cbiAgICB9XG4gIH1cbiAgcmV0dXJuIG5vZGU7XG59XG5cbmZ1bmN0aW9uIHVwZGF0ZU5vZGUocGFyZW50SWQsIGluZGV4LCBub2RlLCB0YXJnZXQpIHtcbiAgaWYgKG5vZGUpIHtcbiAgICBjb25zdCBjaGlsZHJlbiA9IG5vZGUuY2hpbGRyZW47XG4gICAgaWYgKGNoaWxkcmVuKSB7XG4gICAgICBmb3IgKGxldCBpID0gMDsgaSA8IGNoaWxkcmVuLmxlbmd0aDsgaSsrKSB7XG4gICAgICAgIGlmIChjaGlsZHJlbltpXS52aWQgPT09IHBhcmVudElkKSB7XG4gICAgICAgICAgaWYgKCFjaGlsZHJlbltpXS5jaGlsZHJlbikge1xuICAgICAgICAgICAgY2hpbGRyZW5baV0uY2hpbGRyZW4gPSBbXTtcbiAgICAgICAgICB9XG4gICAgICAgICAgY2hpbGRyZW5baV0uY2hpbGRyZW4uc3BsaWNlKGluZGV4LCAxLCB0YXJnZXQpO1xuICAgICAgICAgIGJyZWFrO1xuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgIHVwZGF0ZU5vZGUocGFyZW50SWQsIGluZGV4LCBjaGlsZHJlbltpXSwgdGFyZ2V0KTtcbiAgICAgICAgfVxuICAgICAgfVxuICAgIH1cbiAgfVxuICByZXR1cm4gbm9kZTtcbn1cblxuLy8g6I635Y+W55u45a+5KDAsMCnnmoTjgIHmiZPlubPkuLrkuIDnuqfoioLngrnnmoTnu53lr7nlnZDmoId0cGzliJfooagsbGVmdC90b3DlgZrlsYLnuqflj6DliqBcbmZ1bmN0aW9uIGdldE5vZGVBYnNvbHV0ZUxlZnRUb3Aobm9kZSwgZ2xvYmFsV2lkdGgsIGdsb2JhbEhlaWdodCwgbm9kZUxpc3QgPSBbXSkge1xuICBzZXRTdHJpbmdQcm90b3R5cGUoMSwgMSk7XG4gIGlmIChub2RlKSB7XG4gICAgbm9kZUxpc3QucHVzaChub2RlKTtcbiAgICBjb25zdCBjaGlsZHJlbiA9IG5vZGUuY2hpbGRyZW47XG4gICAgaWYgKGNoaWxkcmVuKSB7XG4gICAgICBmb3IgKGxldCBpID0gMDsgaSA8IGNoaWxkcmVuLmxlbmd0aDsgaSsrKSB7XG4gICAgICAgIC8vIGNvbnN0IHggPSBjaGlsZHJlbltpXS5wcm9jZXNzZWRMb2NhdGlvbi54O1xuICAgICAgICAvLyBjb25zdCB5ID0gY2hpbGRyZW5baV0ucHJvY2Vzc2VkTG9jYXRpb24ueTtcbiAgICAgICAgLy8gY29uc29sZS5sb2coeCwgeSk7XG4gICAgICAgIGNoaWxkcmVuW2ldLnByb2Nlc3NlZExvY2F0aW9uLnggKz0gKG5vZGUucHJvY2Vzc2VkTG9jYXRpb24gPyBub2RlLnByb2Nlc3NlZExvY2F0aW9uLnggOiAwKTtcbiAgICAgICAgY2hpbGRyZW5baV0ucHJvY2Vzc2VkTG9jYXRpb24ueSArPSBub2RlLnByb2Nlc3NlZExvY2F0aW9uID8gbm9kZS5wcm9jZXNzZWRMb2NhdGlvbi55IDogMDtcblxuICAgICAgICBnZXROb2RlQWJzb2x1dGVMZWZ0VG9wKGNoaWxkcmVuW2ldLCBnbG9iYWxXaWR0aCwgZ2xvYmFsSGVpZ2h0LCBub2RlTGlzdCk7XG4gICAgICB9XG4gICAgfSBlbHNlIHtcbiAgICAgIC8vIOWPtuWtkOiKgueCueS9jee9rlxuXG4gICAgfVxuICB9XG4gIHJldHVybiBub2RlTGlzdC5zbGljZSgxKTtcbn1cblxuZnVuY3Rpb24gY3VzR2V0RWxlbWVudEJ5SWRCeURGUzIocGFyZW50Tm9kZSwgaWQpIHtcbiAgaWYgKCFwYXJlbnROb2RlKSB7XG4gICAgcmV0dXJuIG51bGw7XG4gIH1cbiAgLy8g5rex5bqm5LyY5YWILCDpnZ7pgJLlvZLlrp7njrDvvIwg5L2/55So5qCIXG4gIGxldCBzdGFjayA9IFtdO1xuICBpZiAocGFyZW50Tm9kZS52aWQgPT09IGlkKSB7XG4gICAgcmV0dXJuIHBhcmVudE5vZGU7XG4gIH1cbiAgZm9yIChsZXQgaSA9IHBhcmVudE5vZGUuY2hpbGRyZW4ubGVuZ3RoOyBpID4gMDsgaS0tKSB7XG4gICAgc3RhY2sucHVzaChwYXJlbnROb2RlLmNoaWxkcmVuW2kgLSAxXSk7XG4gIH1cbiAgd2hpbGUgKHN0YWNrLmxlbmd0aCkge1xuICAgIGNvbnN0IG5vZGUgPSBzdGFjay5wb3AoKTtcbiAgICBpZiAobm9kZS52aWQgPT09IGlkKSB7XG4gICAgICByZXR1cm4gbm9kZTtcbiAgICB9XG4gICAgaWYgKG5vZGUuY2hpbGRyZW4gJiYgbm9kZS5jaGlsZHJlbi5sZW5ndGggPiAwKSB7XG4gICAgICBzdGFjayA9IEFycmF5LmZyb20obm9kZS5jaGlsZHJlbikuY29uY2F0KHN0YWNrKTtcbiAgICB9XG4gIH1cbn1cbiJdfQ==