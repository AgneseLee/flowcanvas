"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
var TreeNode = (function () {
    function TreeNode(children) {
        this.children = children || [];
        this.parent = null;
        this.root = null;
        this.pre = null;
        this.next = null;
    }
    TreeNode.connectChildren = function (el) {
        if (el.hasChildren()) {
            el.children = el.children.filter(function (item) { return item instanceof TreeNode; });
            el._getChildren().map(function (child, index) {
                child._setParent(el);
                child._setSibling(el._getChildren()[index - 1], el._getChildren()[index + 1]);
                TreeNode.connectChildren(child);
            });
        }
        else {
        }
    };
    TreeNode.prototype.hasChildren = function () {
        return !!(Array.isArray(this.children) && this.children.length);
    };
    TreeNode.prototype._getChildren = function () {
        return this.hasChildren() ? this.children : [];
    };
    TreeNode.prototype._setParent = function (element) {
        this.parent = element;
        this.root = element.root;
    };
    TreeNode.prototype._setSibling = function (pre, next) {
        this.pre = pre || null;
        this.next = next || null;
    };
    TreeNode.prototype.appendChild = function (treeNode) {
        if (!treeNode instanceof TreeNode)
            throw Error('Unknown treeNode type');
        var pre = this._getChildren()[this._getChildren().length - 1];
        pre && pre._setSibling(pre.pre, treeNode);
        this.children.push(treeNode);
        treeNode._setParent(this);
        treeNode._setSibling(pre, null);
    };
    TreeNode.prototype.prependChild = function (treeNode) {
        if (!treeNode instanceof TreeNode)
            throw Error('Unknown treeNode type');
        var next = this._getChildren()[0];
        next && next._setSibling(treeNode, next.next);
        this.children.unshift(treeNode);
        treeNode._setParent(this);
        treeNode._setSibling(null, next);
    };
    TreeNode.prototype.removeChild = function (treeNode) {
        if (!treeNode instanceof TreeNode)
            throw Error('Unknown treeNode type');
        var index = this._getChildren().indexOf(treeNode);
        if (index < 0)
            throw Error('treeNode must be the child of parent');
        var pre = this._getChildren()[index - 1];
        var next = this._getChildren()[index + 1];
        if (pre) {
            pre._setSibling(pre.pre, next);
        }
        if (next) {
            next._setSibling(pre, next.next);
        }
        this.children.splice(index, 1);
    };
    TreeNode.prototype.remove = function () {
        if (!this.parent) {
            throw Error('Can not remove root node');
        }
        this.parent.removeChild(this);
    };
    TreeNode.prototype.append = function (treeNode) {
        var _this = this;
        if (!treeNode instanceof TreeNode)
            throw Error('Unknown treeNode type');
        if (!this.parent)
            throw Error('Can not add treeNode to root level!');
        var children = [];
        treeNode._setParent(this.parent);
        this.parent.children.forEach(function (child, index) {
            children.push(child);
            if (child === _this) {
                treeNode._setSibling(child, _this.parent.children[index + 1]);
                children.push(treeNode);
            }
        });
        this.parent.children = children;
    };
    TreeNode.prototype.prepend = function (treeNode) {
        if (!treeNode instanceof TreeNode)
            throw Error('Unknown treeNode type');
        if (!this.parent)
            throw Error('Can not add treeNode to root level!');
        var children = [];
        treeNode._setParent(this.parent);
        for (var i = this.parent.children.length - 1; i >= 0; i--) {
            children.unshift(this.parent.children[i]);
            if (this.parent.children[i] === this) {
                treeNode._setSibling(this.parent.children[i - 1], this.parent.children[i]);
                children.unshift(treeNode);
            }
        }
        this.parent.children = children;
    };
    return TreeNode;
}());
exports.default = TreeNode;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoidHJlZU5vZGUuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyJ0cmVlTm9kZS50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOztBQUNBO0lBaUJFLGtCQUFZLFFBQVE7UUFDbEIsSUFBSSxDQUFDLFFBQVEsR0FBRyxRQUFRLElBQUksRUFBRSxDQUFDO1FBQy9CLElBQUksQ0FBQyxNQUFNLEdBQUcsSUFBSSxDQUFDO1FBQ25CLElBQUksQ0FBQyxJQUFJLEdBQUcsSUFBSSxDQUFDO1FBQ2pCLElBQUksQ0FBQyxHQUFHLEdBQUcsSUFBSSxDQUFDO1FBQ2hCLElBQUksQ0FBQyxJQUFJLEdBQUcsSUFBSSxDQUFDO0lBQ25CLENBQUM7SUF0Qk0sd0JBQWUsR0FBdEIsVUFBdUIsRUFBRTtRQUN2QixJQUFJLEVBQUUsQ0FBQyxXQUFXLEVBQUUsRUFBRTtZQUNwQixFQUFFLENBQUMsUUFBUSxHQUFHLEVBQUUsQ0FBQyxRQUFRLENBQUMsTUFBTSxDQUFDLFVBQUMsSUFBSSxJQUFPLE9BQU8sSUFBSSxZQUFZLFFBQVEsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDO1lBRWpGLEVBQUUsQ0FBQyxZQUFZLEVBQUUsQ0FBQyxHQUFHLENBQUMsVUFBQyxLQUFLLEVBQUUsS0FBSztnQkFHakMsS0FBSyxDQUFDLFVBQVUsQ0FBQyxFQUFFLENBQUMsQ0FBQztnQkFFckIsS0FBSyxDQUFDLFdBQVcsQ0FBQyxFQUFFLENBQUMsWUFBWSxFQUFFLENBQUMsS0FBSyxHQUFHLENBQUMsQ0FBQyxFQUFFLEVBQUUsQ0FBQyxZQUFZLEVBQUUsQ0FBQyxLQUFLLEdBQUcsQ0FBQyxDQUFDLENBQUMsQ0FBQztnQkFDOUUsUUFBUSxDQUFDLGVBQWUsQ0FBQyxLQUFLLENBQUMsQ0FBQztZQUNsQyxDQUFDLENBQUMsQ0FBQztTQUNKO2FBQU07U0FDTjtJQUNILENBQUM7SUFVRCw4QkFBVyxHQUFYO1FBQ0UsT0FBTyxDQUFDLENBQUMsQ0FBQyxLQUFLLENBQUMsT0FBTyxDQUFDLElBQUksQ0FBQyxR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O1FBQ3hFLElBQUksQ0FBQyxJQUFJLENBQUMsTUFBTTtZQUFFLE1BQU0sS0FBSyxDQUFDLHFDQUFxQyxDQUFDLENBQUM7UUFDckUsSUFBTSxRQUFRLEdBQUcsRUFBRSxDQUFDO1FBQ3BCLFFBQVEsQ0FBQyxVQUFVLENBQUMsSUFBSSxDQUFDLE1BQU0sQ0FBQyxDQUFDO1FBQ2pDLEtBQUssSUFBSSxDQUFDLEdBQUcsSUFBSSxDQUFDLE1BQU0sQ0FBQyxRQUFRLENBQUMsTUFBTSxHQUFHLENBQUMsRUFBRSxDQUFDLElBQUksQ0FBQyxFQUFFLENBQUMsRUFBRSxFQUFFO1lBQ3pELFFBQVEsQ0FBQyxPQUFPLENBQUMsSUFBSSxDQUFDLE1BQU0sQ0FBQyxRQUFRLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQztZQUMxQyxJQUFJLElBQUksQ0FBQyxNQUFNLENBQUMsUUFBUSxDQUFDLENBQUMsQ0FBQyxLQUFLLElBQUksRUFBRTtnQkFDcEMsUUFBUSxDQUFDLFdBQVcsQ0FBQyxJQUFJLENBQUMsTUFBTSxDQUFDLFFBQVEsQ0FBQyxDQUFDLEdBQUcsQ0FBQyxDQUFDLEVBQUUsSUFBSSxDQUFDLE1BQU0sQ0FBQyxRQUFRLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQztnQkFDM0UsUUFBUSxDQUFDLE9BQU8sQ0FBQyxRQUFRLENBQUMsQ0FBQzthQUM1QjtTQUNGO1FBQ0QsSUFBSSxDQUFDLE1BQU0sQ0FBQyxRQUFRLEdBQUcsUUFBUSxDQUFDO0lBQ2xDLENBQUM7SUFDSCxlQUFDO0FBQUQsQ0FBQyxBQXBIRCxJQW9IQyIsInNvdXJjZXNDb250ZW50IjpbIi8qIGVzbGludC1kaXNhYmxlICovXG5leHBvcnQgZGVmYXVsdCBjbGFzcyBUcmVlTm9kZSB7XG4gIHN0YXRpYyBjb25uZWN0Q2hpbGRyZW4oZWwpIHtcbiAgICBpZiAoZWwuaGFzQ2hpbGRyZW4oKSkge1xuICAgICAgZWwuY2hpbGRyZW4gPSBlbC5jaGlsZHJlbi5maWx0ZXIoKGl0ZW0pID0+IHsgcmV0dXJuIGl0ZW0gaW5zdGFuY2VvZiBUcmVlTm9kZTsgfSk7XG4gICAgICAvLyBkZWJ1Z2dlclxuICAgICAgZWwuX2dldENoaWxkcmVuKCkubWFwKChjaGlsZCwgaW5kZXgpID0+IHtcbiAgICAgICAgLy8gZGVidWdnZXJcbiAgICAgICAgLy8g6K6+572ucGFyZW50XG4gICAgICAgIGNoaWxkLl9zZXRQYXJlbnQoZWwpO1xuICAgICAgICAvLyDorr7nva7kuobkuIrkuIDkuKrlhYTlvJ/oioLngrlcbiAgICAgICAgY2hpbGQuX3NldFNpYmxpbmcoZWwuX2dldENoaWxkcmVuKClbaW5kZXggLSAxXSwgZWwuX2dldENoaWxkcmVuKClbaW5kZXggKyAxXSk7XG4gICAgICAgIFRyZWVOb2RlLmNvbm5lY3RDaGlsZHJlbihjaGlsZCk7XG4gICAgICB9KTtcbiAgICB9IGVsc2Uge1xuICAgIH1cbiAgfVxuXG4gIGNvbnN0cnVjdG9yKGNoaWxkcmVuKSB7XG4gICAgdGhpcy5jaGlsZHJlbiA9IGNoaWxkcmVuIHx8IFtdO1xuICAgIHRoaXMucGFyZW50ID0gbnVsbDtcbiAgICB0aGlzLnJvb3QgPSBudWxsO1xuICAgIHRoaXMucHJlID0gbnVsbDtcbiAgICB0aGlzLm5leHQgPSBudWxsO1xuICB9XG5cbiAgaGFzQ2hpbGRyZW4oKSB7XG4gICAgcmV0dXJuICEhKEFycmF5LmlzQXJyYXkodGhpcy5jaGlsZHJlbikgJiYgdGhpcy5jaGlsZHJlbi5sZW5ndGgpO1xuICB9XG5cbiAgX2dldENoaWxkcmVuKCkge1xuICAgIHJldHVybiB0aGlzLmhhc0NoaWxkcmVuKCkgPyB0aGlzLmNoaWxkcmVuIDogW107XG4gIH1cblxuICBfc2V0UGFyZW50KGVsZW1lbnQpIHtcbiAgICB0aGlzLnBhcmVudCA9IGVsZW1lbnQ7XG4gICAgdGhpcy5yb290ID0gZWxlbWVudC5yb290O1xuICB9XG5cbiAgX3NldFNpYmxpbmcocHJlLCBuZXh0KSB7XG4gICAgdGhpcy5wcmUgPSBwcmUgfHwgbnVsbDtcbiAgICB0aGlzLm5leHQgPSBuZXh0IHx8IG51bGw7XG4gIH1cblxuICAvLyDmt7vliqDlnKjmnIDlkI5cbiAgYXBwZW5kQ2hpbGQodHJlZU5vZGUpIHtcbiAgICBpZiAoIXRyZWVOb2RlIGluc3RhbmNlb2YgVHJlZU5vZGUpIHRocm93IEVycm9yKCdVbmtub3duIHRyZWVOb2RlIHR5cGUnKTtcbiAgICBjb25zdCBwcmUgPSB0aGlzLl9nZXRDaGlsZHJlbigpW3RoaXMuX2dldENoaWxkcmVuKCkubGVuZ3RoIC0gMV07XG4gICAgcHJlICYmIHByZS5fc2V0U2libGluZyhwcmUucHJlLCB0cmVlTm9kZSk7XG4gICAgdGhpcy5jaGlsZHJlbi5wdXNoKHRyZWVOb2RlKTtcbiAgICB0cmVlTm9kZS5fc2V0UGFyZW50KHRoaXMpO1xuICAgIHRyZWVOb2RlLl9zZXRTaWJsaW5nKHByZSwgbnVsbCk7XG4gICAgLy8gcmV0dXJuIHRyZWVOb2RlXG4gIH1cblxuICAvL1xuICBwcmVwZW5kQ2hpbGQodHJlZU5vZGUpIHtcbiAgICBpZiAoIXRyZWVOb2RlIGluc3RhbmNlb2YgVHJlZU5vZGUpIHRocm93IEVycm9yKCdVbmtub3duIHRyZWVOb2RlIHR5cGUnKTtcbiAgICBjb25zdCBuZXh0ID0gdGhpcy5fZ2V0Q2hpbGRyZW4oKVswXTtcbiAgICBuZXh0ICYmIG5leHQuX3NldFNpYmxpbmcodHJlZU5vZGUsIG5leHQubmV4dCk7XG4gICAgdGhpcy5jaGlsZHJlbi51bnNoaWZ0KHRyZWVOb2RlKTtcbiAgICB0cmVlTm9kZS5fc2V0UGFyZW50KHRoaXMpO1xuICAgIHRyZWVOb2RlLl9zZXRTaWJsaW5nKG51bGwsIG5leHQpO1xuICAgIC8vIHJldHVybiB0cmVlTm9kZVxuICB9XG5cbiAgcmVtb3ZlQ2hpbGQodHJlZU5vZGUpIHtcbiAgICBpZiAoIXRyZWVOb2RlIGluc3RhbmNlb2YgVHJlZU5vZGUpIHRocm93IEVycm9yKCdVbmtub3duIHRyZWVOb2RlIHR5cGUnKTtcbiAgICBjb25zdCBpbmRleCA9IHRoaXMuX2dldENoaWxkcmVuKCkuaW5kZXhPZih0cmVlTm9kZSk7XG4gICAgaWYgKGluZGV4IDwgMCkgdGhyb3cgRXJyb3IoJ3RyZWVOb2RlIG11c3QgYmUgdGhlIGNoaWxkIG9mIHBhcmVudCcpO1xuICAgIGNvbnN0IHByZSA9IHRoaXMuX2dldENoaWxkcmVuKClbaW5kZXggLSAxXTtcbiAgICBjb25zdCBuZXh0ID0gdGhpcy5fZ2V0Q2hpbGRyZW4oKVtpbmRleCArIDFdO1xuICAgIGlmIChwcmUpIHtcbiAgICAgIHByZS5fc2V0U2libGluZyhwcmUucHJlLCBuZXh0KTtcbiAgICB9XG4gICAgaWYgKG5leHQpIHtcbiAgICAgIG5leHQuX3NldFNpYmxpbmcocHJlLCBuZXh0Lm5leHQpO1xuICAgIH1cbiAgICB0aGlzLmNoaWxkcmVuLnNwbGljZShpbmRleCwgMSk7XG4gIH1cblxuICByZW1vdmUoKSB7XG4gICAgaWYgKCF0aGlzLnBhcmVudCkge1xuICAgICAgdGhyb3cgRXJyb3IoJ0NhbiBub3QgcmVtb3ZlIHJvb3Qgbm9kZScpO1xuICAgIH1cbiAgICB0aGlzLnBhcmVudC5yZW1vdmVDaGlsZCh0aGlzKTtcbiAgfVxuXG4gIGFwcGVuZCh0cmVlTm9kZSkge1xuICAgIGlmICghdHJlZU5vZGUgaW5zdGFuY2VvZiBUcmVlTm9kZSkgdGhyb3cgRXJyb3IoJ1Vua25vd24gdHJlZU5vZGUgdHlwZScpO1xuICAgIGlmICghdGhpcy5wYXJlbnQpIHRocm93IEVycm9yKCdDYW4gbm90IGFkZCB0cmVlTm9kZSB0byByb290IGxldmVsIScpO1xuICAgIGNvbnN0IGNoaWxkcmVuID0gW107XG4gICAgdHJlZU5vZGUuX3NldFBhcmVudCh0aGlzLnBhcmVudCk7XG4gICAgdGhpcy5wYXJlbnQuY2hpbGRyZW4uZm9yRWFjaCgoY2hpbGQsIGluZGV4KSA9PiB7XG4gICAgICBjaGlsZHJlbi5wdXNoKGNoaWxkKTtcbiAgICAgIGlmIChjaGlsZCA9PT0gdGhpcykge1xuICAgICAgICB0cmVlTm9kZS5fc2V0U2libGluZyhjaGlsZCwgdGhpcy5wYXJlbnQuY2hpbGRyZW5baW5kZXggKyAxXSk7XG4gICAgICAgIGNoaWxkcmVuLnB1c2godHJlZU5vZGUpO1xuICAgICAgfVxuICAgIH0pO1xuICAgIHRoaXMucGFyZW50LmNoaWxkcmVuID0gY2hpbGRyZW47XG4gIH1cblxuICBwcmVwZW5kKHRyZWVOb2RlKSB7XG4gICAgaWYgKCF0cmVlTm9kZSBpbnN0YW5jZW9mIFRyZWVOb2RlKSB0aHJvdyBFcnJvcignVW5rbm93biB0cmVlTm9kZSB0eXBlJyk7XG4gICAgaWYgKCF0aGlzLnBhcmVudCkgdGhyb3cgRXJyb3IoJ0NhbiBub3QgYWRkIHRyZWVOb2RlIHRvIHJvb3QgbGV2ZWwhJyk7XG4gICAgY29uc3QgY2hpbGRyZW4gPSBbXTtcbiAgICB0cmVlTm9kZS5fc2V0UGFyZW50KHRoaXMucGFyZW50KTtcbiAgICBmb3IgKGxldCBpID0gdGhpcy5wYXJlbnQuY2hpbGRyZW4ubGVuZ3RoIC0gMTsgaSA+PSAwOyBpLS0pIHtcbiAgICAgIGNoaWxkcmVuLnVuc2hpZnQodGhpcy5wYXJlbnQuY2hpbGRyZW5baV0pO1xuICAgICAgaWYgKHRoaXMucGFyZW50LmNoaWxkcmVuW2ldID09PSB0aGlzKSB7XG4gICAgICAgIHRyZWVOb2RlLl9zZXRTaWJsaW5nKHRoaXMucGFyZW50LmNoaWxkcmVuW2kgLSAxXSwgdGhpcy5wYXJlbnQuY2hpbGRyZW5baV0pO1xuICAgICAgICBjaGlsZHJlbi51bnNoaWZ0KHRyZWVOb2RlKTtcbiAgICAgIH1cbiAgICB9XG4gICAgdGhpcy5wYXJlbnQuY2hpbGRyZW4gPSBjaGlsZHJlbjtcbiAgfVxufVxuIl19