"use strict";
var __assign = (this && this.__assign) || function () {
    __assign = Object.assign || function(t) {
        for (var s, i = 1, n = arguments.length; i < n; i++) {
            s = arguments[i];
            for (var p in s) if (Object.prototype.hasOwnProperty.call(s, p))
                t[p] = s[p];
        }
        return t;
    };
    return __assign.apply(this, arguments);
};
Object.defineProperty(exports, "__esModule", { value: true });
exports.xmlToVnode = exports.initVnodeTree = exports.connectChildren = exports.createVnode = void 0;
var util_1 = require("./util");
var createVnode = function (node) {
    var _node = {
        text: node.text || '',
        url: node.url || '',
        type: node.type,
        css: node.css || {},
        islines: false,
        renderStyle: { x: 0, y: 0, contentX: 0, contentY: 0 },
        children: node.children || [],
        lines: [],
        parent: null,
        pre: null,
        next: null
    };
    return Object.assign(node, _node);
};
exports.createVnode = createVnode;
var connectChildren = function (el, isRoot) {
    if (isRoot === void 0) { isRoot = false; }
    if (hasChildren(el)) {
        _getChildren(el).forEach(function (child, index) {
            if (child.attributes['p-if'] === 'false') {
            }
            else {
                child.css = _inheritStyle(el, child);
                _setParent(child, el, isRoot);
                isRoot = false;
                _setSibling(child, _getChildren(el)[index - 1], _getChildren(el)[index + 1]);
                exports.connectChildren(child, isRoot);
            }
        });
    }
};
exports.connectChildren = connectChildren;
var initVnodeTree = function (node) {
    var nodes = [];
    if (node != null) {
        var queue = [];
        queue.unshift(node);
        while (queue.length != 0) {
            var item = queue.shift();
            item = exports.createVnode(item);
            nodes.push(item);
            var children = item.children || [];
            for (var i = 0; i < children.length; i++)
                queue.push(children[i]);
        }
    }
    exports.connectChildren(node);
    console.log('vnodeTree is: ', node);
    return node;
};
exports.initVnodeTree = initVnodeTree;
function hasChildren(vnode) {
    return !!(Array.isArray(vnode.children) && vnode.children.length);
}
function _getChildren(el) {
    return hasChildren(el) ? el.children : [];
}
function _delNode(parent, child) {
    var idx = parent.children.findIndex(function (x) { return x === child; });
    parent.children.splice(idx, 1);
}
function _setParent(curr, element, isRoot) {
    curr.parent = isRoot ? null : element;
}
function _setSibling(curr, pre, next) {
    curr.pre = pre || null;
    curr.next = next || null;
}
function _inheritStyle(parent, child) {
    var copyParentCss = JSON.parse(JSON.stringify(parent.css));
    var notInheritStyleOfParent = ['height', 'width', 'margin', 'padding', 'marginTop', 'marginLeft', 'marginBottom', 'marginRight', 'paddingLeft', 'paddingRight', 'paddingTop', 'paddingBottom'];
    for (var _i = 0, _a = Object.keys(copyParentCss); _i < _a.length; _i++) {
        var cssName = _a[_i];
        if (!notInheritStyleOfParent.includes(cssName))
            continue;
        delete copyParentCss[cssName];
    }
    var style = __assign(__assign({}, copyParentCss), child.css);
    return style;
}
function _formatVnode2(xom, style) {
    util_1.deepFirstSearch(xom, function (node) {
        if (node.attributes.class) {
            var classNames = node.attributes.class.split(' ');
            var css = classNames.reduce(function (pre, next) {
                return __assign(__assign({}, pre), style[next]);
            }, {});
            node.css = css;
        }
        if (node.attributes.class === 'img' && node.attributes.src) {
            node.url = node.attributes.src;
        }
        if (node.name === 'text') {
            node.text = node.content;
        }
        node.type = node.name;
        exports.createVnode(node);
    });
    exports.connectChildren(xom);
}
function _formatVnode(xom, style) {
    util_1.deepFirstSearch(xom, function (node) {
        if (node.attributes.class) {
            var classNames = node.attributes.class.split(' ');
            var css = classNames.reduce(function (pre, next) {
                return __assign(__assign({}, pre), style[next]);
            }, {});
            node.css = css;
        }
        if (node.attributes.class === 'img' && node.attributes.src) {
            node.url = node.attributes.src;
        }
        if (node.name === 'text') {
            node.text = node.children[0];
            node.children.length = 0;
        }
        node.type = node.name;
        exports.createVnode(node);
    });
    exports.connectChildren(xom);
}
var xmlToVnode = function (wxml, style) {
    var xom = wxml;
    _formatVnode(xom, style);
    return xom;
};
exports.xmlToVnode = xmlToVnode;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoidm5vZGUuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi9zcmMveHhwYWludC9saWIvdm5vZGUudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7Ozs7Ozs7Ozs7Ozs7QUFFQSwrQkFBeUM7QUFPbEMsSUFBTSxXQUFXLEdBQUcsVUFBQyxJQUFJO0lBQzlCLElBQU0sS0FBSyxHQUFHO1FBRVosSUFBSSxFQUFFLElBQUksQ0FBQyxJQUFJLElBQUksRUFBRTtRQUNyQixHQUFHLEVBQUUsSUFBSSxDQUFDLEdBQUcsSUFBSSxFQUFFO1FBQ25CLElBQUksRUFBRSxJQUFJLENBQUMsSUFBSTtRQUNmLEdBQUcsRUFBRSxJQUFJLENBQUMsR0FBRyxJQUFJLEVBQUU7UUFDbkIsT0FBTyxFQUFFLEtBQUs7UUFFZCxXQUFXLEVBQUUsRUFBRSxDQUFDLEVBQUUsQ0FBQyxFQUFFLENBQUMsRUFBRSxDQUFDLEVBQUUsUUFBUSxFQUFFLENBQUMsRUFBRSxRQUFRLEVBQUUsQ0FBQyxFQUFFO1FBQ3JELFFBQVEsRUFBRSxJQUFJLENBQUMsUUFBUSxJQUFJLEVBQUU7UUFDN0IsS0FBSyxFQUFFLEVBQUU7UUFDVCxNQUFNLEVBQUUsSUFBSTtRQUNaLEdBQUcsRUFBRSxJQUFJO1FBQ1QsSUFBSSxFQUFFLElBQUk7S0FDWCxDQUFDO0lBQ0YsT0FBTyxNQUFNLENBQUMsTUFBTSxDQUFDLElBQUksRUFBRSxLQUFLLENBQUMsQ0FBQztBQUNwQyxDQUFDLENBQUM7QUFqQlcsUUFBQSxXQUFXLGVBaUJ0QjtBQU9LLElBQU0sZUFBZSxHQUFHLFVBQUMsRUFBRSxFQUFFLE1BQWM7SUFBZCx1QkFBQSxFQUFBLGNBQWM7SUFFaEQsSUFBSSxXQUFXLENBQUMsRUFBRSxDQUFDLEVBQUU7UUFDbkIsWUFBWSxDQUFDLEVBQUUsQ0FBQyxDQUFDLE9BQU8sQ0FBQyxVQUFDLEtBQUssRUFBRSxLQUFLO1lBQ3BDLElBQUksS0FBSyxDQUFDLFVBQVUsQ0FBQyxNQUFNLENBQUMsS0FBSyxPQUFPLEVBQUU7YUFHekM7aUJBQU07Z0JBRUwsS0FBSyxDQUFDLEdBQUcsR0FBRyxhQUFhLENBQUMsRUFBRSxFQUFFLEtBQUssQ0FBQyxDQUFDO2dCQUlyQyxVQUFVLENBQUMsS0FBSyxFQUFFLEVBQUUsRUFBRSxNQUFNLENBQUMsQ0FBQztnQkFDOUIsTUFBTSxHQUFHLEtBQUssQ0FBQztnQkFFZixXQUFXLENBQUMsS0FBSyxFQUFFLFlBQVksQ0FBQyxFQUFFLENBQUMsQ0FBQyxLQUFLLEdBQUcsQ0FBQyxDQUFDLEVBQUUsWUFBWSxDQUFDLEVBQUUsQ0FBQyxDQUFDLEtBQUssR0FBRyxDQUFDLENBQUMsQ0FBQyxDQUFDO2dCQUM3RSx1QkFBZSxDQUFDLEtBQUssRUFBRSxNQUFNLENBQUMsQ0FBQzthQUNoQztRQUNILENBQUMsQ0FBQyxDQUFDO0tBQ0o7QUFDSCxDQUFDLENBQUM7QUFyQlcsUUFBQSxlQUFlLG1CQXFCMUI7QUFNSyxJQUFNLGFBQWEsR0FBRyxVQUFDLElBQUk7SUFDaEMsSUFBTSxLQUFLLEdBQUcsRUFBRSxDQUFDO0lBQ2pCLElBQUksSUFBSSxJQUFJLElBQUksRUFBRTtRQUNoQixJQUFNLEtBQUssR0FBRyxFQUFFLENBQUM7UUFDakIsS0FBSyxDQUFDLE9BQU8sQ0FBQyxJQUFJLENBQUMsQ0FBQztRQUNwQixPQUFPLEtBQUssQ0FBQyxNQUFNLElBQUksQ0FBQyxFQUFFO1lBQ3hCLElBQUksSUFBSSxHQUFHLEtBQUssQ0FBQyxLQUFLLEVBQUUsQ0FBQztZQUN6QixJQUFJLEdBQUcsbUJBQVcsQ0FBQyxJQUFJLENBQUMsQ0FBQztZQUN6QixLQUFLLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxDQUFDO1lBQ2pCLElBQU0sUUFBUSxHQUFHLElBQUksQ0FBQyxRQUFRLElBQUksRUFBRSxDQUFDO1lBQ3JDLEtBQUssSUFBSSxDQUFDLEdBQUcsQ0FBQyxFQUFFLENBQUMsR0FBRyxRQUFRLENBQUMsTUFBTSxFQUFFLENBQUMsRUFBRTtnQkFBRSxLQUFLLENBQUMsSUFBSSxDQUFDLFFBQVEsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDO1NBQ25FO0tBQ0Y7SUFFRCx1QkFBZSxDQUFDLElBQUksQ0FBQyxDQUFDO0lBQ3RCLE9BQU8sQ0FBQyxHQUFHLENBQUMsZ0JBQWdCLEVBQUUsSUFBSSxDQUFDLENBQUM7SUFDcEMsT0FBTyxJQUFJLENBQUM7QUFDZCxDQUFDLENBQUM7QUFqQlcsUUFBQSxhQUFhLGlCQWlCeEI7QUFHRixTQUFTLFdBQVcsQ0FBQyxLQUFLO0lBQ3hCLE9BQU8sQ0FBQyxDQUFDLENBQUMsS0FBSyxDQUFDLE9BQU8sQ0FBQyxLQUFLLENBQUMsUUFBUSxDQUFDLElBQUksS0FBSyxDQUFDLFFBQVEsQ0FBQyxNQUFNLENBQUMsQ0FBQztBQUNwRSxDQUFDO0FBR0QsU0FBUyxZQUFZLENBQUMsRUFBRTtJQUN0QixPQUFPLFdBQVcsQ0FBQyxFQUFFLENBQUMsQ0FBQyxDQUFDLENBQUMsRUFBRSxDQUFDLFFBQVEsQ0FBQyxDQUFDLENBQUMsRUFBRSxDQUFDO0FBQzVDLENBQUM7QUFDRCxTQUFTLFFBQVEsQ0FBQyxNQUFNLEVBQUUsS0FBSztJQUU3QixJQUFNLEdBQUcsR0FBRyxNQUFNLENBQUMsUUFBUSxDQUFDLFNBQVMsQ0FBQyxVQUFDLENBQUMsSUFBTyxPQUFPLENBQUMsS0FBSyxLQUFLLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQztJQUN0RSxNQUFNLENBQUMsUUFBUSxDQUFDLE1BQU0sQ0FBQyxHQUFHLEVBQUUsQ0FBQyxDQUFDLENBQUM7QUFDakMsQ0FBQztBQUVELFNBQVMsVUFBVSxDQUFDLElBQUksRUFBRSxPQUFPLEVBQUUsTUFBTTtJQUN2QyxJQUFJLENBQUMsTUFBTSxHQUFHLE1BQU0sQ0FBQyxDQUFDLENBQUMsSUFBSSxDQUFDLENBQUMsQ0FBQyxPQUFPLENBQUM7QUFFeEMsQ0FBQztBQUVELFNBQVMsV0FBVyxDQUFDLElBQUksRUFBRSxHQUFHLEVBQUUsSUFBSTtJQUNsQyxJQUFJLENBQUMsR0FBRyxHQUFHLEdBQUcsSUFBSSxJQUFJLENBQUM7SUFDdkIsSUFBSSxDQUFDLElBQUksR0FBRyxJQUFJLElBQUksSUFBSSxDQUFDO0FBQzNCLENBQUM7QUFPRCxTQUFTLGFBQWEsQ0FBQyxNQUFNLEVBQUUsS0FBSztJQUNsQyxJQUFNLGFBQWEsR0FBRyxJQUFJLENBQUMsS0FBSyxDQUFDLElBQUksQ0FBQyxTQUFTLENBQUMsTUFBTSxDQUFDLEdBQUcsQ0FBQyxDQUFDLENBQUM7SUFFN0QsSUFBTSx1QkFBdUIsR0FBRyxDQUFDLFFBQVEsRUFBRSxPQUFPLEVBQUUsUUFBUSxFQUFFLFNBQVMsRUFBRSxXQUFXLEVBQUUsWUFBWSxFQUFFLGNBQWMsRUFBRSxhQUFhLEVBQUUsYUFBYSxFQUFFLGNBQWMsRUFBRSxZQUFZLEVBQUUsZUFBZSxDQUFDLENBQUM7SUFDak0sS0FBc0IsVUFBMEIsRUFBMUIsS0FBQSxNQUFNLENBQUMsSUFBSSxDQUFDLGFBQWEsQ0FBQyxFQUExQixjQUEwQixFQUExQixJQUEwQixFQUFFO1FBQTdDLElBQU0sT0FBTyxTQUFBO1FBQ2hCLElBQUksQ0FBQyx1QkFBdUIsQ0FBQyxRQUFRLENBQUMsT0FBTyxDQUFDO1lBQUUsU0FBUztRQUN6RCxPQUFPLGFBQWEsQ0FBQyxPQUFPLENBQUMsQ0FBQztLQUMvQjtJQUNELElBQU0sS0FBSyx5QkFBUSxhQUFhLEdBQUssS0FBSyxDQUFDLEdBQUcsQ0FBRSxDQUFDO0lBQ2pELE9BQU8sS0FBSyxDQUFDO0FBQ2YsQ0FBQztBQU9ELFNBQVMsYUFBYSxDQUFDLEdBQUcsRUFBRSxLQUFLO0lBQy9CLHNCQUFlLENBQUMsR0FBRyxFQUFFLFVBQUMsSUFBSTtRQUd4QixJQUFHLElBQUksQ0FBQyxVQUFVLENBQUMsS0FBSyxFQUFDO1lBQ3ZCLElBQU0sVUFBVSxHQUFHLElBQUksQ0FBQyxVQUFVLENBQUMsS0FBSyxDQUFDLEtBQUssQ0FBQyxHQUFHLENBQUMsQ0FBQztZQUNwRCxJQUFNLEdBQUcsR0FBRyxVQUFVLENBQUMsTUFBTSxDQUFDLFVBQUMsR0FBRyxFQUFFLElBQUk7Z0JBQ3RDLDZCQUFZLEdBQUcsR0FBSyxLQUFLLENBQUMsSUFBSSxDQUFDLEVBQUc7WUFDcEMsQ0FBQyxFQUFFLEVBQUUsQ0FBQyxDQUFDO1lBQ1AsSUFBSSxDQUFDLEdBQUcsR0FBRyxHQUFHLENBQUM7U0FDaEI7UUFFRCxJQUFJLElBQUksQ0FBQyxVQUFVLENBQUMsS0FBSyxLQUFLLEtBQUssSUFBSSxJQUFJLENBQUMsVUFBVSxDQUFDLEdBQUcsRUFBRTtZQUMxRCxJQUFJLENBQUMsR0FBRyxHQUFHLElBQUksQ0FBQyxVQUFVLENBQUMsR0FBRyxDQUFDO1NBQ2hDO1FBRUQsSUFBSSxJQUFJLENBQUMsSUFBSSxLQUFLLE1BQU0sRUFBRTtZQUN4QixJQUFJLENBQUMsSUFBSSxHQUFHLElBQUksQ0FBQyxPQUFPLENBQUM7U0FDMUI7UUFDRCxJQUFJLENBQUMsSUFBSSxHQUFHLElBQUksQ0FBQyxJQUFJLENBQUM7UUFFdEIsbUJBQVcsQ0FBQyxJQUFJLENBQUMsQ0FBQztJQUNwQixDQUFDLENBQUMsQ0FBQztJQUVILHVCQUFlLENBQUMsR0FBRyxDQUFDLENBQUM7QUFDdkIsQ0FBQztBQUVELFNBQVMsWUFBWSxDQUFDLEdBQUcsRUFBRSxLQUFLO0lBQzlCLHNCQUFlLENBQUMsR0FBRyxFQUFFLFVBQUMsSUFBSTtRQUd4QixJQUFHLElBQUksQ0FBQyxVQUFVLENBQUMsS0FBSyxFQUFDO1lBQ3ZCLElBQU0sVUFBVSxHQUFHLElBQUksQ0FBQyxVQUFVLENBQUMsS0FBSyxDQUFDLEtBQUssQ0FBQyxHQUFHLENBQUMsQ0FBQztZQUNwRCxJQUFNLEdBQUcsR0FBRyxVQUFVLENBQUMsTUFBTSxDQUFDLFVBQUMsR0FBRyxFQUFFLElBQUk7Z0JBQ3RDLDZCQUFZLEdBQUcsR0FBSyxLQUFLLENBQUMsSUFBSSxDQUFDLEVBQUc7WUFDcEMsQ0FBQyxFQUFFLEVBQUUsQ0FBQyxDQUFDO1lBQ1AsSUFBSSxDQUFDLEdBQUcsR0FBRyxHQUFHLENBQUM7U0FDaEI7UUFFRCxJQUFJLElBQUksQ0FBQyxVQUFVLENBQUMsS0FBSyxLQUFLLEtBQUssSUFBSSxJQUFJLENBQUMsVUFBVSxDQUFDLEdBQUcsRUFBRTtZQUMxRCxJQUFJLENBQUMsR0FBRyxHQUFHLElBQUksQ0FBQyxVQUFVLENBQUMsR0FBRyxDQUFDO1NBQ2hDO1FBRUQsSUFBSSxJQUFJLENBQUMsSUFBSSxLQUFLLE1BQU0sRUFBRTtZQUN4QixJQUFJLENBQUMsSUFBSSxHQUFHLElBQUksQ0FBQyxRQUFRLENBQUMsQ0FBQyxDQUFDLENBQUM7WUFDN0IsSUFBSSxDQUFDLFFBQVEsQ0FBQyxNQUFNLEdBQUMsQ0FBQyxDQUFBO1NBQ3ZCO1FBQ0QsSUFBSSxDQUFDLElBQUksR0FBRyxJQUFJLENBQUMsSUFBSSxDQUFDO1FBRXRCLG1CQUFXLENBQUMsSUFBSSxDQUFDLENBQUM7SUFDcEIsQ0FBQyxDQUFDLENBQUM7SUFFSCx1QkFBZSxDQUFDLEdBQUcsQ0FBQyxDQUFDO0FBQ3ZCLENBQUM7QUFPTSxJQUFNLFVBQVUsR0FBRyxVQUFDLElBQUksRUFBRSxLQUFLO0lBRXBDLElBQU0sR0FBRyxHQUFHLElBQUksQ0FBQTtJQUVoQixZQUFZLENBQUMsR0FBRyxFQUFFLEtBQUssQ0FBQyxDQUFDO0lBQ3pCLE9BQU8sR0FBRyxDQUFDO0FBQ2IsQ0FBQyxDQUFDO0FBTlcsUUFBQSxVQUFVLGNBTXJCIiwic291cmNlc0NvbnRlbnQiOlsiLyogZXNsaW50LWRpc2FibGUgKi9cbi8vIGltcG9ydCB4bWxQYXJzZSBmcm9tICcuL3htbC1wYXJzZXInO1xuaW1wb3J0IHsgZGVlcEZpcnN0U2VhcmNoIH0gZnJvbSAnLi91dGlsJztcbi8vIGltcG9ydCB7d3htbCxzdHlsZX0gZnJvbSAnLi9odG1sJ1xuXG4vKipcbiAqIOWIm+W7uuiZmuaLn+iKgueCuVxuICogQHBhcmFtIHtvYmplY3R9IG5vZGUg6YWN572u5paH5Lu25Lit55qE6IqC54K5XG4gKi9cbmV4cG9ydCBjb25zdCBjcmVhdGVWbm9kZSA9IChub2RlKSA9PiB7XG4gIGNvbnN0IF9ub2RlID0ge1xuICAgIC8vIGlkOlxuICAgIHRleHQ6IG5vZGUudGV4dCB8fCAnJywgLy8g5paH5pys57G75Z6L5omN5pyJXG4gICAgdXJsOiBub2RlLnVybCB8fCAnJywgLy8g5Zu+54mH57G75Z6L5omN5pyJXG4gICAgdHlwZTogbm9kZS50eXBlLFxuICAgIGNzczogbm9kZS5jc3MgfHwge30sXG4gICAgaXNsaW5lczogZmFsc2UsIC8vIOaYr+WQpuaNouihjFxuICAgIC8vIGxheW91dFNpemU6IHsgaGVpZ2h0OiAwLCB3aWR0aDogMCB9LCAvLyDnu5jliLblrr3pq5hcbiAgICByZW5kZXJTdHlsZTogeyB4OiAwLCB5OiAwLCBjb250ZW50WDogMCwgY29udGVudFk6IDAgfSwgLy8g57uY5Yi25L2N572uXG4gICAgY2hpbGRyZW46IG5vZGUuY2hpbGRyZW4gfHwgW10sXG4gICAgbGluZXM6IFtdLFxuICAgIHBhcmVudDogbnVsbCxcbiAgICBwcmU6IG51bGwsXG4gICAgbmV4dDogbnVsbFxuICB9O1xuICByZXR1cm4gT2JqZWN0LmFzc2lnbihub2RlLCBfbm9kZSk7XG59O1xuXG4vKipcbiAqIOaMgui9veWFhOW8n+iKgueCueOAgeeItuiKgueCuVxuICogQHBhcmFtIHtWbm9kZX0gZWxcbiAqL1xuXG5leHBvcnQgY29uc3QgY29ubmVjdENoaWxkcmVuID0gKGVsLCBpc1Jvb3QgPSBmYWxzZSkgPT4ge1xuICAvLyBkZWJ1Z2dlclxuICBpZiAoaGFzQ2hpbGRyZW4oZWwpKSB7XG4gICAgX2dldENoaWxkcmVuKGVsKS5mb3JFYWNoKChjaGlsZCwgaW5kZXgpID0+IHtcbiAgICAgIGlmIChjaGlsZC5hdHRyaWJ1dGVzWydwLWlmJ10gPT09ICdmYWxzZScpIHtcbiAgICAgICAgLy8gY29uc29sZS5sb2coZWwpXG4gICAgICAgIC8vIF9kZWxOb2RlKGVsLCBjaGlsZClcbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIC8vIOe7p+aJv+eItuiKgueCueagt+W8j1xuICAgICAgICBjaGlsZC5jc3MgPSBfaW5oZXJpdFN0eWxlKGVsLCBjaGlsZCk7XG4gICAgICAgIC8vIGRlYnVnZ2VyXG4gICAgICAgIC8vIOiuvue9rnBhcmVudFxuICAgICAgICAvLyBkZWJ1Z2dlclxuICAgICAgICBfc2V0UGFyZW50KGNoaWxkLCBlbCwgaXNSb290KTtcbiAgICAgICAgaXNSb290ID0gZmFsc2U7XG4gICAgICAgIC8vIOiuvue9ruS6huS4iuS4gOS4quWFhOW8n+iKgueCuVxuICAgICAgICBfc2V0U2libGluZyhjaGlsZCwgX2dldENoaWxkcmVuKGVsKVtpbmRleCAtIDFdLCBfZ2V0Q2hpbGRyZW4oZWwpW2luZGV4ICsgMV0pO1xuICAgICAgICBjb25uZWN0Q2hpbGRyZW4oY2hpbGQsIGlzUm9vdCk7XG4gICAgICB9XG4gICAgfSk7XG4gIH1cbn07XG5cbi8qKlxuICog5Yib5bu66Jma5ouf6IqC54K55qCRXG4gKiBAcGFyYW0ge29iamVjdH0ganNvbk9iaiBqc29u5paH5Lu25Lit55qE6YWN572uXG4gKi9cbmV4cG9ydCBjb25zdCBpbml0Vm5vZGVUcmVlID0gKG5vZGUpID0+IHtcbiAgY29uc3Qgbm9kZXMgPSBbXTtcbiAgaWYgKG5vZGUgIT0gbnVsbCkge1xuICAgIGNvbnN0IHF1ZXVlID0gW107XG4gICAgcXVldWUudW5zaGlmdChub2RlKTtcbiAgICB3aGlsZSAocXVldWUubGVuZ3RoICE9IDApIHtcbiAgICAgIGxldCBpdGVtID0gcXVldWUuc2hpZnQoKTtcbiAgICAgIGl0ZW0gPSBjcmVhdGVWbm9kZShpdGVtKTtcbiAgICAgIG5vZGVzLnB1c2goaXRlbSk7XG4gICAgICBjb25zdCBjaGlsZHJlbiA9IGl0ZW0uY2hpbGRyZW4gfHwgW107XG4gICAgICBmb3IgKGxldCBpID0gMDsgaSA8IGNoaWxkcmVuLmxlbmd0aDsgaSsrKSBxdWV1ZS5wdXNoKGNoaWxkcmVuW2ldKTtcbiAgICB9XG4gIH1cbiAgLy8g5YWz6IGU54i25a2Q5YWE5byf6IqC54K55ZKM5qC35byP57un5om/XG4gIGNvbm5lY3RDaGlsZHJlbihub2RlKTtcbiAgY29uc29sZS5sb2coJ3Zub2RlVHJlZSBpczogJywgbm9kZSk7XG4gIHJldHVybiBub2RlO1xufTtcblxuLy8g5piv5ZCm5pyJ5a2Q6IqC54K5XG5mdW5jdGlvbiBoYXNDaGlsZHJlbih2bm9kZSkge1xuICByZXR1cm4gISEoQXJyYXkuaXNBcnJheSh2bm9kZS5jaGlsZHJlbikgJiYgdm5vZGUuY2hpbGRyZW4ubGVuZ3RoKTtcbn1cblxuLy8g6L+U5Zue5a2Q6IqC54K5XG5mdW5jdGlvbiBfZ2V0Q2hpbGRyZW4oZWwpIHtcbiAgcmV0dXJuIGhhc0NoaWxkcmVuKGVsKSA/IGVsLmNoaWxkcmVuIDogW107XG59XG5mdW5jdGlvbiBfZGVsTm9kZShwYXJlbnQsIGNoaWxkKSB7XG4gIC8vIGNvbnN0IHBhcmVudCA9IGVsLnBhcmVudFxuICBjb25zdCBpZHggPSBwYXJlbnQuY2hpbGRyZW4uZmluZEluZGV4KCh4KSA9PiB7IHJldHVybiB4ID09PSBjaGlsZDsgfSk7XG4gIHBhcmVudC5jaGlsZHJlbi5zcGxpY2UoaWR4LCAxKTtcbn1cblxuZnVuY3Rpb24gX3NldFBhcmVudChjdXJyLCBlbGVtZW50LCBpc1Jvb3QpIHtcbiAgY3Vyci5wYXJlbnQgPSBpc1Jvb3QgPyBudWxsIDogZWxlbWVudDtcbiAgLy8gdGhpcy5yb290ID0gZWxlbWVudC5yb290XG59XG5cbmZ1bmN0aW9uIF9zZXRTaWJsaW5nKGN1cnIsIHByZSwgbmV4dCkge1xuICBjdXJyLnByZSA9IHByZSB8fCBudWxsO1xuICBjdXJyLm5leHQgPSBuZXh0IHx8IG51bGw7XG59XG5cbi8qKlxuICog57un5om/54i26IqC54K55qC35byPXG4gKiBAcGFyYW0ge3Zub2RlfSBwYXJlbnRcbiAqIEBwYXJhbSB7dm5vZGV9IGNoaWxkXG4gKi9cbmZ1bmN0aW9uIF9pbmhlcml0U3R5bGUocGFyZW50LCBjaGlsZCkge1xuICBjb25zdCBjb3B5UGFyZW50Q3NzID0gSlNPTi5wYXJzZShKU09OLnN0cmluZ2lmeShwYXJlbnQuY3NzKSk7XG4gIC8vIGRlYnVnZ2VyXG4gIGNvbnN0IG5vdEluaGVyaXRTdHlsZU9mUGFyZW50ID0gWydoZWlnaHQnLCAnd2lkdGgnLCAnbWFyZ2luJywgJ3BhZGRpbmcnLCAnbWFyZ2luVG9wJywgJ21hcmdpbkxlZnQnLCAnbWFyZ2luQm90dG9tJywgJ21hcmdpblJpZ2h0JywgJ3BhZGRpbmdMZWZ0JywgJ3BhZGRpbmdSaWdodCcsICdwYWRkaW5nVG9wJywgJ3BhZGRpbmdCb3R0b20nXTtcbiAgZm9yIChjb25zdCBjc3NOYW1lIG9mIE9iamVjdC5rZXlzKGNvcHlQYXJlbnRDc3MpKSB7XG4gICAgaWYgKCFub3RJbmhlcml0U3R5bGVPZlBhcmVudC5pbmNsdWRlcyhjc3NOYW1lKSkgY29udGludWU7XG4gICAgZGVsZXRlIGNvcHlQYXJlbnRDc3NbY3NzTmFtZV07XG4gIH1cbiAgY29uc3Qgc3R5bGUgPSB7IC4uLmNvcHlQYXJlbnRDc3MsIC4uLmNoaWxkLmNzcyB9O1xuICByZXR1cm4gc3R5bGU7XG59XG5cbi8qKlxuICog5Zyo6L2s5o2i5oiQbm9kZeeahOagkee6p+e7k+aehOS4rea3u+WKoGNzcy90ZXh0L3VybCwg5a+56b2Q5riy5p+T5omA6ZyA5bGe5oCnXG4gKiBAcGFyYW0ge29iamVjdH0geG9tXG4gKiBAcGFyYW0ge29iamVjdH0gc3R5bGVcbiAqL1xuZnVuY3Rpb24gX2Zvcm1hdFZub2RlMih4b20sIHN0eWxlKSB7XG4gIGRlZXBGaXJzdFNlYXJjaCh4b20sIChub2RlKSA9PiB7XG4gICAgLy8gY29uc29sZS5sb2coJ15eICcsIG5vZGUpXG4gICAgLy8g5qC35byPXG4gICAgaWYobm9kZS5hdHRyaWJ1dGVzLmNsYXNzKXtcbiAgICAgIGNvbnN0IGNsYXNzTmFtZXMgPSBub2RlLmF0dHJpYnV0ZXMuY2xhc3Muc3BsaXQoJyAnKTtcbiAgICAgIGNvbnN0IGNzcyA9IGNsYXNzTmFtZXMucmVkdWNlKChwcmUsIG5leHQpID0+IHtcbiAgICAgICAgcmV0dXJuIHsgLi4ucHJlLCAuLi5zdHlsZVtuZXh0XSB9O1xuICAgICAgfSwge30pO1xuICAgICAgbm9kZS5jc3MgPSBjc3M7XG4gICAgfVxuICAgIC8vIOWbvueJh1xuICAgIGlmIChub2RlLmF0dHJpYnV0ZXMuY2xhc3MgPT09ICdpbWcnICYmIG5vZGUuYXR0cmlidXRlcy5zcmMpIHtcbiAgICAgIG5vZGUudXJsID0gbm9kZS5hdHRyaWJ1dGVzLnNyYztcbiAgICB9XG4gICAgLy8g5paH5a2XXG4gICAgaWYgKG5vZGUubmFtZSA9PT0gJ3RleHQnKSB7XG4gICAgICBub2RlLnRleHQgPSBub2RlLmNvbnRlbnQ7XG4gICAgfVxuICAgIG5vZGUudHlwZSA9IG5vZGUubmFtZTtcblxuICAgIGNyZWF0ZVZub2RlKG5vZGUpO1xuICB9KTtcbiAgLy8g5YWz6IGU54i25a2Q5YWE5byf6IqC54K55ZKM5qC35byP57un5om/XG4gIGNvbm5lY3RDaGlsZHJlbih4b20pO1xufVxuXG5mdW5jdGlvbiBfZm9ybWF0Vm5vZGUoeG9tLCBzdHlsZSkge1xuICBkZWVwRmlyc3RTZWFyY2goeG9tLCAobm9kZSkgPT4ge1xuICAgIC8vIGNvbnNvbGUubG9nKCdeXiAnLCBub2RlKVxuICAgIC8vIOagt+W8j1xuICAgIGlmKG5vZGUuYXR0cmlidXRlcy5jbGFzcyl7XG4gICAgICBjb25zdCBjbGFzc05hbWVzID0gbm9kZS5hdHRyaWJ1dGVzLmNsYXNzLnNwbGl0KCcgJyk7XG4gICAgICBjb25zdCBjc3MgPSBjbGFzc05hbWVzLnJlZHVjZSgocHJlLCBuZXh0KSA9PiB7XG4gICAgICAgIHJldHVybiB7IC4uLnByZSwgLi4uc3R5bGVbbmV4dF0gfTtcbiAgICAgIH0sIHt9KTtcbiAgICAgIG5vZGUuY3NzID0gY3NzO1xuICAgIH1cbiAgICAvLyDlm77niYdcbiAgICBpZiAobm9kZS5hdHRyaWJ1dGVzLmNsYXNzID09PSAnaW1nJyAmJiBub2RlLmF0dHJpYnV0ZXMuc3JjKSB7XG4gICAgICBub2RlLnVybCA9IG5vZGUuYXR0cmlidXRlcy5zcmM7XG4gICAgfVxuICAgIC8vIOaWh+Wtl1xuICAgIGlmIChub2RlLm5hbWUgPT09ICd0ZXh0Jykge1xuICAgICAgbm9kZS50ZXh0ID0gbm9kZS5jaGlsZHJlblswXTtcbiAgICAgIG5vZGUuY2hpbGRyZW4ubGVuZ3RoPTBcbiAgICB9XG4gICAgbm9kZS50eXBlID0gbm9kZS5uYW1lO1xuXG4gICAgY3JlYXRlVm5vZGUobm9kZSk7XG4gIH0pO1xuICAvLyDlhbPogZTniLblrZDlhYTlvJ/oioLngrnlkozmoLflvI/nu6fmib9cbiAgY29ubmVjdENoaWxkcmVuKHhvbSk7XG59XG5cbi8qKlxuICog5LuO5qih5p2/6L2s5o2i5oiQdm5vZGXlr7nosaHmoJFcbiAqIEBwYXJhbSB7c3RyaW5nfSB3eG1sIGh0bWzmqKHmnb9cbiAqIEBwYXJhbSB7b2JqZWN0fSBzdHlsZSBjc3Plr7nosaFcbiAqL1xuZXhwb3J0IGNvbnN0IHhtbFRvVm5vZGUgPSAod3htbCwgc3R5bGUpID0+IHtcbiAgLy8gY29uc3QgeyByb290OiB4b20gfSA9IHhtbFBhcnNlKHd4bWwpO1xuICBjb25zdCB4b20gPSB3eG1sXG4gIC8vIGNvbnNvbGUubG9nKCcjIyAnLCB4b20pXG4gIF9mb3JtYXRWbm9kZSh4b20sIHN0eWxlKTtcbiAgcmV0dXJuIHhvbTtcbn07XG4iXX0=