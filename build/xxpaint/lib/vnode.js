"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.xmlToVnode = exports.initVnodeTree = exports.connectChildren = exports.createVnode = void 0;
var tslib_1 = require("tslib");
var util_1 = require("./util");
var createVnode = function (node) {
    var _node = {
        text: node.text || '',
        url: node.url || '',
        type: node.type,
        css: node.css || {},
        islines: false,
        renderStyle: { x: 0, y: 0, contentX: 0, contentY: 0 },
        children: node.children || [],
        lines: [],
        parent: null,
        pre: null,
        next: null
    };
    return Object.assign(node, _node);
};
exports.createVnode = createVnode;
var connectChildren = function (el, isRoot) {
    if (isRoot === void 0) { isRoot = false; }
    if (hasChildren(el)) {
        _getChildren(el).forEach(function (child, index) {
            if (child.attributes['p-if'] === 'false') {
            }
            else {
                child.css = _inheritStyle(el, child);
                _setParent(child, el, isRoot);
                isRoot = false;
                _setSibling(child, _getChildren(el)[index - 1], _getChildren(el)[index + 1]);
                exports.connectChildren(child, isRoot);
            }
        });
    }
};
exports.connectChildren = connectChildren;
var initVnodeTree = function (node) {
    var nodes = [];
    if (node != null) {
        var queue = [];
        queue.unshift(node);
        while (queue.length != 0) {
            var item = queue.shift();
            item = exports.createVnode(item);
            nodes.push(item);
            var children = item.children || [];
            for (var i = 0; i < children.length; i++)
                queue.push(children[i]);
        }
    }
    exports.connectChildren(node);
    console.log('vnodeTree is: ', node);
    return node;
};
exports.initVnodeTree = initVnodeTree;
function hasChildren(vnode) {
    return !!(Array.isArray(vnode.children) && vnode.children.length);
}
function _getChildren(el) {
    return hasChildren(el) ? el.children : [];
}
function _delNode(parent, child) {
    var idx = parent.children.findIndex(function (x) { return x === child; });
    parent.children.splice(idx, 1);
}
function _setParent(curr, element, isRoot) {
    curr.parent = isRoot ? null : element;
}
function _setSibling(curr, pre, next) {
    curr.pre = pre || null;
    curr.next = next || null;
}
function _inheritStyle(parent, child) {
    var copyParentCss = JSON.parse(JSON.stringify(parent.css));
    var notInheritStyleOfParent = ['height', 'width', 'margin', 'padding', 'marginTop', 'marginLeft', 'marginBottom', 'marginRight', 'paddingLeft', 'paddingRight', 'paddingTop', 'paddingBottom'];
    for (var _i = 0, _a = Object.keys(copyParentCss); _i < _a.length; _i++) {
        var cssName = _a[_i];
        if (!notInheritStyleOfParent.includes(cssName))
            continue;
        delete copyParentCss[cssName];
    }
    var style = tslib_1.__assign(tslib_1.__assign({}, copyParentCss), child.css);
    return style;
}
function _formatVnode2(xom, style) {
    util_1.deepFirstSearch(xom, function (node) {
        if (node.attributes.class) {
            var classNames = node.attributes.class.split(' ');
            var css = classNames.reduce(function (pre, next) {
                return tslib_1.__assign(tslib_1.__assign({}, pre), style[next]);
            }, {});
            node.css = css;
        }
        if (node.attributes.class === 'img' && node.attributes.src) {
            node.url = node.attributes.src;
        }
        if (node.name === 'text') {
            node.text = node.content;
        }
        node.type = node.name;
        exports.createVnode(node);
    });
    exports.connectChildren(xom);
}
function _formatVnode(xom, style) {
    util_1.deepFirstSearch(xom, function (node) {
        if (node.attributes.class) {
            var classNames = node.attributes.class.split(' ');
            var css = classNames.reduce(function (pre, next) {
                return tslib_1.__assign(tslib_1.__assign({}, pre), style[next]);
            }, {});
            node.css = css;
        }
        if (node.attributes.class === 'img' && node.attributes.src) {
            node.url = node.attributes.src;
        }
        if (node.name === 'text') {
            node.text = node.children[0];
            node.children.length = 0;
        }
        node.type = node.name;
        exports.createVnode(node);
    });
    exports.connectChildren(xom);
}
var xmlToVnode = function (wxml, style) {
    var xom = wxml;
    _formatVnode(xom, style);
    return xom;
};
exports.xmlToVnode = xmlToVnode;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoidm5vZGUuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi9zcmMveHhwYWludC9saWIvdm5vZGUudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7OztBQUVBLCtCQUF5QztBQU9sQyxJQUFNLFdBQVcsR0FBRyxVQUFDLElBQUk7SUFDOUIsSUFBTSxLQUFLLEdBQUc7UUFFWixJQUFJLEVBQUUsSUFBSSxDQUFDLElBQUksSUFBSSxFQUFFO1FBQ3JCLEdBQUcsRUFBRSxJQUFJLENBQUMsR0FBRyxJQUFJLEVBQUU7UUFDbkIsSUFBSSxFQUFFLElBQUksQ0FBQyxJQUFJO1FBQ2YsR0FBRyxFQUFFLElBQUksQ0FBQyxHQUFHLElBQUksRUFBRTtRQUNuQixPQUFPLEVBQUUsS0FBSztRQUVkLFdBQVcsRUFBRSxFQUFFLENBQUMsRUFBRSxDQUFDLEVBQUUsQ0FBQyxFQUFFLENBQUMsRUFBRSxRQUFRLEVBQUUsQ0FBQyxFQUFFLFFBQVEsRUFBRSxDQUFDLEVBQUU7UUFDckQsUUFBUSxFQUFFLElBQUksQ0FBQyxRQUFRLElBQUksRUFBRTtRQUM3QixLQUFLLEVBQUUsRUFBRTtRQUNULE1BQU0sRUFBRSxJQUFJO1FBQ1osR0FBRyxFQUFFLElBQUk7UUFDVCxJQUFJLEVBQUUsSUFBSTtLQUNYLENBQUM7SUFDRixPQUFPLE1BQU0sQ0FBQyxNQUFNLENBQUMsSUFBSSxFQUFFLEtBQUssQ0FBQyxDQUFDO0FBQ3BDLENBQUMsQ0FBQztBQWpCVyxRQUFBLFdBQVcsZUFpQnRCO0FBT0ssSUFBTSxlQUFlLEdBQUcsVUFBQyxFQUFFLEVBQUUsTUFBYztJQUFkLHVCQUFBLEVBQUEsY0FBYztJQUVoRCxJQUFJLFdBQVcsQ0FBQyxFQUFFLENBQUMsRUFBRTtRQUNuQixZQUFZLENBQUMsRUFBRSxDQUFDLENBQUMsT0FBTyxDQUFDLFVBQUMsS0FBSyxFQUFFLEtBQUs7WUFDcEMsSUFBSSxLQUFLLENBQUMsVUFBVSxDQUFDLE1BQU0sQ0FBQyxLQUFLLE9BQU8sRUFBRTth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QzFELElBQUksQ0FBQyxHQUFHLEdBQUcsSUFBSSxDQUFDLFVBQVUsQ0FBQyxHQUFHLENBQUM7U0FDaEM7UUFFRCxJQUFJLElBQUksQ0FBQyxJQUFJLEtBQUssTUFBTSxFQUFFO1lBQ3hCLElBQUksQ0FBQyxJQUFJLEdBQUcsSUFBSSxDQUFDLFFBQVEsQ0FBQyxDQUFDLENBQUMsQ0FBQztZQUM3QixJQUFJLENBQUMsUUFBUSxDQUFDLE1BQU0sR0FBQyxDQUFDLENBQUE7U0FDdkI7UUFDRCxJQUFJLENBQUMsSUFBSSxHQUFHLElBQUksQ0FBQyxJQUFJLENBQUM7UUFFdEIsbUJBQVcsQ0FBQyxJQUFJLENBQUMsQ0FBQztJQUNwQixDQUFDLENBQUMsQ0FBQztJQUVILHVCQUFlLENBQUMsR0FBRyxDQUFDLENBQUM7QUFDdkIsQ0FBQztBQU9NLElBQU0sVUFBVSxHQUFHLFVBQUMsSUFBSSxFQUFFLEtBQUs7SUFFcEMsSUFBTSxHQUFHLEdBQUcsSUFBSSxDQUFBO0lBRWhCLFlBQVksQ0FBQyxHQUFHLEVBQUUsS0FBSyxDQUFDLENBQUM7SUFDekIsT0FBTyxHQUFHLENBQUM7QUFDYixDQUFDLENBQUM7QUFOVyxRQUFBLFVBQVUsY0FNckIiLCJzb3VyY2VzQ29udGVudCI6WyIvKiBlc2xpbnQtZGlzYWJsZSAqL1xuLy8gaW1wb3J0IHhtbFBhcnNlIGZyb20gJy4veG1sLXBhcnNlcic7XG5pbXBvcnQgeyBkZWVwRmlyc3RTZWFyY2ggfSBmcm9tICcuL3V0aWwnO1xuLy8gaW1wb3J0IHt3eG1sLHN0eWxlfSBmcm9tICcuL2h0bWwnXG5cbi8qKlxuICog5Yib5bu66Jma5ouf6IqC54K5XG4gKiBAcGFyYW0ge29iamVjdH0gbm9kZSDphY3nva7mlofku7bkuK3nmoToioLngrlcbiAqL1xuZXhwb3J0IGNvbnN0IGNyZWF0ZVZub2RlID0gKG5vZGUpID0+IHtcbiAgY29uc3QgX25vZGUgPSB7XG4gICAgLy8gaWQ6XG4gICAgdGV4dDogbm9kZS50ZXh0IHx8ICcnLCAvLyDmlofmnKznsbvlnovmiY3mnIlcbiAgICB1cmw6IG5vZGUudXJsIHx8ICcnLCAvLyDlm77niYfnsbvlnovmiY3mnIlcbiAgICB0eXBlOiBub2RlLnR5cGUsXG4gICAgY3NzOiBub2RlLmNzcyB8fCB7fSxcbiAgICBpc2xpbmVzOiBmYWxzZSwgLy8g5piv5ZCm5o2i6KGMXG4gICAgLy8gbGF5b3V0U2l6ZTogeyBoZWlnaHQ6IDAsIHdpZHRoOiAwIH0sIC8vIOe7mOWItuWuvemrmFxuICAgIHJlbmRlclN0eWxlOiB7IHg6IDAsIHk6IDAsIGNvbnRlbnRYOiAwLCBjb250ZW50WTogMCB9LCAvLyDnu5jliLbkvY3nva5cbiAgICBjaGlsZHJlbjogbm9kZS5jaGlsZHJlbiB8fCBbXSxcbiAgICBsaW5lczogW10sXG4gICAgcGFyZW50OiBudWxsLFxuICAgIHByZTogbnVsbCxcbiAgICBuZXh0OiBudWxsXG4gIH07XG4gIHJldHVybiBPYmplY3QuYXNzaWduKG5vZGUsIF9ub2RlKTtcbn07XG5cbi8qKlxuICog5oyC6L295YWE5byf6IqC54K544CB54i26IqC54K5XG4gKiBAcGFyYW0ge1Zub2RlfSBlbFxuICovXG5cbmV4cG9ydCBjb25zdCBjb25uZWN0Q2hpbGRyZW4gPSAoZWwsIGlzUm9vdCA9IGZhbHNlKSA9PiB7XG4gIC8vIGRlYnVnZ2VyXG4gIGlmIChoYXNDaGlsZHJlbihlbCkpIHtcbiAgICBfZ2V0Q2hpbGRyZW4oZWwpLmZvckVhY2goKGNoaWxkLCBpbmRleCkgPT4ge1xuICAgICAgaWYgKGNoaWxkLmF0dHJpYnV0ZXNbJ3AtaWYnXSA9PT0gJ2ZhbHNlJykge1xuICAgICAgICAvLyBjb25zb2xlLmxvZyhlbClcbiAgICAgICAgLy8gX2RlbE5vZGUoZWwsIGNoaWxkKVxuICAgICAgfSBlbHNlIHtcbiAgICAgICAgLy8g57un5om/54i26IqC54K55qC35byPXG4gICAgICAgIGNoaWxkLmNzcyA9IF9pbmhlcml0U3R5bGUoZWwsIGNoaWxkKTtcbiAgICAgICAgLy8gZGVidWdnZXJcbiAgICAgICAgLy8g6K6+572ucGFyZW50XG4gICAgICAgIC8vIGRlYnVnZ2VyXG4gICAgICAgIF9zZXRQYXJlbnQoY2hpbGQsIGVsLCBpc1Jvb3QpO1xuICAgICAgICBpc1Jvb3QgPSBmYWxzZTtcbiAgICAgICAgLy8g6K6+572u5LqG5LiK5LiA5Liq5YWE5byf6IqC54K5XG4gICAgICAgIF9zZXRTaWJsaW5nKGNoaWxkLCBfZ2V0Q2hpbGRyZW4oZWwpW2luZGV4IC0gMV0sIF9nZXRDaGlsZHJlbihlbClbaW5kZXggKyAxXSk7XG4gICAgICAgIGNvbm5lY3RDaGlsZHJlbihjaGlsZCwgaXNSb290KTtcbiAgICAgIH1cbiAgICB9KTtcbiAgfVxufTtcblxuLyoqXG4gKiDliJvlu7romZrmi5/oioLngrnmoJFcbiAqIEBwYXJhbSB7b2JqZWN0fSBqc29uT2JqIGpzb27mlofku7bkuK3nmoTphY3nva5cbiAqL1xuZXhwb3J0IGNvbnN0IGluaXRWbm9kZVRyZWUgPSAobm9kZSkgPT4ge1xuICBjb25zdCBub2RlcyA9IFtdO1xuICBpZiAobm9kZSAhPSBudWxsKSB7XG4gICAgY29uc3QgcXVldWUgPSBbXTtcbiAgICBxdWV1ZS51bnNoaWZ0KG5vZGUpO1xuICAgIHdoaWxlIChxdWV1ZS5sZW5ndGggIT0gMCkge1xuICAgICAgbGV0IGl0ZW0gPSBxdWV1ZS5zaGlmdCgpO1xuICAgICAgaXRlbSA9IGNyZWF0ZVZub2RlKGl0ZW0pO1xuICAgICAgbm9kZXMucHVzaChpdGVtKTtcbiAgICAgIGNvbnN0IGNoaWxkcmVuID0gaXRlbS5jaGlsZHJlbiB8fCBbXTtcbiAgICAgIGZvciAobGV0IGkgPSAwOyBpIDwgY2hpbGRyZW4ubGVuZ3RoOyBpKyspIHF1ZXVlLnB1c2goY2hpbGRyZW5baV0pO1xuICAgIH1cbiAgfVxuICAvLyDlhbPogZTniLblrZDlhYTlvJ/oioLngrnlkozmoLflvI/nu6fmib9cbiAgY29ubmVjdENoaWxkcmVuKG5vZGUpO1xuICBjb25zb2xlLmxvZygndm5vZGVUcmVlIGlzOiAnLCBub2RlKTtcbiAgcmV0dXJuIG5vZGU7XG59O1xuXG4vLyDmmK/lkKbmnInlrZDoioLngrlcbmZ1bmN0aW9uIGhhc0NoaWxkcmVuKHZub2RlKSB7XG4gIHJldHVybiAhIShBcnJheS5pc0FycmF5KHZub2RlLmNoaWxkcmVuKSAmJiB2bm9kZS5jaGlsZHJlbi5sZW5ndGgpO1xufVxuXG4vLyDov5Tlm57lrZDoioLngrlcbmZ1bmN0aW9uIF9nZXRDaGlsZHJlbihlbCkge1xuICByZXR1cm4gaGFzQ2hpbGRyZW4oZWwpID8gZWwuY2hpbGRyZW4gOiBbXTtcbn1cbmZ1bmN0aW9uIF9kZWxOb2RlKHBhcmVudCwgY2hpbGQpIHtcbiAgLy8gY29uc3QgcGFyZW50ID0gZWwucGFyZW50XG4gIGNvbnN0IGlkeCA9IHBhcmVudC5jaGlsZHJlbi5maW5kSW5kZXgoKHgpID0+IHsgcmV0dXJuIHggPT09IGNoaWxkOyB9KTtcbiAgcGFyZW50LmNoaWxkcmVuLnNwbGljZShpZHgsIDEpO1xufVxuXG5mdW5jdGlvbiBfc2V0UGFyZW50KGN1cnIsIGVsZW1lbnQsIGlzUm9vdCkge1xuICBjdXJyLnBhcmVudCA9IGlzUm9vdCA/IG51bGwgOiBlbGVtZW50O1xuICAvLyB0aGlzLnJvb3QgPSBlbGVtZW50LnJvb3Rcbn1cblxuZnVuY3Rpb24gX3NldFNpYmxpbmcoY3VyciwgcHJlLCBuZXh0KSB7XG4gIGN1cnIucHJlID0gcHJlIHx8IG51bGw7XG4gIGN1cnIubmV4dCA9IG5leHQgfHwgbnVsbDtcbn1cblxuLyoqXG4gKiDnu6fmib/niLboioLngrnmoLflvI9cbiAqIEBwYXJhbSB7dm5vZGV9IHBhcmVudFxuICogQHBhcmFtIHt2bm9kZX0gY2hpbGRcbiAqL1xuZnVuY3Rpb24gX2luaGVyaXRTdHlsZShwYXJlbnQsIGNoaWxkKSB7XG4gIGNvbnN0IGNvcHlQYXJlbnRDc3MgPSBKU09OLnBhcnNlKEpTT04uc3RyaW5naWZ5KHBhcmVudC5jc3MpKTtcbiAgLy8gZGVidWdnZXJcbiAgY29uc3Qgbm90SW5oZXJpdFN0eWxlT2ZQYXJlbnQgPSBbJ2hlaWdodCcsICd3aWR0aCcsICdtYXJnaW4nLCAncGFkZGluZycsICdtYXJnaW5Ub3AnLCAnbWFyZ2luTGVmdCcsICdtYXJnaW5Cb3R0b20nLCAnbWFyZ2luUmlnaHQnLCAncGFkZGluZ0xlZnQnLCAncGFkZGluZ1JpZ2h0JywgJ3BhZGRpbmdUb3AnLCAncGFkZGluZ0JvdHRvbSddO1xuICBmb3IgKGNvbnN0IGNzc05hbWUgb2YgT2JqZWN0LmtleXMoY29weVBhcmVudENzcykpIHtcbiAgICBpZiAoIW5vdEluaGVyaXRTdHlsZU9mUGFyZW50LmluY2x1ZGVzKGNzc05hbWUpKSBjb250aW51ZTtcbiAgICBkZWxldGUgY29weVBhcmVudENzc1tjc3NOYW1lXTtcbiAgfVxuICBjb25zdCBzdHlsZSA9IHsgLi4uY29weVBhcmVudENzcywgLi4uY2hpbGQuY3NzIH07XG4gIHJldHVybiBzdHlsZTtcbn1cblxuLyoqXG4gKiDlnKjovazmjaLmiJBub2Rl55qE5qCR57qn57uT5p6E5Lit5re75YqgY3NzL3RleHQvdXJsLCDlr7npvZDmuLLmn5PmiYDpnIDlsZ7mgKdcbiAqIEBwYXJhbSB7b2JqZWN0fSB4b21cbiAqIEBwYXJhbSB7b2JqZWN0fSBzdHlsZVxuICovXG5mdW5jdGlvbiBfZm9ybWF0Vm5vZGUyKHhvbSwgc3R5bGUpIHtcbiAgZGVlcEZpcnN0U2VhcmNoKHhvbSwgKG5vZGUpID0+IHtcbiAgICAvLyBjb25zb2xlLmxvZygnXl4gJywgbm9kZSlcbiAgICAvLyDmoLflvI9cbiAgICBpZihub2RlLmF0dHJpYnV0ZXMuY2xhc3Mpe1xuICAgICAgY29uc3QgY2xhc3NOYW1lcyA9IG5vZGUuYXR0cmlidXRlcy5jbGFzcy5zcGxpdCgnICcpO1xuICAgICAgY29uc3QgY3NzID0gY2xhc3NOYW1lcy5yZWR1Y2UoKHByZSwgbmV4dCkgPT4ge1xuICAgICAgICByZXR1cm4geyAuLi5wcmUsIC4uLnN0eWxlW25leHRdIH07XG4gICAgICB9LCB7fSk7XG4gICAgICBub2RlLmNzcyA9IGNzcztcbiAgICB9XG4gICAgLy8g5Zu+54mHXG4gICAgaWYgKG5vZGUuYXR0cmlidXRlcy5jbGFzcyA9PT0gJ2ltZycgJiYgbm9kZS5hdHRyaWJ1dGVzLnNyYykge1xuICAgICAgbm9kZS51cmwgPSBub2RlLmF0dHJpYnV0ZXMuc3JjO1xuICAgIH1cbiAgICAvLyDmloflrZdcbiAgICBpZiAobm9kZS5uYW1lID09PSAndGV4dCcpIHtcbiAgICAgIG5vZGUudGV4dCA9IG5vZGUuY29udGVudDtcbiAgICB9XG4gICAgbm9kZS50eXBlID0gbm9kZS5uYW1lO1xuXG4gICAgY3JlYXRlVm5vZGUobm9kZSk7XG4gIH0pO1xuICAvLyDlhbPogZTniLblrZDlhYTlvJ/oioLngrnlkozmoLflvI/nu6fmib9cbiAgY29ubmVjdENoaWxkcmVuKHhvbSk7XG59XG5cbmZ1bmN0aW9uIF9mb3JtYXRWbm9kZSh4b20sIHN0eWxlKSB7XG4gIGRlZXBGaXJzdFNlYXJjaCh4b20sIChub2RlKSA9PiB7XG4gICAgLy8gY29uc29sZS5sb2coJ15eICcsIG5vZGUpXG4gICAgLy8g5qC35byPXG4gICAgaWYobm9kZS5hdHRyaWJ1dGVzLmNsYXNzKXtcbiAgICAgIGNvbnN0IGNsYXNzTmFtZXMgPSBub2RlLmF0dHJpYnV0ZXMuY2xhc3Muc3BsaXQoJyAnKTtcbiAgICAgIGNvbnN0IGNzcyA9IGNsYXNzTmFtZXMucmVkdWNlKChwcmUsIG5leHQpID0+IHtcbiAgICAgICAgcmV0dXJuIHsgLi4ucHJlLCAuLi5zdHlsZVtuZXh0XSB9O1xuICAgICAgfSwge30pO1xuICAgICAgbm9kZS5jc3MgPSBjc3M7XG4gICAgfVxuICAgIC8vIOWbvueJh1xuICAgIGlmIChub2RlLmF0dHJpYnV0ZXMuY2xhc3MgPT09ICdpbWcnICYmIG5vZGUuYXR0cmlidXRlcy5zcmMpIHtcbiAgICAgIG5vZGUudXJsID0gbm9kZS5hdHRyaWJ1dGVzLnNyYztcbiAgICB9XG4gICAgLy8g5paH5a2XXG4gICAgaWYgKG5vZGUubmFtZSA9PT0gJ3RleHQnKSB7XG4gICAgICBub2RlLnRleHQgPSBub2RlLmNoaWxkcmVuWzBdO1xuICAgICAgbm9kZS5jaGlsZHJlbi5sZW5ndGg9MFxuICAgIH1cbiAgICBub2RlLnR5cGUgPSBub2RlLm5hbWU7XG5cbiAgICBjcmVhdGVWbm9kZShub2RlKTtcbiAgfSk7XG4gIC8vIOWFs+iBlOeItuWtkOWFhOW8n+iKgueCueWSjOagt+W8j+e7p+aJv1xuICBjb25uZWN0Q2hpbGRyZW4oeG9tKTtcbn1cblxuLyoqXG4gKiDku47mqKHmnb/ovazmjaLmiJB2bm9kZeWvueixoeagkVxuICogQHBhcmFtIHtzdHJpbmd9IHd4bWwgaHRtbOaooeadv1xuICogQHBhcmFtIHtvYmplY3R9IHN0eWxlIGNzc+WvueixoVxuICovXG5leHBvcnQgY29uc3QgeG1sVG9Wbm9kZSA9ICh3eG1sLCBzdHlsZSkgPT4ge1xuICAvLyBjb25zdCB7IHJvb3Q6IHhvbSB9ID0geG1sUGFyc2Uod3htbCk7XG4gIGNvbnN0IHhvbSA9IHd4bWxcbiAgLy8gY29uc29sZS5sb2coJyMjICcsIHhvbSlcbiAgX2Zvcm1hdFZub2RlKHhvbSwgc3R5bGUpO1xuICByZXR1cm4geG9tO1xufTtcbiJdfQ==