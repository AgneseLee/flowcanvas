"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
var util = require('./util');
var SAVED_FILES_KEY = 'savedFiles';
var KEY_TOTAL_SIZE = 'totalSize';
var KEY_PATH = 'path';
var KEY_TIME = 'time';
var KEY_SIZE = 'size';
var MAX_SPACE_IN_B = 6 * 1024 * 1024;
var savedFiles = {};
var Dowloader = (function () {
    function Dowloader() {
        wx.getStorage({
            key: SAVED_FILES_KEY,
            success: function (res) {
                if (res.data) {
                    savedFiles = res.data;
                }
            },
        });
    }
    Dowloader.prototype.download = function (url) {
        return new Promise(function (resolve, reject) {
            if (!(url && util.isValidUrl(url))) {
                resolve(url);
                return;
            }
            var file = getFile(url);
            if (file) {
                wx.getSavedFileInfo({
                    filePath: file[KEY_PATH],
                    success: function (res) {
                        resolve(file[KEY_PATH]);
                    },
                    fail: function (error) {
                        console.error("the file is broken, redownload it, " + JSON.stringify(error));
                        downloadFile(url).then(function (path) {
                            resolve(path);
                        }, function () {
                            reject();
                        });
                    },
                });
            }
            else {
                downloadFile(url).then(function (path) {
                    resolve(path);
                }, function () {
                    reject();
                });
            }
        });
    };
    return Dowloader;
}());
exports.default = Dowloader;
function downloadFile(url) {
    return new Promise(function (resolve, reject) {
        wx.downloadFile({
            url: url,
            success: function (res) {
                if (res.statusCode !== 200) {
                    console.error("downloadFile " + url + " failed res.statusCode is not 200");
                    reject();
                    return;
                }
                var tempFilePath = res.tempFilePath;
                try {
                    wx.getFileInfo({
                        filePath: tempFilePath,
                        success: function (tmpRes) {
                            var newFileSize = tmpRes.size;
                            doLru(newFileSize).then(function () {
                                saveFile(url, newFileSize, tempFilePath).then(function (filePath) {
                                    resolve(filePath);
                                });
                            }, function () {
                                resolve(tempFilePath);
                            });
                        },
                        fail: function (error) {
                            console.error("getFileInfo " + res.tempFilePath + " failed, " + JSON.stringify(error));
                            resolve(res.tempFilePath);
                        },
                    });
                }
                catch (e) {
                    resolve(tempFilePath);
                }
            },
            fail: function (error) {
                console.error("downloadFile failed, " + JSON.stringify(error) + " ");
                reject();
            },
        });
    });
}
function saveFile(key, newFileSize, tempFilePath) {
    return new Promise(function (resolve, reject) {
        wx.saveFile({
            tempFilePath: tempFilePath,
            success: function (fileRes) {
                var totalSize = savedFiles[KEY_TOTAL_SIZE] ? savedFiles[KEY_TOTAL_SIZE] : 0;
                savedFiles[key] = {};
                savedFiles[key][KEY_PATH] = fileRes.savedFilePath;
                savedFiles[key][KEY_TIME] = new Date().getTime();
                savedFiles[key][KEY_SIZE] = newFileSize;
                savedFiles.totalSize = newFileSize + totalSize;
                wx.setStorage({
                    key: SAVED_FILES_KEY,
                    data: savedFiles,
                });
                resolve(fileRes.savedFilePath);
            },
            fail: function (error) {
                console.error("saveFile " + key + " failed, then we delete all files, " + JSON.stringify(error));
                resolve(tempFilePath);
                reset();
            },
        });
    });
}
function reset() {
    wx.removeStorage({
        key: SAVED_FILES_KEY,
        success: function () {
            wx.getSavedFileList({
                success: function (listRes) {
                    removeFiles(listRes.fileList);
                },
                fail: function (getError) {
                    console.error("getSavedFileList failed, " + JSON.stringify(getError));
                },
            });
        },
    });
}
function doLru(size) {
    return new Promise(function (resolve, reject) {
        var totalSize = savedFiles[KEY_TOTAL_SIZE] ? savedFiles[KEY_TOTAL_SIZE] : 0;
        if (size + totalSize <= MAX_SPACE_IN_B) {
            resolve();
            return;
        }
        var pathsShouldDelete = [];
        var allFiles = JSON.parse(JSON.stringify(savedFiles));
        delete allFiles[KEY_TOTAL_SIZE];
        var sortedKeys = Object.keys(allFiles).sort(function (a, b) {
            return allFiles[a][KEY_TIME] - allFiles[b][KEY_TIME];
        });
        for (var _i = 0, sortedKeys_1 = sortedKeys; _i < sortedKeys_1.length; _i++) {
            var sortedKey = sortedKeys_1[_i];
            totalSize -= savedFiles[sortedKey].size;
            pathsShouldDelete.push(savedFiles[sortedKey][KEY_PATH]);
            delete savedFiles[sortedKey];
            if (totalSize + size < MAX_SPACE_IN_B) {
                break;
            }
        }
        savedFiles.totalSize = totalSize;
        wx.setStorage({
            key: SAVED_FILES_KEY,
            data: savedFiles,
            success: function () {
                if (pathsShouldDelete.length > 0) {
                    removeFiles(pathsShouldDelete);
                }
                resolve();
            },
            fail: function (error) {
                console.error("doLru setStorage failed, " + JSON.stringify(error));
                reject();
            },
        });
    });
}
function removeFiles(pathsShouldDelete) {
    var _loop_1 = function (pathDel) {
        var delPath = pathDel;
        if (typeof pathDel === 'object') {
            delPath = pathDel.filePath;
        }
        wx.removeSavedFile({
            filePath: delPath,
            fail: function (error) {
                console.error("removeSavedFile " + pathDel + " failed, " + JSON.stringify(error));
            },
        });
    };
    for (var _i = 0, pathsShouldDelete_1 = pathsShouldDelete; _i < pathsShouldDelete_1.length; _i++) {
        var pathDel = pathsShouldDelete_1[_i];
        _loop_1(pathDel);
    }
}
function getFile(key) {
    if (!savedFiles[key]) {
        return;
    }
    savedFiles[key].time = new Date().getTime();
    wx.setStorage({
        key: SAVED_FILES_KEY,
        data: savedFiles,
    });
    return savedFiles[key];
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZG93bmxvYWRlci5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uLy4uL3NyYy94eHBhaW50L2xpYi9kb3dubG9hZGVyLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7O0FBS0EsSUFBTSxJQUFJLEdBQUcsT0FBTyxDQUFDLFFBQVEsQ0FBQyxDQUFDO0FBRS9CLElBQU0sZUFBZSxHQUFHLFlBQVksQ0FBQztBQUNyQyxJQUFNLGNBQWMsR0FBRyxXQUFXLENBQUM7QUFDbkMsSUFBTSxRQUFRLEdBQUcsTUFBTSxDQUFDO0FBQ3hCLElBQU0sUUFBUSxHQUFHLE1BQU0sQ0FBQztBQUN4QixJQUFNLFFBQVEsR0FBRyxNQUFNLENBQUM7QUFHeEIsSUFBTSxjQUFjLEdBQUcsQ0FBQyxHQUFHLElBQUksR0FBRyxJQUFJLENBQUM7QUFDdkMsSUFBSSxVQUFVLEdBQUcsRUFBRSxDQUFDO0FBRXBCO0lBQ0U7UUFLRSxFQUFFLENBQUMsVUFBVSxDQUFDO1lBQ1osR0FBRyxFQUFFLGVBQWU7WUFDcEIsT0FBTyxZQUFDLEdBQUc7Z0JBQ1QsSUFBSSxHQUFHLENBQUMsSUFBSSxFQUFFO29CQUNaLFVBQVUsR0FBRyxHQUFHLENBQUMsSUFBSSxDQUFDO2lCQUN2QjtZQUNILENBQUM7U0FDRixDQUFDLENBQUM7SUFDTCxDQUFDO0lBTUQsNEJBQVEsR0FBUixVQUFTLEdBQUc7UUFDVixPQUFPLElBQUksT0FBTyxDQUFDLFVBQUMsT0FBTyxFQUFFLE1BQU07WUFDakMsSUFBSSxDQUFDLENBQUMsR0FBRyxJQUFJLElBQUksQ0FBQyxVQUFVLENBQUMsR0FBRyxDQUFDLENBQUMsRUFBRTtnQkFDbEMsT0FBTyxDQUFDLEdBQUcsQ0FBQyxDQUFDO2dCQUNiLE9BQU87YUFDUjtZQUNELElBQU0sSUFBSSxHQUFHLE9BQU8sQ0FBQyxHQUFHLENBQUMsQ0FBQztZQUUxQixJQUFJLElBQUksRUFBRTtnQkFFUixFQUFFLENBQUMsZ0JBQWdCLENBQUM7b0JBQ2xCLFFBQVEsRUFBRSxJ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QUFDLEtBQUssQ0FBQyxxQkFBbUIsT0FBTyxpQkFBWSxJQUFJLENBQUMsU0FBUyxDQUFDLEtBQUssQ0FBRyxDQUFDLENBQUM7WUFDL0UsQ0FBQztTQUNGLENBQUMsQ0FBQzs7SUFWTCxLQUFzQixVQUFpQixFQUFqQix1Q0FBaUIsRUFBakIsK0JBQWlCLEVBQWpCLElBQWlCO1FBQWxDLElBQU0sT0FBTywwQkFBQTtnQkFBUCxPQUFPO0tBV2pCO0FBQ0gsQ0FBQztBQUVELFNBQVMsT0FBTyxDQUFDLEdBQUc7SUFDbEIsSUFBSSxDQUFDLFVBQVUsQ0FBQyxHQUFHLENBQUMsRUFBRTtRQUNwQixPQUFPO0tBQ1I7SUFDRCxVQUFVLENBQUMsR0FBRyxDQUFDLENBQUMsSUFBSSxHQUFHLElBQUksSUFBSSxFQUFFLENBQUMsT0FBTyxFQUFFLENBQUM7SUFDNUMsRUFBRSxDQUFDLFVBQVUsQ0FBQztRQUNaLEdBQUcsRUFBRSxlQUFlO1FBQ3BCLElBQUksRUFBRSxVQUFVO0tBQ2pCLENBQUMsQ0FBQztJQUNILE9BQU8sVUFBVSxDQUFDLEdBQUcsQ0FBQyxDQUFDO0FBQ3pCLENBQUMiLCJzb3VyY2VzQ29udGVudCI6WyIvKiBlc2xpbnQtZGlzYWJsZSAqL1xuLyoqXG4gKiBMUlUg5paH5Lu25a2Y5YKo77yM5L2/55So6K+lIGRvd25sb2FkZXIg5Y+v5Lul6K6p5LiL6L2955qE5paH5Lu25a2Y5YKo5Zyo5pys5Zyw77yM5LiL5qyh6L+b5YWl5bCP56iL5bqP5ZCO5Y+v5Lul55u05o6l5L2/55SoXG4gKiDor6bnu4borr7orqHmlofmoaPlj6/mn6XnnIsgaHR0cHM6Ly9qdWVqaW4uaW0vcG9zdC81YjQyZDNlZGU1MWQ0NTE5Mjc3YjZjZTNcbiAqL1xuY29uc3QgdXRpbCA9IHJlcXVpcmUoJy4vdXRpbCcpO1xuXG5jb25zdCBTQVZFRF9GSUxFU19LRVkgPSAnc2F2ZWRGaWxlcyc7XG5jb25zdCBLRVlfVE9UQUxfU0laRSA9ICd0b3RhbFNpemUnO1xuY29uc3QgS0VZX1BBVEggPSAncGF0aCc7XG5jb25zdCBLRVlfVElNRSA9ICd0aW1lJztcbmNvbnN0IEtFWV9TSVpFID0gJ3NpemUnO1xuXG4vLyDlj6/lrZjlgqjmgLvlhbHkuLogNk3vvIznm67liY3lsI/nqIvluo/lj6/lhYHorrjnmoTmnIDlpKfmnKzlnLDlrZjlgqjkuLogMTBNXG5jb25zdCBNQVhfU1BBQ0VfSU5fQiA9IDYgKiAxMDI0ICogMTAyNDtcbmxldCBzYXZlZEZpbGVzID0ge307XG5cbmV4cG9ydCBkZWZhdWx0IGNsYXNzIERvd2xvYWRlciB7XG4gIGNvbnN0cnVjdG9yKCkge1xuICAgIC8vIGFwcCDlpoLmnpzorr7nva7kuobmnIDlpKflrZjlgqjnqbrpl7TvvIzliJnkvb/nlKggYXBwIOS4reeahFxuICAgIC8vIGlmIChnZXRBcHAoKS5QQUlOVEVSX01BWF9MUlVfU1BBQ0UpIHtcbiAgICAvLyAgIE1BWF9TUEFDRV9JTl9CID0gZ2V0QXBwKCkuUEFJTlRFUl9NQVhfTFJVX1NQQUNFO1xuICAgIC8vIH1cbiAgICB3eC5nZXRTdG9yYWdlKHtcbiAgICAgIGtleTogU0FWRURfRklMRVNfS0VZLFxuICAgICAgc3VjY2VzcyhyZXMpIHtcbiAgICAgICAgaWYgKHJlcy5kYXRhKSB7XG4gICAgICAgICAgc2F2ZWRGaWxlcyA9IHJlcy5kYXRhO1xuICAgICAgICB9XG4gICAgICB9LFxuICAgIH0pO1xuICB9XG5cbiAgLyoqXG4gICAqIOS4i+i9veaWh+S7tu+8jOS8mueUqCBscnUg5pa55byP5p2l57yT5a2Y5paH5Lu25Yiw5pys5ZywXG4gICAqIEBwYXJhbSB7U3RyaW5nfSB1cmwg5paH5Lu255qEIHVybFxuICAgKi9cbiAgZG93bmxvYWQodXJsKSB7XG4gICAgcmV0dXJuIG5ldyBQcm9taXNlKChyZXNvbHZlLCByZWplY3QpID0+IHtcbiAgICAgIGlmICghKHVybCAmJiB1dGlsLmlzVmFsaWRVcmwodXJsKSkpIHtcbiAgICAgICAgcmVzb2x2ZSh1cmwpO1xuICAgICAgICByZXR1cm47XG4gICAgICB9XG4gICAgICBjb25zdCBmaWxlID0gZ2V0RmlsZSh1cmwpO1xuXG4gICAgICBpZiAoZmlsZSkge1xuICAgICAgICAvLyDmo4Dmn6Xmlofku7bmmK/lkKbmraPluLjvvIzkuI3mraPluLjpnIDopoHph43mlrDkuIvovb1cbiAgICAgICAgd3guZ2V0U2F2ZWRGaWxlSW5mbyh7XG4gICAgICAgICAgZmlsZVBhdGg6IGZpbGVbS0VZX1BBVEhdLFxuICAgICAgICAgIHN1Y2Nlc3M6IChyZXMpID0+IHtcbiAgICAgICAgICAgIHJlc29sdmUoZmlsZVtLRVlfUEFUSF0pO1xuICAgICAgICAgIH0sXG4gICAgICAgICAgZmFpbDogKGVycm9yKSA9PiB7XG4gICAgICAgICAgICBjb25zb2xlLmVycm9yKGB0aGUgZmlsZSBpcyBicm9rZW4sIHJlZG93bmxvYWQgaXQsICR7SlNPTi5zdHJpbmdpZnkoZXJyb3IpfWApO1xuICAgICAgICAgICAgZG93bmxvYWRGaWxlKHVybCkudGhlbigocGF0aCkgPT4ge1xuICAgICAgICAgICAgICByZXNvbHZlKHBhdGgpO1xuICAgICAgICAgICAgfSwgKCkgPT4ge1xuICAgICAgICAgICAgICByZWplY3QoKTtcbiAgICAgICAgICAgIH0pO1xuICAgICAgICAgIH0sXG4gICAgICAgIH0pO1xuICAgICAgfSBlbHNlIHtcbiAgICAgICAgZG93bmxvYWRGaWxlKHVybCkudGhlbigocGF0aCkgPT4ge1xuICAgICAgICAgIHJlc29sdmUocGF0aCk7XG4gICAgICAgIH0sICgpID0+IHtcbiAgICAgICAgICByZWplY3QoKTtcbiAgICAgICAgfSk7XG4gICAgICB9XG4gICAgfSk7XG4gIH1cbn1cblxuZnVuY3Rpb24gZG93bmxvYWRGaWxlKHVybCkge1xuICByZXR1cm4gbmV3IFByb21pc2UoKHJlc29sdmUsIHJlamVjdCkgPT4ge1xuICAgIHd4LmRvd25sb2FkRmlsZSh7XG4gICAgICB1cmwsXG4gICAgICBzdWNjZXNzKHJlcykge1xuICAgICAgICBpZiAocmVzLnN0YXR1c0NvZGUgIT09IDIwMCkge1xuICAgICAgICAgIGNvbnNvbGUuZXJyb3IoYGRvd25sb2FkRmlsZSAke3VybH0gZmFpbGVkIHJlcy5zdGF0dXNDb2RlIGlzIG5vdCAyMDBgKTtcbiAgICAgICAgICByZWplY3QoKTtcbiAgICAgICAgICByZXR1cm47XG4gICAgICAgIH1cbiAgICAgICAgY29uc3QgeyB0ZW1wRmlsZVBhdGggfSA9IHJlcztcbiAgICAgICAgdHJ5IHtcbiAgICAgICAgICB3eC5nZXRGaWxlSW5mbyh7XG4gICAgICAgICAgICBmaWxlUGF0aDogdGVtcEZpbGVQYXRoLFxuICAgICAgICAgICAgc3VjY2VzczogKHRtcFJlcykgPT4ge1xuICAgICAgICAgICAgICBjb25zdCBuZXdGaWxlU2l6ZSA9IHRtcFJlcy5zaXplO1xuICAgICAgICAgICAgICBkb0xydShuZXdGaWxlU2l6ZSkudGhlbigoKSA9PiB7XG4gICAgICAgICAgICAgICAgc2F2ZUZpbGUodXJsLCBuZXdGaWxlU2l6ZSwgdGVtcEZpbGVQYXRoKS50aGVuKChmaWxlUGF0aCkgPT4ge1xuICAgICAgICAgICAgICAgICAgcmVzb2x2ZShmaWxlUGF0aCk7XG4gICAgICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICAgIH0sICgpID0+IHtcbiAgICAgICAgICAgICAgICByZXNvbHZlKHRlbXBGaWxlUGF0aCk7XG4gICAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgfSxcbiAgICAgICAgICAgIGZhaWw6IChlcnJvcikgPT4ge1xuICAgICAgICAgICAgLy8g5paH5Lu25aSn5bCP5L+h5oGv6I635Y+W5aSx6LSl77yM5YiZ5q2k5paH5Lu25Lmf5LiN6KaB6L+b6KGM5a2Y5YKoXG4gICAgICAgICAgICAgIGNvbnNvbGUuZXJyb3IoYGdldEZpbGVJbmZvICR7cmVzLnRlbXBGaWxlUGF0aH0gZmFpbGVkLCAke0pTT04uc3RyaW5naWZ5KGVycm9yKX1gKTtcbiAgICAgICAgICAgICAgcmVzb2x2ZShyZXMudGVtcEZpbGVQYXRoKTtcbiAgICAgICAgICAgIH0sXG4gICAgICAgICAgfSk7XG4gICAgICAgIH0gY2F0Y2ggKGUpIHtcbiAgICAgICAgICAvLyDlhbzlrrnmj5Lku7ZcbiAgICAgICAgICByZXNvbHZlKHRlbXBGaWxlUGF0aCk7XG4gICAgICAgIH1cbiAgICAgIH0sXG4gICAgICBmYWlsKGVycm9yKSB7XG4gICAgICAgIGNvbnNvbGUuZXJyb3IoYGRvd25sb2FkRmlsZSBmYWlsZWQsICR7SlNPTi5zdHJpbmdpZnkoZXJyb3IpfSBgKTtcbiAgICAgICAgcmVqZWN0KCk7XG4gICAgICB9LFxuICAgIH0pO1xuICB9KTtcbn1cblxuZnVuY3Rpb24gc2F2ZUZpbGUoa2V5LCBuZXdGaWxlU2l6ZSwgdGVtcEZpbGVQYXRoKSB7XG4gIHJldHVybiBuZXcgUHJvbWlzZSgocmVzb2x2ZSwgcmVqZWN0KSA9PiB7XG4gICAgd3guc2F2ZUZpbGUoe1xuICAgICAgdGVtcEZpbGVQYXRoLFxuICAgICAgc3VjY2VzczogKGZpbGVSZXMpID0+IHtcbiAgICAgICAgY29uc3QgdG90YWxTaXplID0gc2F2ZWRGaWxlc1tLRVlfVE9UQUxfU0laRV0gPyBzYXZlZEZpbGVzW0tFWV9UT1RBTF9TSVpFXSA6IDA7XG4gICAgICAgIHNhdmVkRmlsZXNba2V5XSA9IHt9O1xuICAgICAgICBzYXZlZEZpbGVzW2tleV1bS0VZX1BBVEhdID0gZmlsZVJlcy5zYXZlZEZpbGVQYXRoO1xuICAgICAgICBzYXZlZEZpbGVzW2tleV1bS0VZX1RJTUVdID0gbmV3IERhdGUoKS5nZXRUaW1lKCk7XG4gICAgICAgIHNhdmVkRmlsZXNba2V5XVtLRVlfU0laRV0gPSBuZXdGaWxlU2l6ZTtcbiAgICAgICAgc2F2ZWRGaWxlcy50b3RhbFNpemUgPSBuZXdGaWxlU2l6ZSArIHRvdGFsU2l6ZTtcbiAgICAgICAgd3guc2V0U3RvcmFnZSh7XG4gICAgICAgICAga2V5OiBTQVZFRF9GSUxFU19LRVksXG4gICAgICAgICAgZGF0YTogc2F2ZWRGaWxlcyxcbiAgICAgICAgfSk7XG4gICAgICAgIHJlc29sdmUoZmlsZVJlcy5zYXZlZEZpbGVQYXRoKTtcbiAgICAgIH0sXG4gICAgICBmYWlsOiAoZXJyb3IpID0+IHtcbiAgICAgICAgY29uc29sZS5lcnJvcihgc2F2ZUZpbGUgJHtrZXl9IGZhaWxlZCwgdGhlbiB3ZSBkZWxldGUgYWxsIGZpbGVzLCAke0pTT04uc3RyaW5naWZ5KGVycm9yKX1gKTtcbiAgICAgICAgLy8g55Sx5LqOIHNhdmVGaWxlIOaIkOWKn+WQju+8jHJlcy50ZW1wRmlsZVBhdGgg5aSE55qE5paH5Lu25Lya6KKr56e76Zmk77yM5omA5Lul5Zyo5a2Y5YKo5pyq5oiQ5Yqf5pe277yM5oiR5Lus6L+Y5piv57un57ut5L2/55So5Li05pe25paH5Lu2XG4gICAgICAgIHJlc29sdmUodGVtcEZpbGVQYXRoKTtcbiAgICAgICAgLy8g5aaC5p6c5Ye6546w6ZSZ6K+v77yM5bCx55u05o6l5oOF5Ya15pys5Zyw55qE5omA5pyJ5paH5Lu277yM5Zug5Li65L2g5LiN55+l6YGT5piv5LiN5piv5Zug5Li65ZOq5qyhbHJ155qE5p+Q5Liq5paH5Lu25pyq5Yig6Zmk5oiQ5YqfXG4gICAgICAgIHJlc2V0KCk7XG4gICAgICB9LFxuICAgIH0pO1xuICB9KTtcbn1cblxuLyoqXG4gKiDmuIXnqbrmiYDmnInkuIvovb3nm7jlhbPlhoXlrrlcbiAqL1xuZnVuY3Rpb24gcmVzZXQoKSB7XG4gIHd4LnJlbW92ZVN0b3JhZ2Uoe1xuICAgIGtleTogU0FWRURfRklMRVNfS0VZLFxuICAgIHN1Y2Nlc3M6ICgpID0+IHtcbiAgICAgIHd4LmdldFNhdmVkRmlsZUxpc3Qoe1xuICAgICAgICBzdWNjZXNzOiAobGlzdFJlcykgPT4ge1xuICAgICAgICAgIHJlbW92ZUZpbGVzKGxpc3RSZXMuZmlsZUxpc3QpO1xuICAgICAgICB9LFxuICAgICAgICBmYWlsOiAoZ2V0RXJyb3IpID0+IHtcbiAgICAgICAgICBjb25zb2xlLmVycm9yKGBnZXRTYXZlZEZpbGVMaXN0IGZhaWxlZCwgJHtKU09OLnN0cmluZ2lmeShnZXRFcnJvcil9YCk7XG4gICAgICAgIH0sXG4gICAgICB9KTtcbiAgICB9LFxuICB9KTtcbn1cblxuZnVuY3Rpb24gZG9McnUoc2l6ZSkge1xuICByZXR1cm4gbmV3IFByb21pc2UoKHJlc29sdmUsIHJlamVjdCkgPT4ge1xuICAgIGxldCB0b3RhbFNpemUgPSBzYXZlZEZpbGVzW0tFWV9UT1RBTF9TSVpFXSA/IHNhdmVkRmlsZXNbS0VZX1RPVEFMX1NJWkVdIDogMDtcblxuICAgIGlmIChzaXplICsgdG90YWxTaXplIDw9IE1BWF9TUEFDRV9JTl9CKSB7XG4gICAgICByZXNvbHZlKCk7XG4gICAgICByZXR1cm47XG4gICAgfVxuICAgIC8vIOWmguaenOWKoOS4iuaWsOaWh+S7tuWQjuWkp+Wwj+i2hei/h+acgOWkp+mZkOWItu+8jOWImei/m+ihjCBscnVcbiAgICBjb25zdCBwYXRoc1Nob3VsZERlbGV0ZSA9IFtdO1xuICAgIC8vIOaMieeFp+acgOWQjuS4gOasoeeahOiuv+mXruaXtumXtO+8jOS7juWwj+WIsOWkp+aOkuW6j1xuICAgIGNvbnN0IGFsbEZpbGVzID0gSlNPTi5wYXJzZShKU09OLnN0cmluZ2lmeShzYXZlZEZpbGVzKSk7XG4gICAgZGVsZXRlIGFsbEZpbGVzW0tFWV9UT1RBTF9TSVpFXTtcbiAgICBjb25zdCBzb3J0ZWRLZXlzID0gT2JqZWN0LmtleXMoYWxsRmlsZXMpLnNvcnQoKGEsIGIpID0+IHtcbiAgICAgIHJldHVybiBhbGxGaWxlc1thXVtLRVlfVElNRV0gLSBhbGxGaWxlc1tiXVtLRVlfVElNRV07XG4gICAgfSk7XG5cbiAgICBmb3IgKGNvbnN0IHNvcnRlZEtleSBvZiBzb3J0ZWRLZXlzKSB7XG4gICAgICB0b3RhbFNpemUgLT0gc2F2ZWRGaWxlc1tzb3J0ZWRLZXldLnNpemU7XG4gICAgICBwYXRoc1Nob3VsZERlbGV0ZS5wdXNoKHNhdmVkRmlsZXNbc29ydGVkS2V5XVtLRVlfUEFUSF0pO1xuICAgICAgZGVsZXRlIHNhdmVkRmlsZXNbc29ydGVkS2V5XTtcbiAgICAgIGlmICh0b3RhbFNpemUgKyBzaXplIDwgTUFYX1NQQUNFX0lOX0IpIHtcbiAgICAgICAgYnJlYWs7XG4gICAgICB9XG4gICAgfVxuXG4gICAgc2F2ZWRGaWxlcy50b3RhbFNpemUgPSB0b3RhbFNpemU7XG4gICAgLy8gZGVidWdnZXI7XG4gICAgd3guc2V0U3RvcmFnZSh7XG4gICAgICBrZXk6IFNBVkVEX0ZJTEVTX0tFWSxcbiAgICAgIGRhdGE6IHNhdmVkRmlsZXMsXG4gICAgICBzdWNjZXNzOiAoKSA9PiB7XG4gICAgICAvLyDkv53or4Egc3RvcmFnZSDkuK3kuI3kvJrlrZjlnKjkuI3lrZjlnKjnmoTmlofku7bmlbDmja5cbiAgICAgICAgaWYgKHBhdGhzU2hvdWxkRGVsZXRlLmxlbmd0aCA+IDApIHtcbiAgICAgICAgICByZW1vdmVGaWxlcyhwYXRoc1Nob3VsZERlbGV0ZSk7XG4gICAgICAgIH1cbiAgICAgICAgcmVzb2x2ZSgpO1xuICAgICAgfSxcbiAgICAgIGZhaWw6IChlcnJvcikgPT4ge1xuICAgICAgICBjb25zb2xlLmVycm9yKGBkb0xydSBzZXRTdG9yYWdlIGZhaWxlZCwgJHtKU09OLnN0cmluZ2lmeShlcnJvcil9YCk7XG4gICAgICAgIHJlamVjdCgpO1xuICAgICAgfSxcbiAgICB9KTtcbiAgfSk7XG59XG5cbmZ1bmN0aW9uIHJlbW92ZUZpbGVzKHBhdGhzU2hvdWxkRGVsZXRlKSB7XG4gIGZvciAoY29uc3QgcGF0aERlbCBvZiBwYXRoc1Nob3VsZERlbGV0ZSkge1xuICAgIGxldCBkZWxQYXRoID0gcGF0aERlbDtcbiAgICBpZiAodHlwZW9mIHBhdGhEZWwgPT09ICdvYmplY3QnKSB7XG4gICAgICBkZWxQYXRoID0gcGF0aERlbC5maWxlUGF0aDtcbiAgICB9XG4gICAgd3gucmVtb3ZlU2F2ZWRGaWxlKHtcbiAgICAgIGZpbGVQYXRoOiBkZWxQYXRoLFxuICAgICAgZmFpbDogKGVycm9yKSA9PiB7XG4gICAgICAgIGNvbnNvbGUuZXJyb3IoYHJlbW92ZVNhdmVkRmlsZSAke3BhdGhEZWx9IGZhaWxlZCwgJHtKU09OLnN0cmluZ2lmeShlcnJvcil9YCk7XG4gICAgICB9LFxuICAgIH0pO1xuICB9XG59XG5cbmZ1bmN0aW9uIGdldEZpbGUoa2V5KSB7XG4gIGlmICghc2F2ZWRGaWxlc1trZXldKSB7XG4gICAgcmV0dXJuO1xuICB9XG4gIHNhdmVkRmlsZXNba2V5XS50aW1lID0gbmV3IERhdGUoKS5nZXRUaW1lKCk7XG4gIHd4LnNldFN0b3JhZ2Uoe1xuICAgIGtleTogU0FWRURfRklMRVNfS0VZLFxuICAgIGRhdGE6IHNhdmVkRmlsZXMsXG4gIH0pO1xuICByZXR1cm4gc2F2ZWRGaWxlc1trZXldO1xufVxuIl19