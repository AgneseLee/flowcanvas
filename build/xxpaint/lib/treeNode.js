"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
var TreeNode = (function () {
    function TreeNode(children) {
        this.children = children || [];
        this.parent = null;
        this.root = null;
        this.pre = null;
        this.next = null;
    }
    TreeNode.connectChildren = function (el) {
        if (el.hasChildren()) {
            el.children = el.children.filter(function (item) { return item instanceof TreeNode; });
            el._getChildren().map(function (child, index) {
                child._setParent(el);
                child._setSibling(el._getChildren()[index - 1], el._getChildren()[index + 1]);
                TreeNode.connectChildren(child);
            });
        }
        else {
        }
    };
    TreeNode.prototype.hasChildren = function () {
        return !!(Array.isArray(this.children) && this.children.length);
    };
    TreeNode.prototype._getChildren = function () {
        return this.hasChildren() ? this.children : [];
    };
    TreeNode.prototype._setParent = function (element) {
        this.parent = element;
        this.root = element.root;
    };
    TreeNode.prototype._setSibling = function (pre, next) {
        this.pre = pre || null;
        this.next = next || null;
    };
    TreeNode.prototype.appendChild = function (treeNode) {
        if (!treeNode instanceof TreeNode)
            throw Error('Unknown treeNode type');
        var pre = this._getChildren()[this._getChildren().length - 1];
        pre && pre._setSibling(pre.pre, treeNode);
        this.children.push(treeNode);
        treeNode._setParent(this);
        treeNode._setSibling(pre, null);
    };
    TreeNode.prototype.prependChild = function (treeNode) {
        if (!treeNode instanceof TreeNode)
            throw Error('Unknown treeNode type');
        var next = this._getChildren()[0];
        next && next._setSibling(treeNode, next.next);
        this.children.unshift(treeNode);
        treeNode._setParent(this);
        treeNode._setSibling(null, next);
    };
    TreeNode.prototype.removeChild = function (treeNode) {
        if (!treeNode instanceof TreeNode)
            throw Error('Unknown treeNode type');
        var index = this._getChildren().indexOf(treeNode);
        if (index < 0)
            throw Error('treeNode must be the child of parent');
        var pre = this._getChildren()[index - 1];
        var next = this._getChildren()[index + 1];
        if (pre) {
            pre._setSibling(pre.pre, next);
        }
        if (next) {
            next._setSibling(pre, next.next);
        }
        this.children.splice(index, 1);
    };
    TreeNode.prototype.remove = function () {
        if (!this.parent) {
            throw Error('Can not remove root node');
        }
        this.parent.removeChild(this);
    };
    TreeNode.prototype.append = function (treeNode) {
        var _this = this;
        if (!treeNode instanceof TreeNode)
            throw Error('Unknown treeNode type');
        if (!this.parent)
            throw Error('Can not add treeNode to root level!');
        var children = [];
        treeNode._setParent(this.parent);
        this.parent.children.forEach(function (child, index) {
            children.push(child);
            if (child === _this) {
                treeNode._setSibling(child, _this.parent.children[index + 1]);
                children.push(treeNode);
            }
        });
        this.parent.children = children;
    };
    TreeNode.prototype.prepend = function (treeNode) {
        if (!treeNode instanceof TreeNode)
            throw Error('Unknown treeNode type');
        if (!this.parent)
            throw Error('Can not add treeNode to root level!');
        var children = [];
        treeNode._setParent(this.parent);
        for (var i = this.parent.children.length - 1; i >= 0; i--) {
            children.unshift(this.parent.children[i]);
            if (this.parent.children[i] === this) {
                treeNode._setSibling(this.parent.children[i - 1], this.parent.children[i]);
                children.unshift(treeNode);
            }
        }
        this.parent.children = children;
    };
    return TreeNode;
}());
exports.default = TreeNode;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoidHJlZU5vZGUuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi9zcmMveHhwYWludC9saWIvdHJlZU5vZGUudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7QUFDQTtJQWlCRSxrQkFBWSxRQUFRO1FBQ2xCLElBQUksQ0FBQyxRQUFRLEdBQUcsUUFBUSxJQUFJLEVBQUUsQ0FBQztRQUMvQixJQUFJLENBQUMsTUFBTSxHQUFHLElBQUksQ0FBQztRQUNuQixJQUFJLENBQUMsSUFBSSxHQUFHLElBQUksQ0FBQztRQUNqQixJQUFJLENBQUMsR0FBRyxHQUFHLElBQUksQ0FBQztRQUNoQixJQUFJLENBQUMsSUFBSSxHQUFHLElBQUksQ0FBQztJQUNuQixDQUFDO0lBdEJNLHdCQUFlLEdBQXRCLFVBQXVCLEVBQUU7UUFDdkIsSUFBSSxFQUFFLENBQUMsV0FBVyxFQUFFLEVBQUU7WUFDcEIsRUFBRSxDQUFDLFFBQVEsR0FBRyxFQUFFLENBQUMsUUFBUSxDQUFDLE1BQU0sQ0FBQyxVQUFDLElBQUksSUFBTyxPQUFPLElBQUksWUFBWSxRQUFRLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQztZQUVqRixFQUFFLENBQUMsWUFBWSxFQUFFLENBQUMsR0FBRyxDQUFDLFVBQUMsS0FBSyxFQUFFLEtBQUs7Z0JBR2pDLEtBQUssQ0FBQyxVQUFVLENBQUMsRUFBRSxDQUFDLENBQUM7Z0JBRXJCLEtBQUssQ0FBQyxXQUFXLENBQUMsRUFBRSxDQUFDLFlBQVksRUFBRSxDQUFDLEtBQUssR0FBRyxDQUFDLENBQUMsRUFBRSxFQUFFLENBQUMsWUFBWSxFQUFFLENBQUMsS0FBSyxHQUFHLENBQUMsQ0FBQyxDQUFDLENBQUM7Z0JBQzlFLFFBQVEsQ0FBQyxlQUFlLENBQUMsS0FBSyxDQUFDLENBQUM7WUFDbEMsQ0FBQyxDQUFDLENBQUM7U0FDSjthQUFNO1NBQ047SUFDSCxDQUFDO0lBVUQsOEJBQVcsR0FBWDtRQUNFLE9BQU8sQ0FBQyxDQUFDLENBQUMsS0FBSyxD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QUFLLENBQUMsdUJBQXVCLENBQUMsQ0FBQztRQUN4RSxJQUFJLENBQUMsSUFBSSxDQUFDLE1BQU07WUFBRSxNQUFNLEtBQUssQ0FBQyxxQ0FBcUMsQ0FBQyxDQUFDO1FBQ3JFLElBQU0sUUFBUSxHQUFHLEVBQUUsQ0FBQztRQUNwQixRQUFRLENBQUMsVUFBVSxDQUFDLElBQUksQ0FBQyxNQUFNLENBQUMsQ0FBQztRQUNqQyxLQUFLLElBQUksQ0FBQyxHQUFHLElBQUksQ0FBQyxNQUFNLENBQUMsUUFBUSxDQUFDLE1BQU0sR0FBRyxDQUFDLEVBQUUsQ0FBQyxJQUFJLENBQUMsRUFBRSxDQUFDLEVBQUUsRUFBRTtZQUN6RCxRQUFRLENBQUMsT0FBTyxDQUFDLElBQUksQ0FBQyxNQUFNLENBQUMsUUFBUSxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUM7WUFDMUMsSUFBSSxJQUFJLENBQUMsTUFBTSxDQUFDLFFBQVEsQ0FBQyxDQUFDLENBQUMsS0FBSyxJQUFJLEVBQUU7Z0JBQ3BDLFFBQVEsQ0FBQyxXQUFXLENBQUMsSUFBSSxDQUFDLE1BQU0sQ0FBQyxRQUFRLENBQUMsQ0FBQyxHQUFHLENBQUMsQ0FBQyxFQUFFLElBQUksQ0FBQyxNQUFNLENBQUMsUUFBUSxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUM7Z0JBQzNFLFFBQVEsQ0FBQyxPQUFPLENBQUMsUUFBUSxDQUFDLENBQUM7YUFDNUI7U0FDRjtRQUNELElBQUksQ0FBQyxNQUFNLENBQUMsUUFBUSxHQUFHLFFBQVEsQ0FBQztJQUNsQyxDQUFDO0lBQ0gsZUFBQztBQUFELENBQUMsQUFwSEQsSUFvSEMiLCJzb3VyY2VzQ29udGVudCI6WyIvKiBlc2xpbnQtZGlzYWJsZSAqL1xuZXhwb3J0IGRlZmF1bHQgY2xhc3MgVHJlZU5vZGUge1xuICBzdGF0aWMgY29ubmVjdENoaWxkcmVuKGVsKSB7XG4gICAgaWYgKGVsLmhhc0NoaWxkcmVuKCkpIHtcbiAgICAgIGVsLmNoaWxkcmVuID0gZWwuY2hpbGRyZW4uZmlsdGVyKChpdGVtKSA9PiB7IHJldHVybiBpdGVtIGluc3RhbmNlb2YgVHJlZU5vZGU7IH0pO1xuICAgICAgLy8gZGVidWdnZXJcbiAgICAgIGVsLl9nZXRDaGlsZHJlbigpLm1hcCgoY2hpbGQsIGluZGV4KSA9PiB7XG4gICAgICAgIC8vIGRlYnVnZ2VyXG4gICAgICAgIC8vIOiuvue9rnBhcmVudFxuICAgICAgICBjaGlsZC5fc2V0UGFyZW50KGVsKTtcbiAgICAgICAgLy8g6K6+572u5LqG5LiK5LiA5Liq5YWE5byf6IqC54K5XG4gICAgICAgIGNoaWxkLl9zZXRTaWJsaW5nKGVsLl9nZXRDaGlsZHJlbigpW2luZGV4IC0gMV0sIGVsLl9nZXRDaGlsZHJlbigpW2luZGV4ICsgMV0pO1xuICAgICAgICBUcmVlTm9kZS5jb25uZWN0Q2hpbGRyZW4oY2hpbGQpO1xuICAgICAgfSk7XG4gICAgfSBlbHNlIHtcbiAgICB9XG4gIH1cblxuICBjb25zdHJ1Y3RvcihjaGlsZHJlbikge1xuICAgIHRoaXMuY2hpbGRyZW4gPSBjaGlsZHJlbiB8fCBbXTtcbiAgICB0aGlzLnBhcmVudCA9IG51bGw7XG4gICAgdGhpcy5yb290ID0gbnVsbDtcbiAgICB0aGlzLnByZSA9IG51bGw7XG4gICAgdGhpcy5uZXh0ID0gbnVsbDtcbiAgfVxuXG4gIGhhc0NoaWxkcmVuKCkge1xuICAgIHJldHVybiAhIShBcnJheS5pc0FycmF5KHRoaXMuY2hpbGRyZW4pICYmIHRoaXMuY2hpbGRyZW4ubGVuZ3RoKTtcbiAgfVxuXG4gIF9nZXRDaGlsZHJlbigpIHtcbiAgICByZXR1cm4gdGhpcy5oYXNDaGlsZHJlbigpID8gdGhpcy5jaGlsZHJlbiA6IFtdO1xuICB9XG5cbiAgX3NldFBhcmVudChlbGVtZW50KSB7XG4gICAgdGhpcy5wYXJlbnQgPSBlbGVtZW50O1xuICAgIHRoaXMucm9vdCA9IGVsZW1lbnQucm9vdDtcbiAgfVxuXG4gIF9zZXRTaWJsaW5nKHByZSwgbmV4dCkge1xuICAgIHRoaXMucHJlID0gcHJlIHx8IG51bGw7XG4gICAgdGhpcy5uZXh0ID0gbmV4dCB8fCBudWxsO1xuICB9XG5cbiAgLy8g5re75Yqg5Zyo5pyA5ZCOXG4gIGFwcGVuZENoaWxkKHRyZWVOb2RlKSB7XG4gICAgaWYgKCF0cmVlTm9kZSBpbnN0YW5jZW9mIFRyZWVOb2RlKSB0aHJvdyBFcnJvcignVW5rbm93biB0cmVlTm9kZSB0eXBlJyk7XG4gICAgY29uc3QgcHJlID0gdGhpcy5fZ2V0Q2hpbGRyZW4oKVt0aGlzLl9nZXRDaGlsZHJlbigpLmxlbmd0aCAtIDFdO1xuICAgIHByZSAmJiBwcmUuX3NldFNpYmxpbmcocHJlLnByZSwgdHJlZU5vZGUpO1xuICAgIHRoaXMuY2hpbGRyZW4ucHVzaCh0cmVlTm9kZSk7XG4gICAgdHJlZU5vZGUuX3NldFBhcmVudCh0aGlzKTtcbiAgICB0cmVlTm9kZS5fc2V0U2libGluZyhwcmUsIG51bGwpO1xuICAgIC8vIHJldHVybiB0cmVlTm9kZVxuICB9XG5cbiAgLy9cbiAgcHJlcGVuZENoaWxkKHRyZWVOb2RlKSB7XG4gICAgaWYgKCF0cmVlTm9kZSBpbnN0YW5jZW9mIFRyZWVOb2RlKSB0aHJvdyBFcnJvcignVW5rbm93biB0cmVlTm9kZSB0eXBlJyk7XG4gICAgY29uc3QgbmV4dCA9IHRoaXMuX2dldENoaWxkcmVuKClbMF07XG4gICAgbmV4dCAmJiBuZXh0Ll9zZXRTaWJsaW5nKHRyZWVOb2RlLCBuZXh0Lm5leHQpO1xuICAgIHRoaXMuY2hpbGRyZW4udW5zaGlmdCh0cmVlTm9kZSk7XG4gICAgdHJlZU5vZGUuX3NldFBhcmVudCh0aGlzKTtcbiAgICB0cmVlTm9kZS5fc2V0U2libGluZyhudWxsLCBuZXh0KTtcbiAgICAvLyByZXR1cm4gdHJlZU5vZGVcbiAgfVxuXG4gIHJlbW92ZUNoaWxkKHRyZWVOb2RlKSB7XG4gICAgaWYgKCF0cmVlTm9kZSBpbnN0YW5jZW9mIFRyZWVOb2RlKSB0aHJvdyBFcnJvcignVW5rbm93biB0cmVlTm9kZSB0eXBlJyk7XG4gICAgY29uc3QgaW5kZXggPSB0aGlzLl9nZXRDaGlsZHJlbigpLmluZGV4T2YodHJlZU5vZGUpO1xuICAgIGlmIChpbmRleCA8IDApIHRocm93IEVycm9yKCd0cmVlTm9kZSBtdXN0IGJlIHRoZSBjaGlsZCBvZiBwYXJlbnQnKTtcbiAgICBjb25zdCBwcmUgPSB0aGlzLl9nZXRDaGlsZHJlbigpW2luZGV4IC0gMV07XG4gICAgY29uc3QgbmV4dCA9IHRoaXMuX2dldENoaWxkcmVuKClbaW5kZXggKyAxXTtcbiAgICBpZiAocHJlKSB7XG4gICAgICBwcmUuX3NldFNpYmxpbmcocHJlLnByZSwgbmV4dCk7XG4gICAgfVxuICAgIGlmIChuZXh0KSB7XG4gICAgICBuZXh0Ll9zZXRTaWJsaW5nKHByZSwgbmV4dC5uZXh0KTtcbiAgICB9XG4gICAgdGhpcy5jaGlsZHJlbi5zcGxpY2UoaW5kZXgsIDEpO1xuICB9XG5cbiAgcmVtb3ZlKCkge1xuICAgIGlmICghdGhpcy5wYXJlbnQpIHtcbiAgICAgIHRocm93IEVycm9yKCdDYW4gbm90IHJlbW92ZSByb290IG5vZGUnKTtcbiAgICB9XG4gICAgdGhpcy5wYXJlbnQucmVtb3ZlQ2hpbGQodGhpcyk7XG4gIH1cblxuICBhcHBlbmQodHJlZU5vZGUpIHtcbiAgICBpZiAoIXRyZWVOb2RlIGluc3RhbmNlb2YgVHJlZU5vZGUpIHRocm93IEVycm9yKCdVbmtub3duIHRyZWVOb2RlIHR5cGUnKTtcbiAgICBpZiAoIXRoaXMucGFyZW50KSB0aHJvdyBFcnJvcignQ2FuIG5vdCBhZGQgdHJlZU5vZGUgdG8gcm9vdCBsZXZlbCEnKTtcbiAgICBjb25zdCBjaGlsZHJlbiA9IFtdO1xuICAgIHRyZWVOb2RlLl9zZXRQYXJlbnQodGhpcy5wYXJlbnQpO1xuICAgIHRoaXMucGFyZW50LmNoaWxkcmVuLmZvckVhY2goKGNoaWxkLCBpbmRleCkgPT4ge1xuICAgICAgY2hpbGRyZW4ucHVzaChjaGlsZCk7XG4gICAgICBpZiAoY2hpbGQgPT09IHRoaXMpIHtcbiAgICAgICAgdHJlZU5vZGUuX3NldFNpYmxpbmcoY2hpbGQsIHRoaXMucGFyZW50LmNoaWxkcmVuW2luZGV4ICsgMV0pO1xuICAgICAgICBjaGlsZHJlbi5wdXNoKHRyZWVOb2RlKTtcbiAgICAgIH1cbiAgICB9KTtcbiAgICB0aGlzLnBhcmVudC5jaGlsZHJlbiA9IGNoaWxkcmVuO1xuICB9XG5cbiAgcHJlcGVuZCh0cmVlTm9kZSkge1xuICAgIGlmICghdHJlZU5vZGUgaW5zdGFuY2VvZiBUcmVlTm9kZSkgdGhyb3cgRXJyb3IoJ1Vua25vd24gdHJlZU5vZGUgdHlwZScpO1xuICAgIGlmICghdGhpcy5wYXJlbnQpIHRocm93IEVycm9yKCdDYW4gbm90IGFkZCB0cmVlTm9kZSB0byByb290IGxldmVsIScpO1xuICAgIGNvbnN0IGNoaWxkcmVuID0gW107XG4gICAgdHJlZU5vZGUuX3NldFBhcmVudCh0aGlzLnBhcmVudCk7XG4gICAgZm9yIChsZXQgaSA9IHRoaXMucGFyZW50LmNoaWxkcmVuLmxlbmd0aCAtIDE7IGkgPj0gMDsgaS0tKSB7XG4gICAgICBjaGlsZHJlbi51bnNoaWZ0KHRoaXMucGFyZW50LmNoaWxkcmVuW2ldKTtcbiAgICAgIGlmICh0aGlzLnBhcmVudC5jaGlsZHJlbltpXSA9PT0gdGhpcykge1xuICAgICAgICB0cmVlTm9kZS5fc2V0U2libGluZyh0aGlzLnBhcmVudC5jaGlsZHJlbltpIC0gMV0sIHRoaXMucGFyZW50LmNoaWxkcmVuW2ldKTtcbiAgICAgICAgY2hpbGRyZW4udW5zaGlmdCh0cmVlTm9kZSk7XG4gICAgICB9XG4gICAgfVxuICAgIHRoaXMucGFyZW50LmNoaWxkcmVuID0gY2hpbGRyZW47XG4gIH1cbn1cbiJdfQ==